#!/usr/bin/env bash
# === METADATA ===
# NAME: pre-push
# TYPE: git-hook
# PLUGIN: git
# DESCRIPTION: Code quality validation (pytest + ruff + mypy) and force-push protection
# CONFIGURABLE: none
# ================

set -e

# Read ref info and block force push to protected branches
while read local_ref local_oid remote_ref remote_oid; do
    if [[ "$remote_ref" =~ refs/heads/(main|master) ]]; then
        if [[ "$remote_oid" != "0000000000000000000000000000000000000000" ]] && \
           [[ "$local_oid" != "0000000000000000000000000000000000000000" ]] && \
           ! git merge-base --is-ancestor "$remote_oid" "$local_oid" 2>/dev/null; then
            echo "‚ùå ERROR: Force push to main/master is blocked"
            exit 1
        fi
    fi
done

# Code quality validation
echo "üîí Validating push..."

if command -v pytest &> /dev/null; then
    echo "  ‚Üí Running tests..."
    pytest -x || { echo "‚ùå Tests failed"; exit 1; }
fi

if command -v ruff &> /dev/null; then
    echo "  ‚Üí Checking lint..."
    ruff check . || { echo "‚ùå Lint failed"; exit 1; }
fi

if command -v mypy &> /dev/null; then
    echo "  ‚Üí Type checking..."
    mypy . || { echo "‚ùå Type check failed"; exit 1; }
fi

echo "‚úÖ All checks passed"

# Project-specific hook
[ -x .git/hooks/pre-push.local ] && .git/hooks/pre-push.local

exit 0
