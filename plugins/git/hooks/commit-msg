#!/bin/bash
# === METADATA ===
# NAME: commit-msg
# TYPE: git-hook
# PLUGIN: git
# DESCRIPTION: Validates commit messages ‚Äî AI attribution blocking and conventional commit enforcement
# CONFIGURABLE: GIT_HOOK_BLOCK_AI_ATTRIBUTION, GIT_HOOK_WIP_BLOCK_ON_MAIN, GIT_HOOK_CONVENTIONAL_COMMITS, GIT_HOOK_CONVENTIONAL_COMMITS_STRICT, GIT_HOOK_MAX_SUBJECT_LENGTH, GIT_HOOK_COMMIT_MSG_ENABLED
# ================

# ============================================================================
# COMMIT-MSG HOOK
# ============================================================================
# Validates commit messages: AI attribution blocking + conventional commits
# Config-driven via project config.
#
# Source of truth: plugins/git/hooks/commit-msg
# Deployed to: .git/hooks/commit-msg (via project deploy)
# ============================================================================

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
SUBJECT_LINE=$(echo "$COMMIT_MSG" | head -1)
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || echo ".")"
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")

# --- Load configuration with hierarchy ---
# Priority: config file > env var > hardcoded default
# Try multiple config file locations (first found wins)
HOOK_CONFIG=""
for config_path in \
    "$REPO_ROOT/.githooks/config" \
    "$REPO_ROOT/.claude/git-hooks.conf" \
    "$REPO_ROOT/.git/hooks/hooks.conf" \
    "$REPO_ROOT/.claude/hooks.conf"; do
    if [[ -f "$config_path" ]]; then
        HOOK_CONFIG="$config_path"
        break
    fi
done

# Set defaults
GIT_HOOK_COMMIT_MSG_ENABLED="${GIT_HOOK_COMMIT_MSG_ENABLED:-true}"
GIT_HOOK_BLOCK_AI_ATTRIBUTION="${GIT_HOOK_BLOCK_AI_ATTRIBUTION:-true}"
GIT_HOOK_WIP_BLOCK_ON_MAIN="${GIT_HOOK_WIP_BLOCK_ON_MAIN:-true}"
GIT_HOOK_CONVENTIONAL_COMMITS="${GIT_HOOK_CONVENTIONAL_COMMITS:-true}"
GIT_HOOK_CONVENTIONAL_COMMITS_STRICT="${GIT_HOOK_CONVENTIONAL_COMMITS_STRICT:-false}"
GIT_HOOK_MAX_SUBJECT_LENGTH="${GIT_HOOK_MAX_SUBJECT_LENGTH:-72}"

# Load config file if found (overrides env vars and defaults)
if [[ -n "$HOOK_CONFIG" ]]; then
    source "$HOOK_CONFIG"
fi

# Check if hook is enabled
if [[ "$GIT_HOOK_COMMIT_MSG_ENABLED" != "true" ]]; then
    exit 0
fi

# ============================================================================
# SECTION 1: AI Attribution Blocking (configurable, strong default ON)
# ============================================================================

if [[ "$GIT_HOOK_BLOCK_AI_ATTRIBUTION" == "true" ]]; then
    AI_PATTERNS=(
        "Co-Authored-By:.*Claude"
        "Co-Authored-By:.*GPT"
        "Co-Authored-By:.*AI"
        "Generated by Claude"
        "Generated by GPT"
        "Generated with Claude"
        "Generated with GPT"
        "ü§ñ.*Generated"
        "Written by AI"
        "AI-assisted"
        "Claude Code"
    )

    for pattern in "${AI_PATTERNS[@]}"; do
        if echo "$COMMIT_MSG" | grep -qiE "$pattern"; then
            echo "‚ùå ERROR: Commit message contains AI attribution"
            echo "Pattern matched: $pattern"
            echo ""
            echo "Remove lines like:"
            echo "  - Co-Authored-By: ..."
            echo "  - Generated by: ..."
            echo "  - AI-assisted"
            echo ""
            echo "Take ownership of all committed code."
            echo ""
            echo "To disable: Set GIT_HOOK_BLOCK_AI_ATTRIBUTION=false in .claude/git-hooks.conf"
            exit 1
        fi
    done
fi

# ============================================================================
# SECTION 2: Conventional Commit Validation (config-driven)
# ============================================================================

# Skip validation during merge commits (MERGE_HEAD exists)
if [[ -f "$REPO_ROOT/.git/MERGE_HEAD" ]]; then
    exit 0
fi

# Skip validation during squash merge (user crafts message manually)
IS_SQUASH_MERGE=false
if [[ -f "$REPO_ROOT/.git/SQUASH_MSG" ]] || [[ -n "$GIT_MERGE_SQUASH" ]]; then
    IS_SQUASH_MERGE=true
fi

# Only validate on main branch when GIT_HOOK_CONVENTIONAL_COMMITS=true
if [[ "$GIT_HOOK_CONVENTIONAL_COMMITS" == "true" ]] && [[ "$CURRENT_BRANCH" == "main" ]]; then
    # WIP blocking (configurable)
    if [[ "$GIT_HOOK_WIP_BLOCK_ON_MAIN" == "true" ]] && [[ "$IS_SQUASH_MERGE" == "false" ]]; then
        # Not a squash merge: enforce WIP blocking
        if echo "$SUBJECT_LINE" | grep -qiE '^wip'; then
            echo "‚ùå ERROR: 'wip' commits not allowed on main branch"
            echo ""
            echo "Main branch requires:"
            echo "  - Conventional commits: feat:, fix:, docs:, refactor:, test:"
            echo "  - OR plain descriptive messages"
            echo ""
            echo "Use feature branches for WIP commits."
            echo ""
            echo "To disable: Set GIT_HOOK_WIP_BLOCK_ON_MAIN=false in .claude/git-hooks.conf"
            exit 1
        fi
    fi

    # Check conventional commit format using research-based regex
    if ! echo "$SUBJECT_LINE" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|build|ci|perf|revert)(\([a-zA-Z0-9_.-]+\))?(!)?:\s.+$'; then
        # Not conventional format
        if [[ "$GIT_HOOK_CONVENTIONAL_COMMITS_STRICT" == "true" ]]; then
            # Strict mode: block non-conventional commits
            echo "‚ùå ERROR: Commit does not follow conventional format"
            echo ""
            echo "Required format: type(scope): description"
            echo "Types: feat, fix, docs, refactor, test, chore, style, perf, build, ci, revert"
            echo "Example: feat(auth): add JWT token refresh"
            echo ""
            echo "To allow plain messages: Set GIT_HOOK_CONVENTIONAL_COMMITS_STRICT=false"
            exit 1
        else
            # Soft mode: warn only
            echo "‚ö†Ô∏è  NOTE: Main branch prefers conventional commits"
            echo "Format: type(scope): description"
            echo "Types: feat, fix, docs, refactor, test, chore, style, perf, build, ci, revert"
        fi
    fi

    # Subject length check (configurable threshold)
    if [[ ${#SUBJECT_LINE} -gt $GIT_HOOK_MAX_SUBJECT_LENGTH ]]; then
        echo "‚ö†Ô∏è  WARNING: Subject line exceeds $GIT_HOOK_MAX_SUBJECT_LENGTH characters (${#SUBJECT_LINE})"
        echo "Consider shortening: $SUBJECT_LINE"
    fi
fi

# On branches: allow anything (WIP, notes, experiments)

exit 0
