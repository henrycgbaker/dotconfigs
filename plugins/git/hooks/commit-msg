#!/bin/bash
# ============================================================================
# COMMIT-MSG HOOK
# ============================================================================
# Validates commit messages: AI attribution blocking + conventional commits
# Deployed globally via core.hooksPath. Config-driven via .claude/hooks.conf.
#
# Source of truth: plugins/git/hooks/commit-msg
# Deployed to: ~/.claude/git-hooks/commit-msg
# ============================================================================

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
SUBJECT_LINE=$(echo "$COMMIT_MSG" | head -1)
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || echo ".")"
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")

# --- Load project config ---
HOOK_CONFIG="$REPO_ROOT/.claude/hooks.conf"

# Defaults
CONVENTIONAL_COMMITS=true
BLOCK_AI_ATTRIBUTION=true  # Cannot be disabled

if [ -f "$HOOK_CONFIG" ]; then
    source "$HOOK_CONFIG"
    # Force AI attribution blocking regardless of config
    BLOCK_AI_ATTRIBUTION=true
fi

# ============================================================================
# SECTION 1: AI Attribution Blocking (always enforced)
# ============================================================================

AI_PATTERNS=(
    "Co-Authored-By:.*Claude"
    "Co-Authored-By:.*GPT"
    "Co-Authored-By:.*AI"
    "Generated by Claude"
    "Generated by GPT"
    "Generated with Claude"
    "Generated with GPT"
    "ü§ñ.*Generated"
    "Written by AI"
    "AI-assisted"
    "Claude Code"
)

for pattern in "${AI_PATTERNS[@]}"; do
    if echo "$COMMIT_MSG" | grep -qiE "$pattern"; then
        echo "‚ùå ERROR: Commit message contains AI attribution"
        echo "Pattern matched: $pattern"
        echo ""
        echo "Remove lines like:"
        echo "  - Co-Authored-By: ..."
        echo "  - Generated by: ..."
        echo "  - AI-assisted"
        echo ""
        echo "Take ownership of all committed code."
        exit 1
    fi
done

# ============================================================================
# SECTION 2: Conventional Commit Validation (config-driven)
# ============================================================================

# Skip validation during merge commits (MERGE_HEAD exists)
if [ -f "$REPO_ROOT/.git/MERGE_HEAD" ]; then
    exit 0
fi

# Skip validation during squash merge (user crafts message manually)
IS_SQUASH_MERGE=false
if [ -f "$REPO_ROOT/.git/SQUASH_MSG" ] || [ -n "$GIT_MERGE_SQUASH" ]; then
    IS_SQUASH_MERGE=true
fi

# Only validate on main branch when CONVENTIONAL_COMMITS=true
if [ "$CONVENTIONAL_COMMITS" = true ] && [ "$CURRENT_BRANCH" = "main" ]; then
    # During squash merge, still validate conventional format but relax WIP blocking
    if [ "$IS_SQUASH_MERGE" = false ]; then
        # Not a squash merge: strict WIP blocking
        if echo "$SUBJECT_LINE" | grep -qiE '^wip'; then
            echo "‚ùå ERROR: 'wip' commits not allowed on main branch"
            echo ""
            echo "Main branch requires:"
            echo "  - Conventional commits: feat:, fix:, docs:, refactor:, test:"
            echo "  - OR plain descriptive messages"
            echo ""
            echo "Use feature branches for WIP commits."
            exit 1
        fi
    fi

    # Check conventional commit format using research-based regex
    if ! echo "$SUBJECT_LINE" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|build|ci|perf|revert)(\([a-zA-Z0-9_.-]+\))?(!)?:\s.+$'; then
        # Not conventional format - warn but don't block (allow plain descriptive)
        echo "‚ö†Ô∏è  NOTE: Main branch prefers conventional commits"
        echo "Format: type(scope): description"
        echo "Types: feat, fix, docs, refactor, test, chore, style, perf, build, ci, revert"
    fi

    # Warn if subject line exceeds 72 chars
    if [ ${#SUBJECT_LINE} -gt 72 ]; then
        echo "‚ö†Ô∏è  WARNING: Subject line exceeds 72 characters (${#SUBJECT_LINE})"
        echo "Consider shortening: $SUBJECT_LINE"
    fi
fi

# On branches: allow anything (WIP, notes, experiments)

exit 0
