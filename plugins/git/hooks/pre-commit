#!/usr/bin/env bash
# === METADATA ===
# NAME: pre-commit
# TYPE: git-hook
# PLUGIN: git
# DESCRIPTION: Branch-aware pre-commit — identity check, secrets scan, main-branch warning, Ruff format on main
# CONFIGURABLE: none
# ================

set -e

BRANCH=$(git rev-parse --abbrev-ref HEAD)

# ALWAYS: Identity check (~10ms)
EXPECTED_NAME="henrycgbaker"
EXPECTED_EMAIL="henry.c.g.baker@gmail.com"
ACTUAL_NAME=$(git config user.name)
ACTUAL_EMAIL=$(git config user.email)

if [ "$ACTUAL_NAME" != "$EXPECTED_NAME" ] || [ "$ACTUAL_EMAIL" != "$EXPECTED_EMAIL" ]; then
    echo "❌ ERROR: Git identity mismatch"
    echo "Expected: $EXPECTED_NAME <$EXPECTED_EMAIL>"
    echo "Actual: $ACTUAL_NAME <$ACTUAL_EMAIL>"
    exit 1
fi

# ALWAYS: Warn on direct main commits
if [[ "$BRANCH" == "main" ]] || [[ "$BRANCH" == "master" ]]; then
    echo "⚠️  WARNING: Committing directly to $BRANCH"
fi

# ALWAYS: Secrets scan (gitleaks if available, inline regex fallback)
if command -v gitleaks &> /dev/null; then
    gitleaks protect --staged --no-banner -v 2>/dev/null || {
        echo "❌ ERROR: gitleaks detected secrets in staged changes"
        exit 1
    }
else
    STAGED_CONTENT=$(git diff --cached --diff-filter=ACM -U0 2>/dev/null | sed -n '/^+[^+]/p' || true)
    if [ -n "$STAGED_CONTENT" ]; then
        for pattern in 'AKIA[0-9A-Z]{16}' '(sk|pk)_(test|live)_[a-zA-Z0-9]{24,}' 'AIza[0-9A-Za-z_-]{35}'; do
            if echo "$STAGED_CONTENT" | grep -qE -- "$pattern"; then
                echo "❌ ERROR: Possible secret detected in staged changes"
                echo "Pattern: $pattern"
                exit 1
            fi
        done
        _pk="-----""BEGIN"
        if echo "$STAGED_CONTENT" | grep -q -- "$_pk"; then
            echo "❌ ERROR: Possible private key detected in staged changes"
            exit 1
        fi
    fi
fi

# MAIN ONLY: Ruff format + check
if [[ "$BRANCH" == "main" ]] || [[ "$BRANCH" == "master" ]]; then
    STAGED_PY=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)
    if [ -n "$STAGED_PY" ] && command -v ruff &> /dev/null; then
        for file in $STAGED_PY; do
            if [ -f "$file" ]; then
                ruff format "$file"
                ruff check --fix "$file" || true
                git add "$file"
            fi
        done
    fi
fi

# Project-specific hook
[ -x .git/hooks/pre-commit.local ] && .git/hooks/pre-commit.local

exit 0
