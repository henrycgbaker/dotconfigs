---
phase: 05-claude-plugin-extraction
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - plugins/claude/deploy.sh
autonomous: true

must_haves:
  truths:
    - "dotconfigs deploy claude deploys CLAUDE.md, settings.json, hooks, skills"
    - "Deployment reads CLAUDE_* keys from .env — identical result to current deploy"
    - "GSD framework coexistence maintained via file-level symlinks"
    - "Deploy creates target directory if it doesn't exist"
    - "Conflict handling works (backup/overwrite/skip for non-owned files)"
  artifacts:
    - path: "plugins/claude/deploy.sh"
      provides: "Full deployment logic"
      min_lines: 120
      exports: ["plugin_claude_deploy"]
  key_links:
    - from: "plugins/claude/deploy.sh"
      to: "lib/symlinks.sh"
      via: "backup_and_link for file deployment"
      pattern: "backup_and_link"
    - from: "plugins/claude/deploy.sh"
      to: "lib/discovery.sh"
      via: "discover functions for asset enumeration"
      pattern: "discover_(claude_sections|hooks|skills)"
    - from: "plugins/claude/deploy.sh"
      to: ".env"
      via: "source .env to read CLAUDE_* config"
      pattern: "source.*ENV_FILE"
---

<objective>
Replace the stub plugins/claude/deploy.sh with the full deployment logic extracted from deploy.sh deploy_global() + build_claude_md() + helpers. Reads CLAUDE_* keys from .env and deploys to filesystem.

Purpose: CLPL-02 (deploy code migrated), CLI-03 (deploy command works), COMP-03 (GSD coexistence). The deploy side of the setup/deploy separation.

Output: Working `dotconfigs deploy claude` that reads .env and deploys all Claude Code configuration files.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-claude-plugin-extraction/05-CONTEXT.md
@.planning/phases/05-claude-plugin-extraction/05-RESEARCH.md
@.planning/phases/05-claude-plugin-extraction/05-01-SUMMARY.md
@deploy.sh
@lib/symlinks.sh
@lib/discovery.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement plugin_claude_deploy with CLAUDE_* key reading</name>
  <files>plugins/claude/deploy.sh</files>
  <action>
    Replace the stub in plugins/claude/deploy.sh with the full deployment logic extracted from deploy.sh lines 48-536. This is surgical extraction — preserve the deployment behaviour exactly, adapted for plugin paths and CLAUDE_* keys.

    **Structure:**

    ```
    # plugins/claude/deploy.sh — Claude Code configuration deployment
    # Sourced by dotconfigs entry point. Do not execute directly.

    # Internal: Build CLAUDE.md from enabled template sections
    _claude_build_md() { ... }

    # Internal: Load and parse CLAUDE_* config from .env
    _claude_load_config() { ... }

    # Main entry point — called by dotconfigs CLI
    plugin_claude_deploy() { ... }
    ```

    **Key changes from deploy.sh deploy_global():**

    1. **Read CLAUDE_* keys** — `_claude_load_config` sources .env then reads:
       - `CLAUDE_DEPLOY_TARGET` (was DEPLOY_TARGET)
       - `CLAUDE_SETTINGS_ENABLED` (was SETTINGS_ENABLED)
       - `CLAUDE_MD_SECTIONS` (was CLAUDE_SECTIONS)
       - `CLAUDE_HOOKS_ENABLED` (was HOOKS_ENABLED)
       - `CLAUDE_SKILLS_ENABLED` (was SKILLS_ENABLED)
       - `CLAUDE_GSD_INSTALL` (was GSD_INSTALL)
       - `CLAUDE_GIT_USER_NAME` (was GIT_USER_NAME)
       - `CLAUDE_GIT_USER_EMAIL` (was GIT_USER_EMAIL)

       Parse space-separated strings back to arrays using `IFS=' ' read -ra`.

       If .env doesn't exist, print error: "No configuration found. Run 'dotconfigs setup claude' first." and return 1.

    2. **Plugin-relative asset paths** — All asset references use `$PLUGIN_DIR` (derived from BASH_SOURCE):
       - `$PLUGIN_DIR/templates/claude-md/` for CLAUDE.md sections
       - `$PLUGIN_DIR/templates/settings/` for settings templates (not used in global deploy, but available)
       - `$PLUGIN_DIR/hooks/` for Claude Code hooks
       - `$PLUGIN_DIR/commands/` for skills/slash commands

       The root `settings.json` stays at `$SCRIPT_DIR/settings.json` (it's the global settings file, symlinked to deploy target). Access SCRIPT_DIR via `$DOTCONFIGS_ROOT` which the entry point should set, or derive: `DOTCONFIGS_ROOT="$(cd "$PLUGIN_DIR/../.." && pwd)"`.

    3. **_claude_build_md()** — Extract from deploy.sh build_claude_md() (lines 48-95). Same logic: read templates in numeric order, concatenate enabled ones. Change path from `$dotclaude_root/templates/claude-md` to `$PLUGIN_DIR/templates/claude-md`.

    4. **Deployment steps** (from deploy_global lines 427-536, adapted):

       a. Create deploy target dir if missing
       b. Symlink settings.json (from DOTCONFIGS_ROOT/settings.json, not plugin dir — settings.json is the shared global file)
       c. Build CLAUDE.md from enabled sections (using _claude_build_md)
       d. Symlink Claude Code hooks from `$PLUGIN_DIR/hooks/`
       e. Symlink skills from `$PLUGIN_DIR/commands/`
       f. Deploy git hooks from `$DOTCONFIGS_ROOT/githooks/` to `$CLAUDE_DEPLOY_TARGET/git-hooks/` + set core.hooksPath (keep this — it's part of the current deploy flow, git plugin in Phase 6 can take ownership later)
       g. Configure git identity (if CLAUDE_GIT_USER_NAME/EMAIL set)
       h. Install GSD framework if CLAUDE_GSD_INSTALL=true
       i. Handle .git/info/exclude for dotconfigs repo (CLAUDE.md, .claude/)

    5. **Drop shell aliases deployment** — `setup_shell_aliases()` is dead code (aliases referenced deploy.sh which is being deleted). Per Claude's discretion, drop it.

    6. **Drop remote deployment** — `deploy_remote()` is not part of plugin_claude_deploy. Remote deployment was a deploy.sh feature that SSH'd and re-ran deploy.sh. If users need remote deploy in future, it's a Phase 7 concern. Per Claude's discretion, drop it.

    7. **Interactive flag** — deploy_global took an `interactive` flag for conflict handling. Keep this: `plugin_claude_deploy` should accept `--interactive` flag (default false). Pass to backup_and_link. When non-interactive, conflicts are skipped silently.

    **GSD coexistence (COMP-03):** File-level symlinks are the mechanism. backup_and_link from lib/symlinks.sh handles this — it checks is_dotclaude_owned before overwriting, so GSD framework files that aren't owned by dotconfigs are not clobbered. Keep this exact pattern.

    **Bash 3.2 compatibility:** Same constraints — no namerefs, no associative arrays, no ${var,,}.
  </action>
  <verify>
    - `bash -n plugins/claude/deploy.sh` returns 0 (no syntax errors)
    - `grep 'plugin_claude_deploy' plugins/claude/deploy.sh` finds the main function
    - `grep '_claude_build_md' plugins/claude/deploy.sh` finds the CLAUDE.md builder
    - `grep '_claude_load_config' plugins/claude/deploy.sh` finds the config loader
    - `grep 'CLAUDE_DEPLOY_TARGET' plugins/claude/deploy.sh` shows new key names
    - `grep 'backup_and_link' plugins/claude/deploy.sh` shows symlink usage
    - `grep -c 'setup_shell_aliases\|deploy_remote\|ALIASES_ENABLED' plugins/claude/deploy.sh` returns 0 (dropped)
    - No bash 4+ syntax: `grep -E 'local -n|declare -A|\$\{[^}]+,,\}' plugins/claude/deploy.sh` returns nothing
  </verify>
  <done>
    - plugin_claude_deploy() reads CLAUDE_* keys from .env
    - Deploys CLAUDE.md (built from sections), settings.json (symlinked), hooks (symlinked), skills (symlinked)
    - Git hooks deployed, git identity configured
    - GSD coexistence via file-level symlinks preserved
    - Interactive conflict handling preserved
    - Shell aliases and remote deploy dropped (dead code)
    - Bash 3.2 compatible
  </done>
</task>

</tasks>

<verification>
- `dotconfigs deploy claude` with a valid .env prints deployment steps (or errors cleanly if .env missing)
- CLAUDE.md, settings.json, hooks, skills would be deployed to target directory
- No bash 4+ features used
</verification>

<success_criteria>
- plugins/claude/deploy.sh contains plugin_claude_deploy function with full deployment logic
- All .env keys read use CLAUDE_* prefix
- GSD coexistence maintained via existing backup_and_link pattern
- bash -n passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-claude-plugin-extraction/05-03-SUMMARY.md`
</output>
