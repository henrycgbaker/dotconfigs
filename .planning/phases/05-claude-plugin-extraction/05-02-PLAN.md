---
phase: 05-claude-plugin-extraction
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - plugins/claude/setup.sh
autonomous: true

must_haves:
  truths:
    - "dotconfigs setup claude runs interactive wizard with identical UX to deploy.sh"
    - ".env uses CLAUDE_* prefixed keys for all claude-specific settings"
    - "Wizard pre-fills from existing CLAUDE_* values on re-run"
    - "Wizard pre-fills from old unprefixed keys as defaults during migration"
    - "Old unprefixed keys are commented out after wizard saves new CLAUDE_* keys"
    - "Summary of all settings shown before writing to .env"
    - "Setup writes .env only — no filesystem deployment"
  artifacts:
    - path: "plugins/claude/setup.sh"
      provides: "Full interactive setup wizard"
      min_lines: 150
      exports: ["plugin_claude_setup"]
  key_links:
    - from: "plugins/claude/setup.sh"
      to: "lib/wizard.sh"
      via: "wizard_prompt, wizard_yesno, wizard_header, wizard_save_env"
      pattern: "wizard_(prompt|yesno|header|save_env)"
    - from: "plugins/claude/setup.sh"
      to: "lib/discovery.sh"
      via: "discover_claude_sections, discover_hooks, discover_skills"
      pattern: "discover_(claude_sections|hooks|skills)"
    - from: "plugins/claude/setup.sh"
      to: ".env"
      via: "wizard_save_env writes CLAUDE_* keys"
      pattern: "CLAUDE_"
---

<objective>
Replace the stub plugins/claude/setup.sh with the full interactive wizard extracted from deploy.sh run_wizard() + save_config(). All .env keys get CLAUDE_* prefix with migration from old keys.

Purpose: CLPL-01 (wizard code migrated), CONF-01 (CLAUDE_* prefixing), CONF-03 (pre-fill defaults), CLI-02 (setup command works). This is the most complex extraction — the 9-step wizard with key migration.

Output: Working `dotconfigs setup claude` that writes CLAUDE_* prefixed keys to .env with full migration support.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-claude-plugin-extraction/05-CONTEXT.md
@.planning/phases/05-claude-plugin-extraction/05-RESEARCH.md
@.planning/phases/05-claude-plugin-extraction/05-01-SUMMARY.md
@deploy.sh
@lib/wizard.sh
@lib/discovery.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement plugin_claude_setup wizard with CLAUDE_* prefixing</name>
  <files>plugins/claude/setup.sh</files>
  <action>
    Replace the stub in plugins/claude/setup.sh with the full wizard extracted from deploy.sh lines 98-337. This is a surgical extraction — preserve the wizard UX exactly, but adapt for the plugin architecture.

    **Structure:**

    ```
    # plugins/claude/setup.sh — Claude Code setup wizard
    # Sourced by dotconfigs entry point. Do not execute directly.

    # Internal: save CLAUDE_* config to .env
    _claude_save_config() { ... }

    # Internal: migrate old unprefixed keys to CLAUDE_* prefix
    _claude_migrate_old_keys() { ... }

    # Main entry point — called by dotconfigs CLI
    plugin_claude_setup() { ... }
    ```

    **Key changes from deploy.sh run_wizard():**

    1. **CLAUDE_* key prefixing** — Every key saved to .env gets CLAUDE_ prefix:
       - `DEPLOY_TARGET` -> `CLAUDE_DEPLOY_TARGET`
       - `SETTINGS_ENABLED` -> `CLAUDE_SETTINGS_ENABLED`
       - `CLAUDE_SECTIONS` -> `CLAUDE_MD_SECTIONS` (already had CLAUDE but rename for clarity)
       - `HOOKS_ENABLED` -> `CLAUDE_HOOKS_ENABLED`
       - `SKILLS_ENABLED` -> `CLAUDE_SKILLS_ENABLED`
       - `GSD_INSTALL` -> `CLAUDE_GSD_INSTALL`
       - `GIT_USER_NAME` -> keep as-is (shared, not claude-specific) — actually NO, per user decision ALL Claude plugin keys get CLAUDE_* prefix. Git identity in claude wizard becomes `CLAUDE_GIT_USER_NAME` and `CLAUDE_GIT_USER_EMAIL` (the git plugin will have its own GIT_* keys in Phase 6).
       - `ALIASES_ENABLED` -> drop (shell aliases are deploy.sh concept, not relevant to plugin architecture — use Claude's discretion to drop dead code)
       - `ALIAS_DEPLOY_NAME` -> drop (same reason)

    2. **Migration pre-fill** — Load .env early. For each wizard prompt, default value chain:
       `${CLAUDE_DEPLOY_TARGET:-${DEPLOY_TARGET:-$HOME/.claude}}`
       This pre-fills from new CLAUDE_* key first, falls back to old unprefixed key, then hardcoded default.

    3. **Comment out old keys** — After saving all new CLAUDE_* keys, call `_claude_migrate_old_keys` which finds old unprefixed keys and comments them out with `# migrated to CLAUDE_*` prefix. Use sed to transform `^KEY=` to `# migrated to CLAUDE_KEY\n# KEY=`. Platform-aware sed (darwin vs linux).

       Old keys to migrate: DEPLOY_TARGET, SETTINGS_ENABLED, CLAUDE_SECTIONS, HOOKS_ENABLED, SKILLS_ENABLED, GSD_INSTALL, GIT_USER_NAME, GIT_USER_EMAIL, ALIASES_ENABLED, ALIAS_DEPLOY_NAME.

    4. **Summary + confirm** — After all 7 steps (was 9, dropping aliases + renaming conflict review to summary), display all settings in a formatted block. Ask `wizard_yesno "Save this configuration?" "y"`. Only write to .env if confirmed. If declined, print "Configuration not saved. Re-run wizard to try again." and return 0.

    5. **Discovery paths** — Call discovery functions with `$PLUGIN_DIR` (the plugin's own directory, derived from BASH_SOURCE):
       ```bash
       PLUGIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
       ```
       Then: `discover_claude_sections "$PLUGIN_DIR"`, `discover_hooks "$PLUGIN_DIR"`, `discover_skills "$PLUGIN_DIR"`.

    6. **No deployment** — Setup writes .env ONLY. No filesystem deployment, no symlinks, no git config. That's deploy.sh's job.

    **Wizard steps (7 steps, down from 9):**

    Step 1: Deploy Target — where to deploy Claude config (default: ~/.claude)
    Step 2: Settings — deploy settings.json? (y/n)
    Step 3: CLAUDE.md Sections — toggle each section (y/n per section)
    Step 4: Claude Code Hooks — toggle each hook (y/n per hook)
    Step 5: Skills — toggle each skill (y/n per skill)
    Step 6: GSD Framework — install GSD? (y/n)
    Step 7: Git Identity — git user.name and user.email for Claude to use

    Then: Summary + confirm.

    Dropped from original wizard: Step 8 (Shell Aliases — dead code, aliases pointed at deploy.sh which is being deleted), Step 9 (Conflict Review — moves to deploy, where it's more relevant since deploy actually touches the filesystem).

    **Wizard banner:** Update from "dotclaude Global Deployment Wizard" to "dotconfigs — Claude Configuration". Keep the box characters.

    **Bash 3.2 compatibility:** No namerefs, no associative arrays, no ${var,,}. Use `tr '[:upper:]' '[:lower:]'` for case folding. Use `eval` for indirect variable assignment (matching existing wizard_prompt pattern).
  </action>
  <verify>
    - `bash -n plugins/claude/setup.sh` returns 0 (no syntax errors)
    - `grep -c 'CLAUDE_' plugins/claude/setup.sh` shows CLAUDE_* prefix used throughout
    - `grep 'plugin_claude_setup' plugins/claude/setup.sh` finds the main function
    - `grep '_claude_save_config' plugins/claude/setup.sh` finds the save function
    - `grep '_claude_migrate_old_keys' plugins/claude/setup.sh` finds the migration function
    - `grep 'wizard_header' plugins/claude/setup.sh` shows 7 step headers (plus summary)
    - `grep -c 'ALIASES_ENABLED\|ALIAS_DEPLOY_NAME' plugins/claude/setup.sh` returns 0 (dropped)
    - `grep 'Save this configuration' plugins/claude/setup.sh` finds the confirm prompt
    - No bash 4+ syntax: `grep -E 'local -n|declare -A|\$\{[^}]+,,\}' plugins/claude/setup.sh` returns nothing
  </verify>
  <done>
    - plugin_claude_setup() runs 7-step interactive wizard
    - All keys saved with CLAUDE_* prefix
    - Pre-fills from both CLAUDE_* and old unprefixed keys
    - Old keys commented out after migration
    - Summary shown before saving, user confirms
    - No filesystem deployment (setup writes .env only)
    - Bash 3.2 compatible
  </done>
</task>

</tasks>

<verification>
- `dotconfigs setup claude` starts the interactive wizard (can Ctrl+C to exit)
- .env file would contain CLAUDE_* prefixed keys after completion
- No bash 4+ features used
- Shell aliases code not present (dropped dead code)
</verification>

<success_criteria>
- plugins/claude/setup.sh contains plugin_claude_setup function with full wizard
- All .env keys use CLAUDE_* prefix
- Migration logic comments out old unprefixed keys
- Summary + confirm flow implemented
- bash -n passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-claude-plugin-extraction/05-02-SUMMARY.md`
</output>
