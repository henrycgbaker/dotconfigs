---
phase: 11-json-config-core-deploy
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: [dotconfigs, project.json.example]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "project-init generates project.json containing ALL groups from global.json"
    - "New groups added to global.json automatically appear in project-init output"
    - "Project-specific target paths are correct (project-relative, not absolute)"
    - "project.json.example is removed (global.json is SSOT)"
  artifacts:
    - path: "dotconfigs"
      provides: "cmd_project_init with dynamic generation from global.json"
      contains: "jq.*global.json"
    - path: "project.json.example"
      provides: "Deleted — no longer exists"
  key_links:
    - from: "dotconfigs (cmd_project_init)"
      to: "global.json"
      via: "jq reads global.json at init time"
      pattern: "global\\.json"
---

<objective>
Close gap from Phase 11 UAT Test 5: project-init template is incomplete (only claude/git) and should be auto-generated from global.json as SSOT.

Purpose: Ensure `dotconfigs project-init` always reflects the full set of available groups/modules from global.json, so users see everything they can configure for a project.

Output: Updated cmd_project_init that reads global.json dynamically instead of copying a static template.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-json-config-core-deploy/11-03-SUMMARY.md
@global.json
@dotconfigs
@lib/deploy.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace static template copy with dynamic generation from global.json</name>
  <files>dotconfigs</files>
  <action>
In cmd_project_init (around line 638), replace the static `jq 'del(._comment)' "$SCRIPT_DIR/project.json.example"` with a jq transformation that reads global.json and produces a project.json.

The jq script must:

1. Read `$SCRIPT_DIR/global.json` as input
2. Transform every module's target path from global (absolute/tilde) to project-relative using this mapping approach:
   - Known overrides applied first (a small inline map for modules needing special treatment)
   - Default fallback: strip leading `~/` or `~` to produce a relative path

Known project-specific overrides (these differ from global.json in source, target, method, or include):
- `claude.settings`: source changes to `plugins/claude/templates/settings/project-template.json`, target `.claude/settings.json`, method `copy` (project settings are user-editable after first deploy)
- `claude.hooks`: include changes to just `["block-destructive.sh"]` (projects only need the safety hook)
- `git.hooks`: target changes to `.git/hooks`, include changes to `["pre-commit", "commit-msg"]`
- `git.global-excludes`: key becomes `exclude-patterns`, source changes to `plugins/git/project-exclude-patterns`, target `.git/info/exclude`, method `copy`
- `git.config`: becomes `gitignore` with source `plugins/git/templates/gitignore-default`, target `.gitignore`, method `copy` (global gitconfig doesn't apply per-project)

For modules WITHOUT known overrides (vscode.*, shell.*, any future groups):
- Keep the same source path
- Transform target by stripping `~/` prefix to make it relative (e.g. `~/Library/Application Support/Code/User/settings.json` becomes `Library/Application Support/Code/User/settings.json`)
- Keep same method and include

Implementation approach — use a jq script with a project overrides object. Something like:

```bash
jq -n --slurpfile global "$SCRIPT_DIR/global.json" '
  # Project-specific overrides for known modules
  {
    "claude": {
      "hooks": {
        "source": "plugins/claude/hooks",
        "target": ".claude/hooks",
        "method": "symlink",
        "include": ["block-destructive.sh"]
      },
      "settings": {
        "source": "plugins/claude/templates/settings/project-template.json",
        "target": ".claude/settings.json",
        "method": "copy"
      }
    },
    "git": {
      "hooks": {
        "source": "plugins/git/hooks",
        "target": ".git/hooks",
        "method": "symlink",
        "include": ["pre-commit", "commit-msg"]
      },
      "exclude-patterns": {
        "source": "plugins/git/project-exclude-patterns",
        "target": ".git/info/exclude",
        "method": "copy"
      },
      "gitignore": {
        "source": "plugins/git/templates/gitignore-default",
        "target": ".gitignore",
        "method": "copy"
      }
    }
  } as $overrides |

  # Start with overrides for known groups
  $overrides |

  # Add any groups from global.json that are NOT in overrides
  ($global[0] | keys[]) as $group |
  if has($group) then .
  else
    # Transform this entire group from global.json
    . + {
      ($group): (
        $global[0][$group] | to_entries | map(
          {
            key: .key,
            value: (
              .value |
              if has("source") and has("target") then
                .target |= (if startswith("~/") then .[2:] elif startswith("~") then .[1:] else . end)
              else . end
            )
          }
        ) | from_entries
      )
    }
  end
' > "$config_file"
```

The exact jq may need iteration to handle the `reduce` pattern correctly for multiple groups. The key requirement: every top-level key from global.json must appear in the output. Known groups (claude, git) use curated project-specific configs. Unknown groups get auto-transformed targets.

Keep the rest of cmd_project_init unchanged (mkdir, exclude-file logic, success messages).

IMPORTANT: Remove the `_comment` field handling since we no longer copy from project.json.example. The generated JSON won't have a `_comment` field. Also remove the `include` key from modules where it would be an empty array (jq's `if .include == [] then del(.include) else . end` or simply don't emit it).
  </action>
  <verify>
Test in a temporary git repo:
```bash
cd /tmp && mkdir -p test-project && cd test-project && git init
dotconfigs project-init
cat .dotconfigs/project.json | jq .
```
Verify output contains ALL groups from global.json (claude, git, vscode, shell) with project-relative targets. No absolute or tilde paths in targets. Valid JSON.
  </verify>
  <done>
`dotconfigs project-init` produces a project.json containing entries for all 4 groups (claude, git, vscode, shell) with correct project-relative targets. Claude and git have curated project-specific overrides. Vscode and shell have auto-transformed paths from global.json.
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete project.json.example</name>
  <files>project.json.example</files>
  <action>
Delete the static `project.json.example` file from the repo root. It is no longer needed since project-init now generates dynamically from global.json.

Also grep the codebase for any remaining references to `project.json.example` and update them:
- In `dotconfigs` help text or comments — remove or update references
- In ROADMAP.md config schema section — the comment `See: global.json (actual config) and project.json.example (reference)` should be updated to just reference global.json
- Any other files referencing it

Do NOT update .planning/ files — those are historical records.
  </action>
  <verify>
```bash
test ! -f project.json.example && echo "DELETED"
grep -r "project.json.example" --include="*.sh" --include="*.md" . | grep -v .planning/ | grep -v .git/
```
First command confirms deletion. Second confirms no remaining non-planning references (should return empty).
  </verify>
  <done>
project.json.example is deleted. No references to it remain in active code or docs (planning files excluded as historical).
  </done>
</task>

</tasks>

<verification>
1. `dotconfigs project-init` in a fresh git repo creates project.json with all 4 groups
2. `jq keys /tmp/test-project/.dotconfigs/project.json` returns `["claude", "git", "shell", "vscode"]`
3. No tilde (`~`) or absolute paths in any target value: `jq '.. | .target? // empty' /tmp/test-project/.dotconfigs/project.json` — all relative
4. `dotconfigs project /tmp/test-project --dry-run` shows modules from all groups present in project.json
5. project.json.example no longer exists in repo root
</verification>

<success_criteria>
- project-init generates complete project.json from global.json (SSOT)
- All 4 groups (claude, git, vscode, shell) present with correct project-relative targets
- Known modules (claude.hooks, git.hooks, etc.) have curated project overrides
- Unknown/new modules get auto-transformed targets (tilde stripped)
- Static project.json.example deleted
- No references to deleted file in active codebase
</success_criteria>

<output>
After completion, create `.planning/phases/11-json-config-core-deploy/11-04-SUMMARY.md`
</output>
