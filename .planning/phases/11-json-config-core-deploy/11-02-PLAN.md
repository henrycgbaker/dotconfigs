---
phase: 11-json-config-core-deploy
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - dotconfigs
  - plugins/claude/settings.json
autonomous: true

must_haves:
  truths:
    - "dotconfigs deploy reads global.json and symlinks all modules to targets"
    - "dotconfigs deploy <group> deploys only modules under that group key"
    - "dotconfigs deploy --dry-run previews without writing"
    - "dotconfigs deploy --force overwrites conflicts without prompting"
    - "Deploy is idempotent -- running twice produces same result"
    - "Existing hook/skill/settings deployments are preserved (no functionality loss)"
    - "Git config symlinked to ~/.gitconfig, write-through works"
    - "Global excludes symlinked to ~/.config/git/ignore"
  artifacts:
    - path: "dotconfigs"
      provides: "CLI entry point with JSON-based deploy command"
      contains: "deploy_from_json"
    - path: "plugins/claude/settings.json"
      provides: "Claude settings for symlink deployment"
      contains: "hooks"
  key_links:
    - from: "dotconfigs"
      to: "lib/deploy.sh"
      via: "source and function call"
      pattern: "source.*lib/deploy.sh"
    - from: "dotconfigs"
      to: "global.json"
      via: "deploy_from_json reads config"
      pattern: "deploy_from_json.*global.json"
---

<objective>
Rewrite the CLI deploy command to use the generic JSON deployer, replacing the old .env-based plugin-specific deployment.

Purpose: This makes `dotconfigs deploy` read global.json instead of sourcing plugin deploy.sh scripts, completing the transition from wizard-driven to config-driven deployment.

Output: Updated `dotconfigs` CLI entry point where `cmd_deploy()` calls `deploy_from_json()` from lib/deploy.sh.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-json-config-core-deploy/11-01-SUMMARY.md
@dotconfigs
@global.json
@lib/deploy.sh
@lib/symlinks.sh
@plugins/claude/settings.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite cmd_deploy to use deploy_from_json</name>
  <files>dotconfigs</files>
  <action>
Modify the `dotconfigs` CLI entry point to use the new generic deployer.

**Changes to make:**

1. **Add lib/deploy.sh to source list** (near the top, after existing source lines):
   ```
   source "$SCRIPT_DIR/lib/deploy.sh"
   ```

2. **Add GLOBAL_CONFIG variable** after SCRIPT_DIR/ENV_FILE definitions:
   ```
   GLOBAL_CONFIG="$SCRIPT_DIR/global.json"
   ```

3. **Rewrite `cmd_deploy()`** to replace the plugin-iterating deploy with a single call to deploy_from_json:
   - Parse arguments same as before: --dry-run, --force, first non-flag arg is group filter (not "plugin" any more)
   - Remove --regenerate and --interactive (not needed for JSON deploy)
   - Call `deploy_from_json "$GLOBAL_CONFIG" "$SCRIPT_DIR" "$group" "$dry_run" "$force_mode"`
   - After deploy_from_json returns, still call `_create_path_symlink "$dry_run" "$force_mode"` for PATH availability

4. **Update deploy help text** in `show_command_help` deploy section:
   - Change "plugin" to "group" in usage
   - Remove --regenerate flag documentation
   - Update description: "Deploys configuration from global.json to filesystem"
   - Update examples: `dotconfigs deploy claude` (deploy claude group only)

5. **Update show_usage** deploy line to say "Deploy configuration from global.json"

6. **Keep old plugin deploy scripts** -- don't delete plugins/claude/deploy.sh or plugins/git/deploy.sh. They're still needed for status command and may be reused in v4. Just stop calling them from cmd_deploy.

7. **Update cmd_status and cmd_list**: These still reference .env and plugin deploy scripts. For now leave them as-is -- they'll be updated in Phase 12 (CLI cleanup). The old deploy.sh files remain sourced for status.

**Key decisions:**
- The "group" argument to `dotconfigs deploy <group>` corresponds to top-level keys in global.json ("claude", "git", "vscode", "shell")
- No validation that group exists in JSON -- jq silently returns nothing for missing keys, and deploy_from_json prints "No modules found" which is the right UX
- The deploy function from lib/deploy.sh handles ALL the deployment logic (dry-run, force, status reporting)
  </action>
  <verify>
Run: `bash -n dotconfigs` (syntax check passes)
Run: `grep 'deploy_from_json' dotconfigs` (function is called)
Run: `grep 'lib/deploy.sh' dotconfigs` (library is sourced)
Run: `grep 'GLOBAL_CONFIG' dotconfigs` (config path defined)
  </verify>
  <done>
cmd_deploy() calls deploy_from_json() from lib/deploy.sh with global.json. Help text updated. PATH symlink creation preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Ensure settings.json is ready for symlink deployment</name>
  <files>plugins/claude/settings.json</files>
  <action>
The current settings.json at `plugins/claude/settings.json` uses `$CLAUDE_PROJECT_DIR` variable references in hook paths. These were partially fixed in Phase 10, but for v3.0 the file needs to be a complete, ready-to-symlink artifact with no unresolved variables.

Verify `plugins/claude/settings.json` hook paths use `~/.claude/hooks/` (should already be correct from Phase 10). If any template variables remain, replace with absolute paths. Confirm no unresolved variables remain.

The settings.json in `plugins/claude/` is what gets symlinked to `~/.claude/settings.json` via global.json. It must be correct as-is.

Also check that `settings.json` in the repo root (the Claude project-level settings) is separate from `plugins/claude/settings.json` (the global Claude settings to deploy). These are different files:
- `settings.json` (repo root) = this dotconfigs project's Claude settings
- `plugins/claude/settings.json` = the global Claude settings to deploy to `~/.claude/settings.json`

Verify both exist and contain appropriate content. The repo root `settings.json` might still have `$CLAUDE_PROJECT_DIR` refs since it's this project's own config -- that's fine and expected for project-level settings.
  </action>
  <verify>
Run: `grep 'CLAUDE_PROJECT_DIR' plugins/claude/settings.json` returns no matches (no unresolved variables)
The file contains valid JSON with hook paths pointing to `~/.claude/hooks/`
  </verify>
  <done>
plugins/claude/settings.json is a clean, ready-to-symlink artifact with absolute paths. No unresolved template variables.
  </done>
</task>

<task type="auto">
  <name>Task 3: End-to-end dry-run verification</name>
  <files>dotconfigs</files>
  <action>
Run the actual deploy command in dry-run mode to verify the full pipeline works:

1. Run `./dotconfigs deploy --dry-run` and verify output shows all modules from global.json being processed
2. Run `./dotconfigs deploy --dry-run claude` and verify only claude group modules appear
3. Run `./dotconfigs deploy --dry-run git` and verify only git group modules appear

Expected output format for each module:
```
  Would link: plugins/claude/hooks/block-destructive.sh -> /Users/.../claude/hooks/block-destructive.sh
  Unchanged: plugins/claude/settings.json -> /Users/.../claude/settings.json
```

Fix any issues found during this end-to-end test. Common issues to watch for:
- Paths with spaces (VS Code targets) not handled correctly
- Tilde not expanded in target paths
- Source files not found (relative path resolution)
- jq errors on the JSON
- Missing include files in directories

Note: vscode and shell groups will report "source not found" warnings since those plugin directories don't exist yet -- this is expected and correct behaviour. The deployer should warn and skip, not crash.
  </action>
  <verify>
`./dotconfigs deploy --dry-run` runs without errors
`./dotconfigs deploy --dry-run claude` shows only claude modules
`./dotconfigs deploy --dry-run git` shows only git modules
Output includes status for each module (Would link, Unchanged, etc.)
  </verify>
  <done>
End-to-end dry-run works. All modules from global.json are processed. Group filtering works. Status reporting shows per-module results. Non-existent sources produce warnings, not crashes.
  </done>
</task>

</tasks>

<verification>
1. `bash -n dotconfigs` -- no syntax errors
2. `./dotconfigs deploy --dry-run` runs successfully
3. `./dotconfigs deploy --dry-run claude` shows only claude modules
4. `./dotconfigs deploy --dry-run git` shows only git modules
5. `grep -c '$CLAUDE_PROJECT_DIR' plugins/claude/settings.json` returns 0
6. Old plugin deploy scripts (plugins/*/deploy.sh) still exist (not deleted)
</verification>

<success_criteria>
- `dotconfigs deploy` reads global.json via deploy_from_json
- `dotconfigs deploy <group>` filters to single group
- --dry-run and --force flags work correctly
- Deploy is idempotent
- settings.json has no unresolved template variables
- Git config modules (gitconfig, global-excludes) appear in deploy output
- PATH symlink creation still happens after deploy
</success_criteria>

<output>
After completion, create `.planning/phases/11-json-config-core-deploy/11-02-SUMMARY.md`
</output>
