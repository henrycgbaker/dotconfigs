---
phase: 11-json-config-core-deploy
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - dotconfigs
  - project.json.example
autonomous: true

must_haves:
  truths:
    - "dotconfigs project <path> reads .dotconfigs/project.json and deploys modules"
    - "Source paths in project.json resolve against dotconfigs repo root"
    - "Target paths in project.json resolve relative to the project root"
    - ".dotconfigs/ is auto-excluded via .git/info/exclude when deploying"
    - "dotconfigs project-init <path> creates .dotconfigs/project.json with sensible defaults"
    - "project-init creates .dotconfigs/ directory if it doesn't exist"
  artifacts:
    - path: "dotconfigs"
      provides: "CLI with project and project-init commands using JSON deploy"
      contains: "cmd_project"
    - path: "project.json.example"
      provides: "Reference template for per-project config"
      contains: "source"
  key_links:
    - from: "dotconfigs"
      to: "lib/deploy.sh"
      via: "deploy_from_json call for project deploy"
      pattern: "deploy_from_json.*project.json"
    - from: "dotconfigs"
      to: ".dotconfigs/project.json"
      via: "reads project config at target path"
      pattern: "dotconfigs_dir.*project.json"
---

<objective>
Implement project-level JSON deployment: `dotconfigs project <path>` reads `.dotconfigs/project.json` and deploys, while `dotconfigs project-init <path>` scaffolds the config file.

Purpose: Per-project config allows each repo to get its own subset of hooks, settings, etc. without affecting global config. This replaces the broken plugin-specific project.sh scripts.

Output: Updated CLI with `project` and `project-init` commands that use the generic deployer.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-json-config-core-deploy/11-01-SUMMARY.md
@dotconfigs
@project.json.example
@lib/deploy.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement cmd_project for JSON-based project deployment</name>
  <files>dotconfigs</files>
  <action>
Add a new `cmd_project()` function to the `dotconfigs` CLI entry point that reads `.dotconfigs/project.json` from a target project path and deploys using the generic deployer.

**Function: `cmd_project()`**

Arguments: `<path> [--dry-run] [--force]`

Steps:
1. Parse arguments: extract path and flags (--dry-run, --force). Path is required.
2. Resolve path to absolute using `expand_path` (from lib/validation.sh, already sourced)
3. Validate the path is a git repo using `validate_git_repo` (already available)
4. Check `.dotconfigs/project.json` exists at that path. If not, print error: "No .dotconfigs/project.json found at <path>. Run 'dotconfigs project-init <path>' to create one."
5. Call `deploy_from_json` with:
   - config_file = `"$project_path/.dotconfigs/project.json"`
   - dotconfigs_root = `"$SCRIPT_DIR"` (source paths resolve against dotconfigs repo root)
   - group = empty (deploy all modules)
   - dry_run and force from flags
   - project_root = `"$project_path"` (target paths resolve relative to this)
6. After deployment, auto-exclude `.dotconfigs/` via `.git/info/exclude` at the project path

**Modify `deploy_from_json()` in lib/deploy.sh** to accept an optional `project_root` parameter. When project_root is set:
- Target paths that DON'T start with `/` or `~` are resolved relative to project_root (prepend project_root)
- Target paths that DO start with `/` or `~` resolve normally (absolute or tilde-expand)

This change is backwards-compatible: when project_root is empty (global deploy), all targets expand normally.

**Auto-exclude .dotconfigs/:**
After deploying to a project, check `.git/info/exclude` at the project path. If `.dotconfigs/` is not listed, append it. This is a simple check-and-append (same pattern as existing CLAUDE.md exclusion logic). Skip in dry-run mode.

**Update CLI routing in `main()`:**
- Add `project` case that calls `cmd_project`
- Keep `project-configs|project-init` routing to `cmd_project_init` (renamed from cmd_project_configs)

**Update help text:**
- Add `project` command to show_usage and show_command_help
  </action>
  <verify>
Run: `bash -n dotconfigs` (syntax check passes)
Run: `grep 'cmd_project' dotconfigs` (function exists)
Run: `grep 'project_root' lib/deploy.sh` (project root support added)
  </verify>
  <done>
cmd_project() reads .dotconfigs/project.json and deploys via deploy_from_json with project_root resolution. .dotconfigs/ auto-excluded in .git/info/exclude.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement cmd_project_init for scaffolding project.json</name>
  <files>dotconfigs, project.json.example</files>
  <action>
Add a new `cmd_project_init()` function that creates `.dotconfigs/project.json` at a target project path.

**Function: `cmd_project_init()`**

Arguments: `<path>`

Steps:
1. Parse arguments: extract path. If no path given and CWD is a git repo (and not the dotconfigs repo itself), use CWD.
2. Resolve to absolute path.
3. Validate git repo.
4. Check if `.dotconfigs/project.json` already exists. If so, print "Project config already exists at <path>/.dotconfigs/project.json" and exit 0 (not an error).
5. Create `.dotconfigs/` directory: `mkdir -p "$project_path/.dotconfigs"`
6. Copy `project.json.example` from the dotconfigs repo root to `$project_path/.dotconfigs/project.json`, stripping the `_comment` field using jq: `jq 'del(._comment)' "$SCRIPT_DIR/project.json.example" > "$project_path/.dotconfigs/project.json"`
7. Auto-exclude `.dotconfigs/` in `.git/info/exclude` (same logic as cmd_project)
8. Print success message with next steps: "Created .dotconfigs/project.json -- edit it, then run: dotconfigs project <path>"

**Update project.json.example:**
Review and ensure it has sensible defaults. The current content looks good. Just verify the `_comment` field explains usage. No changes needed unless content is wrong.

**Replace old cmd_project_configs:**
The old `cmd_project_configs` function that used plugin project.sh scripts is broken (known bugs in STATE.md). Replace the `project-configs|project-init` case in main() to call `cmd_project_init` instead. Remove the old `cmd_project_configs` function body entirely.

**Update CLI routing in main():**
```
project)
    cmd_project "${@:2}"
    ;;
project-init|project-configs)
    cmd_project_init "${@:2}"
    ;;
```

**Update help text:**
- `project-init` help: "Creates .dotconfigs/project.json from template"
- `project` help: "Deploys per-project config from .dotconfigs/project.json"
  </action>
  <verify>
Run: `bash -n dotconfigs` (syntax check passes)
Run: `grep 'cmd_project_init' dotconfigs` (function exists)
Run: `jq 'del(._comment)' project.json.example` produces valid JSON without _comment
  </verify>
  <done>
cmd_project_init() creates .dotconfigs/project.json from template. cmd_project_configs replaced. .dotconfigs/ auto-excluded. Help text updated.
  </done>
</task>

</tasks>

<verification>
1. `bash -n dotconfigs` -- no syntax errors
2. `bash -n lib/deploy.sh` -- no syntax errors (after project_root addition)
3. `./dotconfigs help project` shows project deploy help
4. `./dotconfigs help project-init` shows project-init help
5. `jq 'del(._comment)' project.json.example` produces valid JSON
6. project.json.example has sensible defaults for claude and git modules
</verification>

<success_criteria>
- `dotconfigs project <path>` reads .dotconfigs/project.json and deploys
- `dotconfigs project-init <path>` creates .dotconfigs/project.json from template
- Source paths resolve against dotconfigs repo root
- Target paths resolve relative to project root
- .dotconfigs/ auto-excluded in .git/info/exclude
- Old broken project-configs code replaced
</success_criteria>

<output>
After completion, create `.planning/phases/11-json-config-core-deploy/11-03-SUMMARY.md`
</output>
