---
phase: 10-hook-path-resolution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - plugins/claude/templates/settings/settings-template.json
  - plugins/claude/deploy.sh
  - plugins/claude/settings.json
autonomous: true

must_haves:
  truths:
    - "Global hooks fire correctly when Claude runs in any project directory (not just dotconfigs)"
    - "Project-level hooks use relative .claude/hooks/ paths that resolve from project root"
    - "No $CLAUDE_PROJECT_DIR variables appear in any deployed settings.json"
    - "Existing hook functionality (block-destructive, post-tool-format) is preserved"
  artifacts:
    - path: "plugins/claude/templates/settings/settings-template.json"
      provides: "Global settings template with ~/.claude/hooks/ absolute paths"
      contains: "~/.claude/hooks/"
    - path: "plugins/claude/deploy.sh"
      provides: "Deploy logic with path resolution at assembly time"
      contains: "sed"
    - path: "plugins/claude/settings.json"
      provides: "Regenerated deployed settings with resolved paths"
  key_links:
    - from: "plugins/claude/deploy.sh"
      to: "plugins/claude/templates/settings/settings-template.json"
      via: "_claude_assemble_settings() reads template and resolves paths"
      pattern: "sed.*CLAUDE_PROJECT_DIR"
    - from: "plugins/claude/settings.json"
      to: "~/.claude/hooks/"
      via: "hook command paths reference symlinked hooks"
      pattern: "~/.claude/hooks/"
---

<objective>
Fix global Claude hooks to use absolute paths (`~/.claude/hooks/`) instead of broken `$CLAUDE_PROJECT_DIR` references, and add deploy-time path resolution so no template variables leak into deployed files.

Purpose: This is the critical bug fix that unblocks global hooks from working in any project directory. Currently hooks only fire when Claude runs inside the dotconfigs repo itself.

Output: Updated template, deploy logic with sed-based path resolution, regenerated settings.json
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-hook-path-resolution/10-RESEARCH.md
@plugins/claude/deploy.sh
@plugins/claude/templates/settings/settings-template.json
@plugins/claude/templates/settings/hooks.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix template and deploy-time path resolution</name>
  <files>
    plugins/claude/templates/settings/settings-template.json
    plugins/claude/deploy.sh
  </files>
  <action>
**settings-template.json**: Replace all `$CLAUDE_PROJECT_DIR/plugins/claude/hooks/` path prefixes with `~/.claude/hooks/`. This makes the template correct for the global deploy case (which is the primary use case). The three hook command entries become:
- `"command": "~/.claude/hooks/block-destructive.sh"` (was `$CLAUDE_PROJECT_DIR/plugins/claude/hooks/block-destructive.sh`)
- `"command": "~/.claude/hooks/block-destructive.sh"` (second PreToolUse matcher)
- `"command": "~/.claude/hooks/post-tool-format.py"` (PostToolUse)

**deploy.sh** `_claude_assemble_settings()`: After the `cp "$template" "$output_file"` line, add a sed pass that resolves any remaining `$CLAUDE_PROJECT_DIR` references. This is a safety net -- the template should already be correct, but the sed ensures no template variables leak through if future templates accidentally use them.

Add after the cp line:
```bash
# Safety: resolve any $CLAUDE_PROJECT_DIR references to ~/.claude/
# (template should already use ~/.claude/ paths, but this catches drift)
if [[ "$OSTYPE" == "darwin"* ]]; then
    sed -i '' 's|\$CLAUDE_PROJECT_DIR/plugins/claude/hooks/|~/.claude/hooks/|g' "$output_file"
else
    sed -i 's|\$CLAUDE_PROJECT_DIR/plugins/claude/hooks/|~/.claude/hooks/|g' "$output_file"
fi
```

Do NOT change `plugins/claude/templates/settings/hooks.json` -- it already uses correct relative paths (`.claude/hooks/`) for project-level deployment.
  </action>
  <verify>
1. `grep -c 'CLAUDE_PROJECT_DIR' plugins/claude/templates/settings/settings-template.json` returns 0
2. `grep -c '~/.claude/hooks/' plugins/claude/templates/settings/settings-template.json` returns 3
3. `grep 'sed' plugins/claude/deploy.sh` shows the safety-net sed line exists in `_claude_assemble_settings`
4. `grep -c 'CLAUDE_PROJECT_DIR' plugins/claude/templates/settings/hooks.json` returns 0 (already correct)
5. `grep -c '.claude/hooks/' plugins/claude/templates/settings/hooks.json` returns 3 (already correct)
  </verify>
  <done>
settings-template.json uses ~/.claude/hooks/ absolute paths. deploy.sh has a sed safety net in _claude_assemble_settings(). hooks.json unchanged (already correct).
  </done>
</task>

<task type="auto">
  <name>Task 2: Regenerate deployed settings.json and update tests</name>
  <files>
    plugins/claude/settings.json
    tests/test-project-configs.sh
  </files>
  <action>
**Regenerate settings.json**: Delete the existing `plugins/claude/settings.json` (the gitignored assembled copy) and re-create it by running the updated `_claude_assemble_settings` function. Since the test harness can invoke this, do it by:

1. Source the deploy.sh to load the function
2. Call `_claude_assemble_settings "$PLUGIN_DIR" "$PLUGIN_DIR/settings.json"`

Alternatively, simply copy the updated settings-template.json to settings.json -- the template now has correct paths, and the sed pass will clean anything missed. The simplest approach: delete plugins/claude/settings.json, then re-assemble from the template using the updated function. If the settings.json has user customisations beyond the template (it might -- it's gitignored and user-editable), just do a targeted sed on the existing settings.json instead:

```bash
# On the existing settings.json (preserves user customisations)
sed -i '' 's|\$CLAUDE_PROJECT_DIR/plugins/claude/hooks/|~/.claude/hooks/|g' plugins/claude/settings.json
```

**Update tests**: In `tests/test-project-configs.sh`, add a test case that verifies the global settings template does NOT contain `$CLAUDE_PROJECT_DIR`. Add after the existing Claude Plugin Assertions section (around line 240, after the settings.local.json hook path checks):

```bash
# --- Global settings template check ---
echo " Global template:"
if grep -q 'CLAUDE_PROJECT_DIR' "$REPO_ROOT/plugins/claude/templates/settings/settings-template.json" 2>/dev/null; then
    check_fail "settings-template.json contains \$CLAUDE_PROJECT_DIR (should use ~/.claude/hooks/)"
else
    check_pass "settings-template.json uses resolved paths (no \$CLAUDE_PROJECT_DIR)"
fi
```

Also verify the test still passes end-to-end by running `bash tests/test-project-configs.sh`.
  </action>
  <verify>
1. `grep -c 'CLAUDE_PROJECT_DIR' plugins/claude/settings.json` returns 0
2. `grep -c '~/.claude/hooks/' plugins/claude/settings.json` returns 3
3. `bash tests/test-project-configs.sh` passes with 0 failures
4. The test output includes the new "Global template" assertion
  </verify>
  <done>
Deployed settings.json has resolved paths (no $CLAUDE_PROJECT_DIR). Test suite extended with global template assertion. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `grep -r 'CLAUDE_PROJECT_DIR' plugins/claude/templates/settings/` returns NO matches
2. `grep -r 'CLAUDE_PROJECT_DIR' plugins/claude/settings.json` returns NO matches
3. `grep '~/.claude/hooks/' plugins/claude/templates/settings/settings-template.json` shows 3 lines with correct absolute paths
4. `grep '.claude/hooks/' plugins/claude/templates/settings/hooks.json` shows 3 lines with correct relative paths (unchanged)
5. `bash tests/test-project-configs.sh` passes with 0 failures
6. The deployed symlink at `~/.claude/settings.json` -> `plugins/claude/settings.json` resolves to a file with `~/.claude/hooks/` paths
</verification>

<success_criteria>
- No `$CLAUDE_PROJECT_DIR` in any template or deployed settings file
- Global hooks use `~/.claude/hooks/` absolute paths
- Project hooks use `.claude/hooks/` relative paths (unchanged)
- Deploy function has sed safety net for path resolution
- Tests pass including new global template assertion
</success_criteria>

<output>
After completion, create `.planning/phases/10-hook-path-resolution/10-01-SUMMARY.md`
</output>
