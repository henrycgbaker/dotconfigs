---
phase: 04-core-infrastructure-cli-entry-point
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/wizard.sh
  - lib/symlinks.sh
  - lib/discovery.sh
  - lib/validation.sh
autonomous: true

must_haves:
  truths:
    - "lib/wizard.sh provides wizard_prompt, wizard_yesno, wizard_header, wizard_select, wizard_save_env functions"
    - "lib/symlinks.sh provides is_dotclaude_owned, backup_and_link, link_file functions"
    - "lib/discovery.sh provides discover_plugins, plugin_exists, list_available_plugins functions"
    - "lib/validation.sh provides validate_path, is_git_repo, validate_git_repo, expand_path functions"
    - "All code is bash 3.2 compatible (no namerefs, associative arrays, bash 4 string ops)"
  artifacts:
    - path: "lib/wizard.sh"
      provides: "Interactive wizard helpers"
      contains: "wizard_prompt"
    - path: "lib/symlinks.sh"
      provides: "Symlink management with conflict handling"
      contains: "backup_and_link"
    - path: "lib/discovery.sh"
      provides: "Plugin discovery via filesystem"
      contains: "discover_plugins"
    - path: "lib/validation.sh"
      provides: "Common validation helpers"
      contains: "validate_path"
  key_links:
    - from: "lib/discovery.sh"
      to: "plugins/*/"
      via: "find command scanning plugins directory"
      pattern: "find.*plugins.*-mindepth 1 -maxdepth 1"
---

<objective>
Create the shared library layer (`lib/`) that the CLI entry point and all plugins will depend on.

Purpose: lib/ is the foundation sourced eagerly by the entry point. Plugins and the CLI both consume these functions. Without lib/, nothing else works.
Output: Four shell library files in `lib/` — wizard.sh (moved+updated), symlinks.sh (moved+updated), discovery.sh (rewritten for plugin discovery), validation.sh (new).
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-infrastructure-cli-entry-point/04-RESEARCH.md
@scripts/lib/wizard.sh
@scripts/lib/symlinks.sh
@scripts/lib/discovery.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move and update wizard.sh and symlinks.sh into lib/</name>
  <files>lib/wizard.sh, lib/symlinks.sh</files>
  <action>
    Create `lib/` directory at the repo root.

    **lib/wizard.sh** — Copy from `scripts/lib/wizard.sh` with these changes:
    - Update the header comment: `# lib/wizard.sh — Interactive wizard helper functions` (remove "scripts/" prefix and "Sourced by deploy.sh" reference; replace with "Sourced by dotconfigs entry point.")
    - Keep ALL existing functions exactly as-is: wizard_prompt, wizard_select, wizard_yesno, wizard_header, _is_in_list, wizard_save_env
    - These functions are already bash 3.2 compatible (wizard_yesno already uses `tr '[:upper:]' '[:lower:]'`)
    - Do NOT add a shebang — this is a sourced library, not an executable

    **lib/symlinks.sh** — Copy from `scripts/lib/symlinks.sh` with these changes:
    - Update the header comment: `# lib/symlinks.sh — Symlink management and ownership detection` (remove "scripts/" prefix; replace "Sourced by deploy.sh" with "Sourced by dotconfigs entry point.")
    - Keep ALL existing functions exactly as-is: is_dotclaude_owned, backup_and_link, link_file
    - These functions are already bash 3.2 compatible (uses perl for macOS readlink, tr for case conversion)
    - Do NOT add a shebang — this is a sourced library, not an executable

    Important: Do NOT delete the originals in `scripts/lib/`. deploy.sh still references them. They will be cleaned up in Phase 5 (strangler fig migration).
  </action>
  <verify>
    - `test -f lib/wizard.sh && echo "wizard exists"` returns "wizard exists"
    - `test -f lib/symlinks.sh && echo "symlinks exists"` returns "symlinks exists"
    - `grep -c "wizard_prompt\|wizard_yesno\|wizard_header\|wizard_select\|wizard_save_env\|_is_in_list" lib/wizard.sh` returns 6 (all functions present)
    - `grep -c "is_dotclaude_owned\|backup_and_link\|link_file" lib/symlinks.sh` returns 3 (all functions present)
    - `grep -c 'declare -A\|local -n\|${.*,,}' lib/wizard.sh lib/symlinks.sh` returns 0 (no bash 4+ features)
  </verify>
  <done>lib/wizard.sh and lib/symlinks.sh exist with all original functions, updated headers, bash 3.2 compatible</done>
</task>

<task type="auto">
  <name>Task 2: Create discovery.sh (rewritten) and validation.sh (new) in lib/</name>
  <files>lib/discovery.sh, lib/validation.sh</files>
  <action>
    **lib/discovery.sh** — This is a REWRITE, not a copy. The existing `scripts/lib/discovery.sh` discovers hooks, githooks, skills, and CLAUDE.md sections. The new `lib/discovery.sh` discovers PLUGINS. Keep the existing hooks/skills discovery functions too (they will be used by plugins/claude/ in Phase 5).

    Create with these functions:

    1. `discover_plugins(plugins_dir)` — Scan `plugins/*/` directories. Return plugin names (basename), one per line, sorted. Guard: if directory doesn't exist, return 0 (empty). Use `find "$plugins_dir" -mindepth 1 -maxdepth 1 -type d` piped to basename and sort.

    2. `plugin_exists(plugin, plugins_dir)` — Check that `$plugins_dir/$plugin` is a directory AND contains both `setup.sh` and `deploy.sh`. Uses `[[ -d ... ]] && [[ -f ... ]] && [[ -f ... ]]`. Second arg defaults to `$PLUGINS_DIR` if not provided.

    3. `list_available_plugins()` — Print "Available plugins:" to stderr, then each plugin name prefixed with "  - ". Uses discover_plugins with `$PLUGINS_DIR`.

    4. Keep existing functions from scripts/lib/discovery.sh: `discover_hooks`, `discover_githooks`, `discover_skills`, `discover_claude_sections`, `discover_settings_templates`. Copy them verbatim below the new plugin functions.

    Header: `# lib/discovery.sh — Plugin discovery and content scanning`

    **lib/validation.sh** — New file. Create with these functions:

    1. `validate_path(path, purpose)` — Check `[[ -e "$path" ]]`. On failure, print "Error: $purpose does not exist: $path" to stderr, return 1. Default purpose is "path".

    2. `is_git_repo(path)` — Check `[[ -d "$path/.git" ]]`. Default path is ".".

    3. `validate_git_repo(path)` — Call is_git_repo. On failure, print error with suggestion to `git init`, return 1. Default path is ".".

    4. `expand_path(path)` — Echo `${path/#\~/$HOME}`. Handles tilde expansion.

    Header: `# lib/validation.sh — Common validation helpers`

    Neither file should have a shebang (sourced libraries). All code must be bash 3.2 compatible.

    Reference the research code examples in 04-RESEARCH.md for exact implementations.
  </action>
  <verify>
    - `test -f lib/discovery.sh && echo "discovery exists"` returns "discovery exists"
    - `test -f lib/validation.sh && echo "validation exists"` returns "validation exists"
    - `grep -c "discover_plugins\|plugin_exists\|list_available_plugins\|discover_hooks\|discover_githooks\|discover_skills\|discover_claude_sections\|discover_settings_templates" lib/discovery.sh` returns 8 (all functions present)
    - `grep -c "validate_path\|is_git_repo\|validate_git_repo\|expand_path" lib/validation.sh` returns 4 (all functions present)
    - `grep -c 'declare -A\|local -n\|${.*,,}' lib/discovery.sh lib/validation.sh` returns 0 (no bash 4+ features)
    - `bash -n lib/discovery.sh && echo "syntax ok"` returns "syntax ok" (valid bash)
    - `bash -n lib/validation.sh && echo "syntax ok"` returns "syntax ok" (valid bash)
  </verify>
  <done>lib/discovery.sh provides plugin discovery + legacy content discovery functions; lib/validation.sh provides path/git/expand helpers; both bash 3.2 compatible with valid syntax</done>
</task>

</tasks>

<verification>
All four lib files exist, have valid bash syntax, contain expected functions, and use no bash 4+ features:
```bash
for f in lib/wizard.sh lib/symlinks.sh lib/discovery.sh lib/validation.sh; do
  bash -n "$f" && echo "$f: syntax ok" || echo "$f: SYNTAX ERROR"
done
grep -rn 'declare -A\|local -n\|${.*,,}\|${.*^^}' lib/ && echo "BASH 4 FOUND" || echo "All bash 3.2 compatible"
```
</verification>

<success_criteria>
- lib/ directory exists with 4 files: wizard.sh, symlinks.sh, discovery.sh, validation.sh
- wizard.sh has 6 functions (wizard_prompt, wizard_select, wizard_yesno, wizard_header, _is_in_list, wizard_save_env)
- symlinks.sh has 3 functions (is_dotclaude_owned, backup_and_link, link_file)
- discovery.sh has 8 functions (3 new plugin functions + 5 legacy content discovery functions)
- validation.sh has 4 functions (validate_path, is_git_repo, validate_git_repo, expand_path)
- All files pass `bash -n` syntax check
- Zero bash 4+ features (no declare -A, local -n, ${var,,}, ${var^^})
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-infrastructure-cli-entry-point/04-01-SUMMARY.md`
</output>
