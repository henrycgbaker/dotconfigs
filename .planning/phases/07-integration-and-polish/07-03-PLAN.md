---
phase: 07-integration-and-polish
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - dotconfigs
  - plugins/claude/deploy.sh
  - plugins/git/deploy.sh
  - lib/symlinks.sh
autonomous: true

must_haves:
  truths:
    - "dotconfigs deploy (no arg) deploys all configured plugins"
    - "dotconfigs deploy --dry-run shows what would happen without changing filesystem"
    - "dotconfigs deploy --force overwrites all files without prompting"
    - "Deploy over non-owned file prompts with overwrite/skip/backup/diff options"
    - "Deploy prints summary (created, updated, skipped, unchanged) even when nothing changed"
    - "Running dotconfigs deploy twice produces same result and prints summary both times"
    - "--dry-run takes precedence over --force when both specified"
  artifacts:
    - path: "plugins/claude/deploy.sh"
      provides: "plugin_claude_deploy with --dry-run, --force support and summary counters"
      contains: "dry_run"
    - path: "plugins/git/deploy.sh"
      provides: "plugin_git_deploy with --dry-run, --force support and summary counters"
      contains: "dry_run"
    - path: "lib/symlinks.sh"
      provides: "backup_and_link with diff option for conflict resolution"
      contains: "diff"
  key_links:
    - from: "dotconfigs:cmd_deploy"
      to: "plugins/*/deploy.sh:plugin_*_deploy"
      via: "flag passthrough from CLI to plugin deploy functions"
      pattern: "plugin_.*_deploy.*\\$"
    - from: "plugins/claude/deploy.sh:plugin_claude_deploy"
      to: "lib/symlinks.sh:backup_and_link"
      via: "conflict handling with diff option"
      pattern: "backup_and_link"
---

<objective>
Enhance deploy with --dry-run, --force, conflict diff, and deploy summary for idempotent operations.

Purpose: Makes deploy safe to run repeatedly (QUAL-03), handles conflicts gracefully (QUAL-04), supports preview mode (--dry-run) and automation (--force). Completes all deploy-related requirements.
Output: Enhanced plugin_claude_deploy(), plugin_git_deploy(), updated backup_and_link() with diff option
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-integration-and-polish/07-RESEARCH.md
@.planning/phases/07-integration-and-polish/07-02-SUMMARY.md

@lib/symlinks.sh
@dotconfigs
@plugins/claude/deploy.sh
@plugins/git/deploy.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add diff option to backup_and_link and update deploy flag routing</name>
  <files>lib/symlinks.sh, dotconfigs</files>
  <action>
    **Extend backup_and_link() in lib/symlinks.sh:**

    Add `[d]iff` option to the interactive conflict prompt:
    1. When conflict detected and interactive=true, show options: `[o]verwrite, [s]kip, [b]ackup, [d]iff`
    2. If user chooses `d|diff`: show `diff "$src" "$dest"` output (only when dest is a regular file), then re-prompt with `[o]verwrite, [s]kip, [b]ackup` (no recursive diff)
    3. Use `.bak` suffix per user decision (currently uses `.backup` — change to `.bak`): `${dest}.bak.$(date +%Y%m%d-%H%M%S)`

    Add a `--force` mode to backup_and_link: when a 5th argument "force" is passed, skip all prompts and overwrite directly (even non-owned files). This avoids needing --force logic in every plugin.

    Actually, cleaner approach: backup_and_link already has an `interactive` parameter. When interactive=false, it currently skips conflicts. Instead:
    - Add a new parameter or change semantics: interactive="force" means overwrite everything, interactive="false" means skip conflicts, interactive="true" means prompt.
    - This way plugins just pass the mode through.

    **Update cmd_deploy() in dotconfigs:**

    Ensure the deploy-all routing (from Plan 01) correctly parses flags before iterating plugins:
    1. Parse flags: --interactive, --force, --dry-run from the argument list
    2. Build a flags string/array to pass through to each plugin's deploy function
    3. If --dry-run: source lib/colours.sh init_colours for "(DRY RUN)" header
    4. If --force: set interactive mode to "force" (not just false)
    5. Default mode (no flags): interactive (prompt on conflicts)
    6. When deploying all: iterate discover_plugins, source each deploy.sh, call plugin_${plugin}_deploy with flags. Skip plugins that aren't configured (check .env has their keys).
    7. When deploying single plugin: same as before but with flag passthrough

    **Flag precedence rule:** --dry-run takes precedence over --force. If both specified, show what WOULD happen (including that --force would overwrite) but don't write.
  </action>
  <verify>
    1. `bash -n lib/symlinks.sh` — no syntax errors
    2. `bash -n dotconfigs` — no syntax errors
    3. `./dotconfigs deploy --help` or `./dotconfigs help deploy` — shows flags
  </verify>
  <done>
    backup_and_link supports diff option and force mode. cmd_deploy correctly parses --dry-run, --force, --interactive and passes to plugin deploy functions. Flag precedence: --dry-run overrides --force.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add --dry-run, --force, and summary counters to plugin deploy functions</name>
  <files>plugins/claude/deploy.sh, plugins/git/deploy.sh</files>
  <action>
    **Enhance plugin_claude_deploy() in plugins/claude/deploy.sh:**

    1. Update flag parsing to accept --dry-run, --force, --interactive (currently only --interactive)
    2. Add counter variables: files_created=0, files_updated=0, files_skipped=0, files_unchanged=0
    3. For each file operation:
       - If --dry-run: check state with check_file_state(), print "Would link/create/skip $name" based on state, increment appropriate counter. If file exists and not owned, print "Would prompt: conflict at $name (file exists, not managed)" or if --force also present "Would overwrite $name (--force)"
       - If not dry-run: perform actual operation, track result, increment counter
       - For backup_and_link calls: pass interactive mode ("true"/"false"/"force") based on flags
    4. Add summary block at end (ALWAYS printed, even when nothing changed):
       ```
       Deploy summary:
         Created: N
         Updated: N
         Skipped: N
         Unchanged: N
       ```
    5. If dry-run, append: "Dry run complete. Run without --dry-run to apply changes."

    **Enhance plugin_git_deploy() in plugins/git/deploy.sh:**

    1. Same flag parsing: --dry-run, --force, --interactive
    2. For git config operations:
       - If --dry-run: check current value vs expected, print "Would set user.name: X" or "Would update user.name: X -> Y" or "Unchanged: user.name"
       - If not dry-run: apply as currently done, but track counters
    3. For hooks:
       - If --dry-run and global scope: "Would copy commit-msg to global hooks dir", "Would set core.hooksPath: ..."
       - If not dry-run: proceed as normal
    4. --force for git: suppress the drift confirmation prompt (currently asks "Deploy will overwrite. Continue?"). With --force, skip that prompt and deploy directly.
    5. Print summary at end (same format as Claude plugin)

    **Idempotency detail:** When deploying symlinks that already point to the correct target, report as "Unchanged" (not "Updated"). Use check_file_state to detect: if "deployed", it's unchanged. If "not-deployed" or "drifted-*", it needs action.

    **User decision compliance:**
    - Always print summary even when nothing changed
    - --dry-run shows what deploy WOULD do
    - --force bypasses all prompts
    - --dry-run takes precedence over --force
  </action>
  <verify>
    1. `bash -n plugins/claude/deploy.sh` — no syntax errors
    2. `bash -n plugins/git/deploy.sh` — no syntax errors
    3. `./dotconfigs deploy claude --dry-run` — shows what would be deployed without making changes
    4. `./dotconfigs deploy claude` — deploys and shows summary
    5. `./dotconfigs deploy claude` (run again) — shows summary with Unchanged counts
    6. `./dotconfigs deploy --dry-run` — shows all plugins dry-run
    7. `./dotconfigs deploy git --force` — deploys git without drift prompt
  </verify>
  <done>
    Both plugin deploy functions support --dry-run (preview), --force (no prompts), and print operation summary. Running deploy twice is safe and shows "Unchanged" counts. Conflict detection prompts include diff option.
  </done>
</task>

</tasks>

<verification>
1. `./dotconfigs deploy claude --dry-run` — previews Claude deployment
2. `./dotconfigs deploy git --dry-run` — previews Git deployment
3. `./dotconfigs deploy --dry-run` — previews ALL plugins
4. `./dotconfigs deploy claude` then `./dotconfigs deploy claude` — second run shows Unchanged, summary printed both times
5. `./dotconfigs deploy --force` — deploys all without prompts
6. `./dotconfigs deploy --dry-run --force` — dry-run takes precedence, no writes
7. Conflict scenario: create a regular file at a deploy target, run deploy — gets prompted with overwrite/skip/backup/diff
</verification>

<success_criteria>
- --dry-run shows preview for all deploy operations without filesystem changes
- --force bypasses all prompts and overwrites
- Deploy summary always printed (created/updated/skipped/unchanged)
- Idempotent: second deploy shows Unchanged counts
- Conflicts prompt with overwrite/skip/backup/diff options
- --dry-run overrides --force when both present
</success_criteria>

<output>
After completion, create `.planning/phases/07-integration-and-polish/07-03-SUMMARY.md`
</output>
