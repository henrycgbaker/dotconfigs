---
phase: 08-hooks-workflows-review
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - plugins/git/hooks/pre-commit
  - plugins/git/hooks/prepare-commit-msg
  - plugins/git/hooks/post-merge
  - plugins/git/hooks/post-checkout
  - plugins/git/hooks/post-rewrite
autonomous: true

must_haves:
  truths:
    - "pre-commit hook detects secrets, large files, and debug statements independently"
    - "prepare-commit-msg extracts conventional commit prefix from branch name"
    - "post-merge detects dependency file changes and reminds user"
    - "post-checkout displays branch info on switch"
    - "post-rewrite handles same checks as post-merge for rebase scenarios"
    - "Every check in every hook is independently configurable"
    - "All hooks respect the _ENABLED toggle to be completely disabled"
  artifacts:
    - path: "plugins/git/hooks/pre-commit"
      provides: "Secrets detection, large file warning, debug statement detection"
      contains: "GIT_HOOK_SECRETS_CHECK"
    - path: "plugins/git/hooks/prepare-commit-msg"
      provides: "Branch-based conventional commit prefix extraction"
      contains: "GIT_HOOK_BRANCH_PREFIX"
    - path: "plugins/git/hooks/post-merge"
      provides: "Dependency change detection and migration reminder"
      contains: "GIT_HOOK_DEPENDENCY_CHECK"
    - path: "plugins/git/hooks/post-checkout"
      provides: "Branch info display on checkout"
      contains: "GIT_HOOK_BRANCH_INFO"
    - path: "plugins/git/hooks/post-rewrite"
      provides: "Dependency detection for rebase workflows"
      contains: "GIT_HOOK_DEPENDENCY_CHECK"
  key_links:
    - from: "plugins/git/hooks/pre-commit"
      to: "config file"
      via: "source with defaults"
      pattern: "GIT_HOOK_PRE_COMMIT_ENABLED"
---

<objective>
Create five new git hook scripts covering the full practical hook roster: pre-commit, prepare-commit-msg, post-merge, post-checkout, and post-rewrite.

Purpose: Expanding from 2 hooks (commit-msg, pre-push) to 7 hooks provides comprehensive coverage of the git workflow. Each hook addresses a specific workflow stage and all checks are independently configurable per the "everything configurable with opinionated defaults" design principle.

Output: Five new executable hook scripts in plugins/git/hooks/, all using the unified GIT_HOOK_* naming convention from Plan 01.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-hooks-workflows-review/08-RESEARCH.md
@.planning/phases/08-hooks-workflows-review/08-01-SUMMARY.md
@plugins/git/hooks/commit-msg
@lib/config.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pre-commit hook</name>
  <files>plugins/git/hooks/pre-commit</files>
  <action>
Create `plugins/git/hooks/pre-commit` — runs before commit is created.

**Structure (follow same pattern as refactored commit-msg from Plan 01):**

1. Metadata header:
```bash
# === METADATA ===
# NAME: pre-commit
# TYPE: git-hook
# PLUGIN: git
# DESCRIPTION: Pre-commit checks — secrets detection, large file warnings, debug statement detection
# CONFIGURABLE: GIT_HOOK_PRE_COMMIT_ENABLED, GIT_HOOK_SECRETS_CHECK, GIT_HOOK_LARGE_FILE_CHECK, GIT_HOOK_LARGE_FILE_THRESHOLD, GIT_HOOK_DEBUG_CHECK, GIT_HOOK_DEBUG_CHECK_STRICT
# ================
```

2. Config loading (same multi-path pattern as commit-msg):
   - Try: `.githooks/config`, `.claude/git-hooks.conf`, `.git/hooks/hooks.conf`, `.claude/hooks.conf`
   - Defaults: all checks enabled, threshold 1MB, debug non-strict

3. `GIT_HOOK_PRE_COMMIT_ENABLED` check — exit 0 if disabled

4. **Secrets detection** (when `GIT_HOOK_SECRETS_CHECK=true`):
   - Check staged diff (`git diff --cached --diff-filter=ACM`) for:
     - AWS access keys: `AKIA[0-9A-Z]{16}`
     - API key assignments: `["\']?[Aa]pi[_-]?[Kk]ey["\']?\s*[:=]\s*["\'][^"\']{8,}["\']`
     - Secret assignments: `["\']?[Ss]ecret["\']?\s*[:=]\s*["\'][^"\']{8,}["\']`
     - Stripe keys: `(sk|pk)_(test|live)_[a-zA-Z0-9]{24,}`
     - Google API keys: `AIza[0-9A-Za-z\\-_]{35}`
     - Private keys: `-----BEGIN (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----`
   - Hard block (exit 1) with clear message and `--no-verify` escape hatch reminder
   - Note in message: "If this is a false positive, use: git commit --no-verify"

5. **Large file detection** (when `GIT_HOOK_LARGE_FILE_CHECK=true`):
   - For each staged file (`git diff --cached --name-only --diff-filter=ACM`):
     - Skip if file doesn't exist (deleted files)
     - Get size with `wc -c < "$file"` (portable, not stat)
     - Warn if >= `GIT_HOOK_LARGE_FILE_THRESHOLD` (default 1048576 = 1MB)
   - Warning only (don't block), show size in human-readable format

6. **Debug statement detection** (when `GIT_HOOK_DEBUG_CHECK=true`):
   - Check staged diff for:
     - JavaScript: `console\.(log|debug|info|warn|error)`, `debugger;`
     - Python: `pdb\.set_trace`, `breakpoint()`, `print(` (with context check — only in .py files)
     - Ruby: `binding\.pry`
   - When `GIT_HOOK_DEBUG_CHECK_STRICT=false` (default): warn only
   - When `GIT_HOOK_DEBUG_CHECK_STRICT=true`: block (exit 1)

**Bash 3.2 requirements:** No namerefs, no associative arrays. Use simple variables and indexed arrays only.
  </action>
  <verify>
- `bash -n plugins/git/hooks/pre-commit` passes
- `grep '=== METADATA ===' plugins/git/hooks/pre-commit` finds metadata
- `grep -c 'GIT_HOOK_' plugins/git/hooks/pre-commit` returns 6+ (all config vars used)
- `grep -E 'local -n|declare -n|declare -A' plugins/git/hooks/pre-commit` returns nothing
- `grep 'wc -c' plugins/git/hooks/pre-commit` confirms portable file size check
- `grep 'no-verify' plugins/git/hooks/pre-commit` confirms escape hatch documented
  </verify>
  <done>pre-commit hook exists with three independent checks (secrets, large files, debug statements), all configurable, bash 3.2 compatible, with metadata header.</done>
</task>

<task type="auto">
  <name>Task 2: Create prepare-commit-msg hook</name>
  <files>plugins/git/hooks/prepare-commit-msg</files>
  <action>
Create `plugins/git/hooks/prepare-commit-msg` — runs after default message is created but before editor opens.

**Structure:**

1. Metadata header:
```bash
# === METADATA ===
# NAME: prepare-commit-msg
# TYPE: git-hook
# PLUGIN: git
# DESCRIPTION: Prepends conventional commit prefix based on branch name
# CONFIGURABLE: GIT_HOOK_PREPARE_COMMIT_MSG_ENABLED, GIT_HOOK_BRANCH_PREFIX
# ================
```

2. Standard config loading (same pattern as other hooks)

3. `GIT_HOOK_PREPARE_COMMIT_MSG_ENABLED` check

4. Arguments: `$1` = commit message file, `$2` = commit source (message, template, merge, squash, commit)

5. **Skip conditions** (exit 0 immediately):
   - `$2` is non-empty (merge, squash, amend, template — don't modify)
   - Message already starts with a conventional commit prefix pattern: `^(feat|fix|docs|style|refactor|test|chore|build|ci|perf|revert)(\(.*\))?(!)?:`

6. **Branch prefix extraction** (when `GIT_HOOK_BRANCH_PREFIX=true`):
   - Get branch name: `git symbolic-ref --short HEAD 2>/dev/null`
   - Map branch to prefix using case statement:
     ```
     feature/*|feat/*  → "feat: "
     fix/*|bugfix/*|hotfix/*  → "fix: "
     docs/*  → "docs: "
     refactor/*  → "refactor: "
     test/*  → "test: "
     chore/*  → "chore: "
     style/*  → "style: "
     perf/*  → "perf: "
     ```
   - If prefix found, prepend to commit message file: `echo "${PREFIX}${COMMIT_MSG}" > "$1"`
   - If no matching branch pattern, do nothing (exit 0)

**Critical edge cases:**
- Don't double-prefix if message already has conventional format
- Don't modify during amend (`$2 = commit`)
- Don't modify during merge/squash
- Handle detached HEAD gracefully (no branch name → skip)
  </action>
  <verify>
- `bash -n plugins/git/hooks/prepare-commit-msg` passes
- `grep '=== METADATA ===' plugins/git/hooks/prepare-commit-msg` finds metadata
- `grep 'COMMIT_SOURCE' plugins/git/hooks/prepare-commit-msg` confirms source checking
- `grep -E 'local -n|declare -n' plugins/git/hooks/prepare-commit-msg` returns nothing
  </verify>
  <done>prepare-commit-msg hook extracts branch prefix to conventional commit format, skips amend/merge/squash, handles edge cases.</done>
</task>

<task type="auto">
  <name>Task 3: Create post-merge, post-checkout, and post-rewrite hooks</name>
  <files>plugins/git/hooks/post-merge, plugins/git/hooks/post-checkout, plugins/git/hooks/post-rewrite</files>
  <action>
Create three informational hooks. These hooks never block (always exit 0) — they only display helpful information.

**post-merge** (`plugins/git/hooks/post-merge`):

Metadata:
```bash
# === METADATA ===
# NAME: post-merge
# TYPE: git-hook
# PLUGIN: git
# DESCRIPTION: Detects dependency and migration changes after merge
# CONFIGURABLE: GIT_HOOK_POST_MERGE_ENABLED, GIT_HOOK_DEPENDENCY_CHECK, GIT_HOOK_MIGRATION_REMINDER
# ================
```

Arguments: `$1` = squash flag (1 if squash merge, 0 otherwise)
Changed files: `git diff-tree -r --name-only --no-commit-id HEAD@{1} HEAD 2>/dev/null`

Checks (when enabled):
1. **Dependency changes** (`GIT_HOOK_DEPENDENCY_CHECK=true`):
   - JavaScript: `package.json|package-lock.json|yarn.lock|pnpm-lock.yaml` → "Run: npm install"
   - Python: `requirements.txt|Pipfile|Pipfile.lock|pyproject.toml` → "Run: pip install -r requirements.txt"
   - Ruby: `Gemfile|Gemfile.lock` → "Run: bundle install"
   - Go: `go.mod|go.sum` → "Run: go mod download"

2. **Migration changes** (`GIT_HOOK_MIGRATION_REMINDER=true`):
   - `migrations/|db/migrate/|alembic/` → "Database migrations changed — check if you need to run migrations"
   - `schema.prisma` → "Prisma schema changed — run: npx prisma db push"

**post-checkout** (`plugins/git/hooks/post-checkout`):

Metadata:
```bash
# === METADATA ===
# NAME: post-checkout
# TYPE: git-hook
# PLUGIN: git
# DESCRIPTION: Displays branch info after checkout
# CONFIGURABLE: GIT_HOOK_POST_CHECKOUT_ENABLED, GIT_HOOK_BRANCH_INFO
# ================
```

Arguments: `$1` = previous HEAD, `$2` = new HEAD, `$3` = branch checkout flag (1) vs file checkout (0)

Only run when `$3 = 1` (branch checkout, not file checkout).

When `GIT_HOOK_BRANCH_INFO=true`:
- Show branch name: `git symbolic-ref --short HEAD`
- Show last commit: `git log -1 --oneline`
- Show branch type hint based on name pattern (feature → "Feature branch", fix → "Bugfix branch", etc.)

**post-rewrite** (`plugins/git/hooks/post-rewrite`):

Metadata:
```bash
# === METADATA ===
# NAME: post-rewrite
# TYPE: git-hook
# PLUGIN: git
# DESCRIPTION: Detects dependency changes after rebase/amend (same checks as post-merge)
# CONFIGURABLE: GIT_HOOK_POST_REWRITE_ENABLED, GIT_HOOK_DEPENDENCY_CHECK, GIT_HOOK_MIGRATION_REMINDER
# ================
```

Arguments: `$1` = command that caused rewrite ("amend" or "rebase")
Stdin: lines of "old-sha new-sha" pairs

Only check on rebase (not amend — amend rarely changes dependencies).
Use first old-sha and last new-sha to compute diff: `git diff --name-only $first_old $last_new`
Run same dependency + migration checks as post-merge.

**All three hooks:** bash 3.2 compatible, never exit non-zero, always exit 0. These are informational only.
  </action>
  <verify>
- `bash -n plugins/git/hooks/post-merge && bash -n plugins/git/hooks/post-checkout && bash -n plugins/git/hooks/post-rewrite` passes
- `grep '=== METADATA ===' plugins/git/hooks/post-merge plugins/git/hooks/post-checkout plugins/git/hooks/post-rewrite` finds all three
- `ls plugins/git/hooks/ | wc -l` returns 7 (commit-msg, pre-push, pre-commit, prepare-commit-msg, post-merge, post-checkout, post-rewrite)
- `grep -E 'local -n|declare -n' plugins/git/hooks/post-*` returns nothing
- All three hooks end with `exit 0`
  </verify>
  <done>post-merge, post-checkout, and post-rewrite hooks created with independent configurable checks, metadata headers, bash 3.2 compatible, informational only (never block).</done>
</task>

</tasks>

<verification>
1. `for f in plugins/git/hooks/*; do bash -n "$f"; done` — all hooks pass syntax check
2. `ls plugins/git/hooks/ | sort` shows: commit-msg, post-checkout, post-merge, post-rewrite, pre-commit, pre-push, prepare-commit-msg
3. `grep -rE 'local -n|declare -n|declare -A' plugins/git/hooks/` returns nothing
4. Every hook has `# === METADATA ===` block
5. Every hook has an `_ENABLED` check at the top
</verification>

<success_criteria>
- 5 new hook scripts created (total 7 hooks in git plugin)
- All hooks use unified GIT_HOOK_* naming
- Every check is independently configurable with opinionated defaults
- All hooks have metadata headers for auto-documentation
- Bash 3.2 compatible (no namerefs, no associative arrays)
- Informational hooks (post-*) never block — always exit 0
</success_criteria>

<output>
After completion, create `.planning/phases/08-hooks-workflows-review/08-03-SUMMARY.md`
</output>
