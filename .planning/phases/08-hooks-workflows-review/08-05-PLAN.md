---
phase: 08-hooks-workflows-review
plan: 05
type: execute
wave: 3
depends_on: ["08-01", "08-03", "08-04"]
files_modified:
  - plugins/git/setup.sh
  - plugins/git/deploy.sh
  - plugins/git/project.sh
  - plugins/claude/project.sh
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Git setup wizard presents full hook roster as a menu with per-hook enable/disable"
    - "Git setup wizard includes config file location selection with presets"
    - "Git deploy deploys all 7 hooks (not just 2)"
    - "Git project wizard shows hook roster pre-filled from global defaults"
    - "Claude project wizard deploys PreToolUse hook and claude-hooks.conf"
    - ".env.example documents all new GIT_HOOK_* and CLAUDE_HOOK_* variables"
    - "Project config path stored in .dotconfigs.json"
    - "Existing profile selection in claude project.sh replaced with individual settings"
  artifacts:
    - path: "plugins/git/setup.sh"
      provides: "Expanded hook wizard with full roster"
      contains: "GIT_HOOK_PRE_COMMIT_ENABLED"
    - path: "plugins/git/deploy.sh"
      provides: "Deploy logic for all 7 hooks"
      contains: "pre-commit"
    - path: "plugins/git/project.sh"
      provides: "Project wizard with hook roster and config location"
      contains: "git-hooks.conf"
    - path: "plugins/claude/project.sh"
      provides: "Claude project wizard deploying PreToolUse hook"
      contains: "block-destructive"
    - path: ".env.example"
      provides: "Complete configuration reference"
      contains: "GIT_HOOK_SECRETS_CHECK"
  key_links:
    - from: "plugins/git/setup.sh"
      to: "plugins/git/deploy.sh"
      via: ".env variables"
      pattern: "GIT_HOOK_"
    - from: "plugins/git/project.sh"
      to: "plugins/git/hooks/"
      via: "hook deployment loop"
      pattern: "PLUGIN_DIR/hooks"
---

<objective>
Wire all new hooks and config architecture into the setup wizard, deploy logic, and project commands for both plugins.

Purpose: Hooks exist as scripts but aren't integrated into the CLI workflow yet. This plan connects them to the user-facing commands so users can configure, deploy, and manage the full hook roster through the established wizard/deploy/project pattern.

Output: Setup wizard shows full roster, deploy handles all 7 hooks, project wizard deploys per-project with config location selection, .env.example is complete.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-hooks-workflows-review/08-01-SUMMARY.md
@.planning/phases/08-hooks-workflows-review/08-03-SUMMARY.md
@.planning/phases/08-hooks-workflows-review/08-04-SUMMARY.md
@plugins/git/setup.sh
@plugins/git/deploy.sh
@plugins/git/project.sh
@plugins/claude/project.sh
@lib/config.sh
@dotconfigs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand git setup wizard with full hook roster</name>
  <files>plugins/git/setup.sh</files>
  <action>
Expand `_git_wizard_hooks()` in `plugins/git/setup.sh` to present the full hook roster and config file location.

**Replace the current hooks section (4 settings: scope, protection, conventional commits) with:**

1. **Hook scope** — keep existing (project vs global)

2. **Git hook config file location** — NEW wizard step:
   - Only shown when scope is "project" (global hooks don't need per-project config)
   - Present preset options using `select`:
     ```
     Select git hook config file location:
     1) .githooks/config
     2) .claude/git-hooks.conf
     3) .git/hooks/hooks.conf
     4) Specify custom path
     ```
   - Store selection in `GIT_HOOK_CONFIG_PATH` variable
   - Default: `.githooks/config`
   - If "Specify custom path", use `wizard_prompt` to get the path

3. **Hook roster menu** — show each hook with toggle:
   ```
   Git hooks (enable/disable each):

   Pre-commit checks:
     ✓ Secrets detection (hard block)              [Y/n]
     ✓ Large file warning (> 1MB)                   [Y/n]
     ✓ Debug statement detection (warn)             [Y/n]

   Commit message:
     ✓ AI attribution blocking                     [Y/n]
     ✓ WIP blocking on main                        [Y/n]
     ✓ Conventional commit format (soft warn)       [Y/n]

   Branch protection:
     Pre-push: warn | block | off                  [select]

   Prepare-commit-msg:
     ✓ Branch-based prefix extraction               [Y/n]

   Post-merge/rebase:
     ✓ Dependency change detection                  [Y/n]
     ✓ Migration file reminder                      [Y/n]

   Post-checkout:
     ✓ Branch info display                          [Y/n]
   ```
   - Use `wizard_yesno` for each boolean toggle
   - Use `select` for protection level (keep existing pattern)
   - Pre-fill from existing .env values with defaults ON for most settings
   - Store all settings in GIT_HOOK_* variables

4. **Advanced settings submenu** (only if user opts in):
   - `GIT_HOOK_CONVENTIONAL_COMMITS_STRICT` (default false — hard block vs soft warn)
   - `GIT_HOOK_DEBUG_CHECK_STRICT` (default false)
   - `GIT_HOOK_LARGE_FILE_THRESHOLD` (default 1048576, prompt for custom value)
   - `GIT_HOOK_MAX_SUBJECT_LENGTH` (default 72)

**Update `_git_save_config()`** to save all new GIT_HOOK_* variables to .env.

**Update the summary display** (option 6) to show all hook settings.

**Rename `GIT_HOOK_PREPUSH_PROTECTION`** references to `GIT_HOOK_BRANCH_PROTECTION` throughout setup.sh (unified naming from Plan 01).

**Maintain all existing identity, workflow, and aliases sections unchanged.**
  </action>
  <verify>
- `bash -n plugins/git/setup.sh` passes
- `grep 'GIT_HOOK_PRE_COMMIT_ENABLED\|GIT_HOOK_SECRETS_CHECK\|GIT_HOOK_CONFIG_PATH' plugins/git/setup.sh` finds new settings
- `grep 'PREPUSH_PROTECTION' plugins/git/setup.sh` returns nothing (old name gone)
- `grep 'GIT_HOOK_BRANCH_PROTECTION' plugins/git/setup.sh` finds new name
- `grep -c 'wizard_save_env.*GIT_HOOK' plugins/git/setup.sh` returns 10+ (all hook vars saved)
- `grep -E 'local -n|declare -n' plugins/git/setup.sh` returns nothing
  </verify>
  <done>Git setup wizard presents full hook roster with per-hook toggles, config file location selection, advanced settings submenu. All settings saved to .env.</done>
</task>

<task type="auto">
  <name>Task 2: Update git deploy and project commands</name>
  <files>plugins/git/deploy.sh, plugins/git/project.sh</files>
  <action>
**Deploy updates (`plugins/git/deploy.sh`):**

1. The hook deployment loop already deploys all files from `$PLUGIN_DIR/hooks/`. Since Plan 03 added the new hook files to that directory, the global deploy should work automatically.

2. **Rename `GIT_HOOK_PREPUSH_PROTECTION`** references to `GIT_HOOK_BRANCH_PROTECTION` in deploy.sh. Check both `_git_detect_drift()` and `plugin_git_status()`.

3. **Add new hook config variables** to the status command (`plugin_git_status()`):
   - Show enabled/disabled status for each hook category
   - No need for per-setting drift (hooks are file-based, not git-config-based)

4. **Update the hooks section** of deploy to show which hooks are being deployed:
   ```
   Hooks:
     ✓ Deployed commit-msg
     ✓ Deployed pre-commit
     ✓ Deployed pre-push
     ✓ Deployed prepare-commit-msg
     ✓ Deployed post-merge
     ✓ Deployed post-checkout
     ✓ Deployed post-rewrite
   ```
   Deploy only hooks whose `_ENABLED` flag is true (or not set, defaulting to true). Skip disabled hooks.

**Project updates (`plugins/git/project.sh`):**

1. **Hook roster in project wizard** — After deploying hooks to .git/hooks/, show which hooks were deployed

2. **Config file deployment** — NEW:
   - Read `GIT_HOOK_CONFIG_PATH` from .env (or use default `.githooks/config`)
   - Generate a config file at the selected location with all GIT_HOOK_* settings
   - Pre-fill from global .env defaults
   - If file exists, show current values and ask to overwrite
   - Config file format: bash-sourceable key=value (same as .env pattern)
   - Add header comment: `# Git hook configuration — deployed by dotconfigs project`

3. **Replace the hooks.conf reference** — Step 3 currently says "dotconfigs project claude" for hooks.conf. Replace with direct git hook config deployment since git hooks now own their own config.

4. **Update .dotconfigs.json** — Save `git_hook_config_path` to the plugins.git section:
   ```json
   {
     "plugins": {
       "git": {
         "hook_config_path": ".githooks/config"
       }
     }
   }
   ```

**Bash 3.2 requirements:** No namerefs. Use the eval pattern from existing code for counter tracking.
  </action>
  <verify>
- `bash -n plugins/git/deploy.sh && bash -n plugins/git/project.sh` passes
- `grep 'PREPUSH_PROTECTION' plugins/git/deploy.sh` returns nothing (old name gone)
- `grep 'GIT_HOOK_BRANCH_PROTECTION' plugins/git/deploy.sh` finds new name
- `grep 'GIT_HOOK_CONFIG_PATH\|hook_config_path' plugins/git/project.sh` finds config path handling
- `grep -E 'local -n|declare -n' plugins/git/deploy.sh plugins/git/project.sh` returns nothing
  </verify>
  <done>Git deploy handles all 7 hooks with enable/disable filtering. Git project deploys hooks + generates config file at user-selected location. .dotconfigs.json extended with git config path.</done>
</task>

<task type="auto">
  <name>Task 3: Update claude project + .env.example</name>
  <files>plugins/claude/project.sh, .env.example</files>
  <action>
**Claude project updates (`plugins/claude/project.sh`):**

1. **Replace hooks.conf profile selection** (Step 2) with individual settings:
   - Remove the `select profile in "default" "strict" "permissive"` pattern
   - Instead, show individual Claude hook toggles:
     ```
     Claude hook settings:
       ✓ Ruff auto-formatting           [Y/n]
       ✓ Destructive command guard       [Y/n]
       ✓ File pattern protection         [Y/n]
     ```
   - Save as `claude-hooks.conf` (not hooks.conf) under `.claude/`:
     ```bash
     # Claude hook configuration — deployed by dotconfigs project
     CLAUDE_HOOK_RUFF_FORMAT=true
     CLAUDE_HOOK_DESTRUCTIVE_GUARD=true
     CLAUDE_HOOK_FILE_PROTECTION=true
     ```

2. **Deploy PreToolUse hook** — NEW step:
   - Copy `block-destructive.sh` from plugin hooks dir to `.claude/hooks/`
   - Make it executable
   - Only deploy if `CLAUDE_HOOK_DESTRUCTIVE_GUARD=true` or `CLAUDE_HOOK_FILE_PROTECTION=true`

3. **Deploy hooks.json settings overlay** — Merge hooks template into `.claude/settings.json`:
   - Use existing `_claude_merge_settings_json` to merge `plugins/claude/templates/settings/hooks.json` into the project's settings.json
   - Only merge if PreToolUse hooks are enabled

4. **Update .dotconfigs.json** — Save claude hook config to plugins.claude section

**Update `.env.example`:**

Add all new GIT_HOOK_* and CLAUDE_HOOK_* variables with descriptions and defaults. Organise by section:

```bash
# ═══════════════════════════════════════════════════════════
# Git Hooks — Per-hook enable/disable
# ═══════════════════════════════════════════════════════════
# GIT_HOOK_COMMIT_MSG_ENABLED=true
# GIT_HOOK_PRE_PUSH_ENABLED=true
# GIT_HOOK_PRE_COMMIT_ENABLED=true
# ... etc for all hooks

# ═══════════════════════════════════════════════════════════
# Git Hooks — Pre-commit checks
# ═══════════════════════════════════════════════════════════
# GIT_HOOK_SECRETS_CHECK=true          # Detect secrets/credentials in staged changes
# GIT_HOOK_LARGE_FILE_CHECK=true       # Warn on large files (> threshold)
# GIT_HOOK_LARGE_FILE_THRESHOLD=1048576  # Threshold in bytes (default 1MB)
# ... etc

# ═══════════════════════════════════════════════════════════
# Claude Hooks
# ═══════════════════════════════════════════════════════════
# CLAUDE_HOOK_DESTRUCTIVE_GUARD=true   # Block destructive CLI commands
# CLAUDE_HOOK_FILE_PROTECTION=true     # Protect sensitive file paths
# CLAUDE_HOOK_RUFF_FORMAT=true         # Auto-format Python files with Ruff
```

Keep existing CLAUDE_* and GIT_* sections. Add the new hook sections after them. Add deprecation note for old variable names:
```bash
# DEPRECATED: Use GIT_HOOK_BRANCH_PROTECTION instead of GIT_HOOK_PREPUSH_PROTECTION
```
  </action>
  <verify>
- `bash -n plugins/claude/project.sh` passes
- `grep 'profile.*default.*strict.*permissive' plugins/claude/project.sh` returns nothing (profiles gone)
- `grep 'CLAUDE_HOOK_DESTRUCTIVE_GUARD\|CLAUDE_HOOK_FILE_PROTECTION\|CLAUDE_HOOK_RUFF_FORMAT' plugins/claude/project.sh` finds new settings
- `grep 'block-destructive' plugins/claude/project.sh` finds hook deployment
- `grep 'GIT_HOOK_SECRETS_CHECK' .env.example` finds new variable documentation
- `grep 'CLAUDE_HOOK_DESTRUCTIVE_GUARD' .env.example` finds claude hook documentation
- `grep 'DEPRECATED' .env.example` finds deprecation notice
- `grep -E 'local -n|declare -n' plugins/claude/project.sh` returns nothing
  </verify>
  <done>Claude project wizard deploys PreToolUse hook and claude-hooks.conf with individual settings (no profiles). .env.example documents all new variables with descriptions and defaults.</done>
</task>

</tasks>

<verification>
1. `bash -n plugins/git/setup.sh && bash -n plugins/git/deploy.sh && bash -n plugins/git/project.sh && bash -n plugins/claude/project.sh` — all pass
2. `grep -rE 'PREPUSH_PROTECTION' plugins/` returns nothing (fully renamed)
3. `grep -rE 'local -n|declare -n|declare -A' plugins/` returns nothing
4. `grep -c 'GIT_HOOK_' .env.example` returns 15+ (all hook vars documented)
5. `grep -c 'CLAUDE_HOOK_' .env.example` returns 3+ (all claude hook vars documented)
</verification>

<success_criteria>
- Setup wizard shows full hook roster with per-hook toggles
- Deploy handles all 7 hooks with enable/disable filtering
- Project commands deploy hooks + generate per-project config files
- Claude project deploys PreToolUse hook and uses individual settings (no profiles)
- .env.example is complete reference for all config variables
- Variable naming unified (no old PREPUSH_PROTECTION references)
</success_criteria>

<output>
After completion, create `.planning/phases/08-hooks-workflows-review/08-05-SUMMARY.md`
</output>
