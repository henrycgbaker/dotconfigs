---
phase: 08-hooks-workflows-review
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/config.sh
  - plugins/git/hooks/commit-msg
  - plugins/git/hooks/pre-push
  - plugins/claude/templates/hooks-conf/default.conf
  - plugins/claude/templates/hooks-conf/strict.conf
  - plugins/claude/templates/hooks-conf/permissive.conf
autonomous: true

must_haves:
  truths:
    - "Every hook setting is configurable via env var with opinionated default"
    - "Variable naming is consistent: GIT_HOOK_* for git hooks, CLAUDE_HOOK_* for claude hooks"
    - "Config loading follows hierarchy: project config > global .env > hardcoded defaults"
    - "AI attribution blocking is configurable (strong default ON) — no longer hardcoded"
    - "WIP blocking is configurable with strong default ON"
    - "hooks.conf profile templates are removed"
  artifacts:
    - path: "lib/config.sh"
      provides: "Shared config loading helper for hooks"
      contains: "load_hook_config"
    - path: "plugins/git/hooks/commit-msg"
      provides: "Refactored commit-msg hook with unified config"
      contains: "GIT_HOOK_BLOCK_AI_ATTRIBUTION"
    - path: "plugins/git/hooks/pre-push"
      provides: "Refactored pre-push hook with unified naming"
      contains: "GIT_HOOK_BRANCH_PROTECTION"
  key_links:
    - from: "plugins/git/hooks/commit-msg"
      to: "lib/config.sh"
      via: "config loading pattern"
      pattern: "GIT_HOOK_"
---

<objective>
Establish the unified configuration architecture for all hooks across both plugins, refactor existing hooks to use it, and remove deprecated profile templates.

Purpose: This is the foundation plan — all subsequent hook work depends on the variable naming convention and config loading pattern established here. Without unified naming and a clear config hierarchy, new hooks would use inconsistent patterns.

Output: Shared config loading library, refactored commit-msg and pre-push hooks using unified GIT_HOOK_* naming, profiles removed.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-hooks-workflows-review/08-RESEARCH.md
@lib/wizard.sh
@lib/colours.sh
@plugins/git/hooks/commit-msg
@plugins/git/hooks/pre-push
@plugins/claude/templates/hooks-conf/default.conf
@dotconfigs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared config loading library and define unified variable naming</name>
  <files>lib/config.sh, dotconfigs</files>
  <action>
Create `lib/config.sh` with a shared config loading helper function and unified variable naming documentation.

**Variable naming convention (Claude's discretion — chosen approach):**
- Git hook settings: `GIT_HOOK_*` prefix (unify the inconsistent BRANCH_PROTECTION vs GIT_HOOK_PREPUSH_PROTECTION)
- Claude hook settings: `CLAUDE_HOOK_*` prefix
- All boolean settings: `true`/`false` string values
- All hooks have an `_ENABLED` suffix for on/off toggle

**Unified variable names (complete roster):**

Git hooks — commit-msg:
- `GIT_HOOK_BLOCK_AI_ATTRIBUTION=true` (configurable now, strong default ON)
- `GIT_HOOK_WIP_BLOCK_ON_MAIN=true` (configurable, strong default ON)
- `GIT_HOOK_CONVENTIONAL_COMMITS=true` (was GIT_HOOK_CONVENTIONAL_COMMITS — keep same)
- `GIT_HOOK_CONVENTIONAL_COMMITS_STRICT=false` (soft warn by default, hard block when true)
- `GIT_HOOK_MAX_SUBJECT_LENGTH=72` (configurable subject line length)

Git hooks — pre-push:
- `GIT_HOOK_BRANCH_PROTECTION=warn` (replaces GIT_HOOK_PREPUSH_PROTECTION — cleaner name)

Git hooks — pre-commit (new, for Plan 03):
- `GIT_HOOK_SECRETS_CHECK=true`
- `GIT_HOOK_LARGE_FILE_CHECK=true`
- `GIT_HOOK_LARGE_FILE_THRESHOLD=1048576`
- `GIT_HOOK_DEBUG_CHECK=true`
- `GIT_HOOK_DEBUG_CHECK_STRICT=false`

Git hooks — prepare-commit-msg (new, for Plan 03):
- `GIT_HOOK_BRANCH_PREFIX=true`

Git hooks — post-merge (new, for Plan 03):
- `GIT_HOOK_DEPENDENCY_CHECK=true`
- `GIT_HOOK_MIGRATION_REMINDER=true`

Git hooks — post-checkout (new, for Plan 03):
- `GIT_HOOK_BRANCH_INFO=true`

Per-hook enable/disable:
- `GIT_HOOK_COMMIT_MSG_ENABLED=true`
- `GIT_HOOK_PRE_PUSH_ENABLED=true`
- `GIT_HOOK_PRE_COMMIT_ENABLED=true`
- `GIT_HOOK_PREPARE_COMMIT_MSG_ENABLED=true`
- `GIT_HOOK_POST_MERGE_ENABLED=true`
- `GIT_HOOK_POST_CHECKOUT_ENABLED=true`
- `GIT_HOOK_POST_REWRITE_ENABLED=true`

Claude hooks:
- `CLAUDE_HOOK_DESTRUCTIVE_GUARD=true`
- `CLAUDE_HOOK_FILE_PROTECTION=true`
- `CLAUDE_HOOK_RUFF_FORMAT=true` (replaces RUFF_ENABLED)

**Create `lib/config.sh`** with:
1. A function `load_git_hook_config()` that takes a config file path and loads it with the standard pattern: hardcoded defaults → env var override → config file override
2. A function `_config_resolve()` that resolves a single variable: checks config file value, then env var, then default
3. Comment block at top documenting the complete variable reference

This file follows the same pattern as other lib/ files: no shebang (sourced, not executed).

**Update `dotconfigs` entry point** to source `lib/config.sh` alongside the other lib files.

Note: The hooks themselves will NOT source lib/config.sh (hooks run from .git/hooks/ or ~/.dotconfigs/git-hooks/, not from the dotconfigs repo). Instead, lib/config.sh provides the SSOT documentation and helper functions used by setup/deploy. The hooks use inline config loading (source the config file directly) per the research patterns.
  </action>
  <verify>
- `bash -n lib/config.sh` passes (syntax check)
- `grep -c 'GIT_HOOK_' lib/config.sh` returns 15+ (all variables documented)
- `grep 'source.*config.sh' dotconfigs` confirms it's sourced
- `grep -E 'local -n|declare -n|declare -A' lib/config.sh` returns nothing (bash 3.2 safe)
  </verify>
  <done>lib/config.sh exists with load_git_hook_config function and complete variable reference. dotconfigs sources it. No bash 4+ features used.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor commit-msg hook to unified config pattern</name>
  <files>plugins/git/hooks/commit-msg</files>
  <action>
Refactor the existing commit-msg hook to use the unified variable naming from Task 1.

**Changes:**
1. Replace `BLOCK_AI_ATTRIBUTION=true` (hardcoded, can't be disabled) with `GIT_HOOK_BLOCK_AI_ATTRIBUTION` defaulting to `true` but now actually configurable — remove the forced re-set after sourcing config
2. Replace `CONVENTIONAL_COMMITS` with `GIT_HOOK_CONVENTIONAL_COMMITS`
3. Add `GIT_HOOK_CONVENTIONAL_COMMITS_STRICT` — when true, non-conventional commits on main are blocked (exit 1); when false (default), they get a warning only (current behaviour)
4. Add `GIT_HOOK_WIP_BLOCK_ON_MAIN` — configurable WIP blocking (default true)
5. Add `GIT_HOOK_MAX_SUBJECT_LENGTH` — configurable subject line length (default 72)
6. Add `GIT_HOOK_COMMIT_MSG_ENABLED` check at top — if false, exit 0 immediately
7. Update config file discovery: try multiple paths in order:
   - `$REPO_ROOT/.githooks/config`
   - `$REPO_ROOT/.claude/git-hooks.conf`
   - `$REPO_ROOT/.git/hooks/hooks.conf`
   - Fall back to `$REPO_ROOT/.claude/hooks.conf` for backwards compatibility
8. Keep the same AI attribution patterns list
9. Maintain bash 3.2 compatibility throughout
10. Update the header comment with metadata block for auto-documentation:
```bash
# === METADATA ===
# NAME: commit-msg
# TYPE: git-hook
# PLUGIN: git
# DESCRIPTION: Validates commit messages — AI attribution blocking and conventional commit enforcement
# CONFIGURABLE: GIT_HOOK_BLOCK_AI_ATTRIBUTION, GIT_HOOK_WIP_BLOCK_ON_MAIN, GIT_HOOK_CONVENTIONAL_COMMITS, GIT_HOOK_CONVENTIONAL_COMMITS_STRICT, GIT_HOOK_MAX_SUBJECT_LENGTH, GIT_HOOK_COMMIT_MSG_ENABLED
# ================
```
  </action>
  <verify>
- `bash -n plugins/git/hooks/commit-msg` passes
- `grep -c 'GIT_HOOK_' plugins/git/hooks/commit-msg` returns 6+ (all new vars used)
- `grep -E 'BLOCK_AI_ATTRIBUTION=true' plugins/git/hooks/commit-msg | grep -v GIT_HOOK` returns nothing (old hardcoded pattern gone)
- `grep 'CONVENTIONAL_COMMITS' plugins/git/hooks/commit-msg | grep -v GIT_HOOK` returns nothing (old naming gone, except in regex patterns)
- `grep '=== METADATA ===' plugins/git/hooks/commit-msg` finds the metadata block
- `grep -E 'local -n|declare -n' plugins/git/hooks/commit-msg` returns nothing
  </verify>
  <done>commit-msg hook uses unified GIT_HOOK_* naming, all settings are configurable with strong defaults, metadata header present, backwards-compatible config file discovery.</done>
</task>

<task type="auto">
  <name>Task 3: Refactor pre-push hook + remove hooks.conf profiles</name>
  <files>plugins/git/hooks/pre-push, plugins/claude/templates/hooks-conf/default.conf, plugins/claude/templates/hooks-conf/strict.conf, plugins/claude/templates/hooks-conf/permissive.conf</files>
  <action>
**Pre-push hook refactor:**
1. Rename `GIT_HOOK_PREPUSH_PROTECTION` to `GIT_HOOK_BRANCH_PROTECTION` throughout
2. Add `GIT_HOOK_PRE_PUSH_ENABLED` check at top
3. Update config file discovery to match commit-msg (try multiple paths)
4. Add metadata header block:
```bash
# === METADATA ===
# NAME: pre-push
# TYPE: git-hook
# PLUGIN: git
# DESCRIPTION: Protects main/master branches from force-push operations
# CONFIGURABLE: GIT_HOOK_BRANCH_PROTECTION, GIT_HOOK_PRE_PUSH_ENABLED
# ================
```
5. Maintain bash 3.2 compatibility

**Remove hooks.conf profiles:**
Delete the three profile template files per user decision (drop profiles, individual settings only):
- `plugins/claude/templates/hooks-conf/default.conf`
- `plugins/claude/templates/hooks-conf/strict.conf`
- `plugins/claude/templates/hooks-conf/permissive.conf`

Also delete the `plugins/claude/templates/hooks-conf/` directory since it will be empty.

The hooks.conf profile concept is replaced by per-setting toggles in the wizard (Plan 05). The git hook config now lives in git plugin's domain, and claude-specific config stays in claude plugin.
  </action>
  <verify>
- `bash -n plugins/git/hooks/pre-push` passes
- `grep 'GIT_HOOK_BRANCH_PROTECTION' plugins/git/hooks/pre-push` finds the new name
- `grep 'PREPUSH_PROTECTION' plugins/git/hooks/pre-push` returns nothing (old name gone)
- `grep '=== METADATA ===' plugins/git/hooks/pre-push` finds metadata
- `ls plugins/claude/templates/hooks-conf/ 2>/dev/null` returns empty or directory doesn't exist
- `grep -E 'local -n|declare -n' plugins/git/hooks/pre-push` returns nothing
  </verify>
  <done>pre-push uses unified GIT_HOOK_BRANCH_PROTECTION naming with metadata header. hooks.conf profile templates deleted.</done>
</task>

</tasks>

<verification>
1. `bash -n lib/config.sh && bash -n plugins/git/hooks/commit-msg && bash -n plugins/git/hooks/pre-push` — all syntax valid
2. `grep -rE 'PREPUSH_PROTECTION|BRANCH_PROTECTION=warn' plugins/git/hooks/` — only new naming appears
3. `grep -rE 'local -n|declare -n|declare -A' lib/config.sh plugins/git/hooks/` — no bash 4+ features
4. `ls plugins/claude/templates/hooks-conf/ 2>/dev/null | wc -l` returns 0 — profiles gone
5. All git hooks have `# === METADATA ===` blocks
</verification>

<success_criteria>
- lib/config.sh provides SSOT for all hook variable names with clear documentation
- commit-msg and pre-push hooks use unified GIT_HOOK_* naming throughout
- Every setting is configurable (no hardcoded enforcement — even AI attribution has a config key)
- Metadata headers present on both hooks for auto-documentation
- Profile templates deleted
- Bash 3.2 compatible throughout
</success_criteria>

<output>
After completion, create `.planning/phases/08-hooks-workflows-review/08-01-SUMMARY.md`
</output>
