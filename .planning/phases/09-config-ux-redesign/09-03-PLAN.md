---
phase: 09-config-ux-redesign
plan: 03
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - plugins/claude/setup.sh
autonomous: true

must_haves:
  truths:
    - "Claude wizard groups configs into 3 categories: Deploy targets, Content, Behaviour"
    - "User picks which configs to manage (opt-in); unselected configs get NO value in .env"
    - "Opted-in configs show pre-filled suggested value; user presses Enter to accept or types to change"
    - "Re-run shows edit mode with current state and lets user pick numbers to edit"
    - "Final summary shows selected configs with values + skipped ones as [not managed]"
  artifacts:
    - path: "plugins/claude/setup.sh"
      provides: "Opt-in category-based Claude setup wizard"
      contains: "Deploy targets"
  key_links:
    - from: "plugins/claude/setup.sh"
      to: "lib/wizard.sh"
      via: "wizard_category_menu, wizard_edit_mode_display"
      pattern: "wizard_category_menu\\|wizard_edit_mode_display"
---

<objective>
Rewrite the Claude global-configs wizard to use opt-in category-based config selection with edit mode for re-runs.

Purpose: Success criteria 1, 2, 7 require opt-in config selection where users choose which configs to manage, unselected configs stay unset, and opinionated defaults are shown for opted-in configs.
Output: Completely rewritten plugins/claude/setup.sh with category menus and edit mode.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@plugins/claude/setup.sh
@lib/wizard.sh
@lib/colours.sh
@.planning/phases/09-config-ux-redesign/09-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite Claude global-configs wizard with opt-in categories</name>
  <files>plugins/claude/setup.sh</files>
  <action>
Rewrite `plugin_claude_setup()` in plugins/claude/setup.sh. Keep `_claude_save_config()` and `_claude_migrate_old_keys()` largely intact (adjust save logic for opt-in model). Replace the linear 7-step wizard with the category-based opt-in flow.

**Category structure (3 categories for Claude):**

Category 1 - **Deploy targets:**
- Deploy target path (default: `~/.claude`)
- GSD framework install (default: `false`)

Category 2 - **Content:**
- CLAUDE.md sections (discover from plugin dir)
- Skills/commands (discover from plugin dir)

Category 3 - **Behaviour:**
- Settings.json enabled (default: `true`)
- CLAUDE.md exclusion (default: `true`, pattern: `CLAUDE.md`)
- Hooks enabled (discover from plugin dir)

**Removed from wizard:** Git identity (CLAUDE_GIT_USER_NAME, CLAUDE_GIT_USER_EMAIL) — this belongs in the git plugin, not claude. The claude plugin should NOT set git identity. Leave the migration logic in `_claude_migrate_old_keys()` for backwards compat but stop collecting these values.

**First-run flow:**
1. Show banner: `dotconfigs — Claude Configuration`
2. Initialise colours via `init_colours`
3. Show category menu (using `wizard_category_menu` from lib/wizard.sh)
4. For each selected category, show config toggle (using `wizard_config_toggle`)
5. For each opted-in config, prompt with opinionated default (using `wizard_prompt` or `wizard_yesno`)
6. After all categories processed (or user selects "done"), show summary
7. Summary shows opted-in configs with values + non-managed configs greyed as `[not managed]`
8. Confirm save

**Edit mode (re-run when .env has CLAUDE_* keys):**
1. Detect existing config: if .env has CLAUDE_DEPLOY_TARGET, enter edit mode
2. Show current state using `wizard_edit_mode_display`:
   ```
   Current configuration:
   [1] Deploy target path          = ~/.claude
   [2] GSD framework install       = true
   [3] Settings.json enabled       = true
   [4] CLAUDE.md sections          = code-style communication...
   [5] Hooks enabled               = block-destructive.sh...
   [6] Skills enabled              [not managed]
   [7] CLAUDE.md exclusion         = true (CLAUDE.md)

   Enter numbers to edit (e.g. 3,6), or 'done':
   ```
3. Parse selection using `wizard_parse_edit_selection`
4. For each selected item, run the individual config prompt
5. Show updated summary and confirm save

**Save logic changes for opt-in:**
- `_claude_save_config()` must only write keys that are opted-in (have a value set)
- Do NOT write keys for configs the user didn't select
- Add helper to detect if a config is managed: check if the variable is set and non-empty
- When re-running, preserve unmodified keys in .env (don't wipe them)

**Bash 3.2 constraints:**
- No namerefs (`local -n`), no associative arrays, no `${var,,}`
- Use indexed arrays, eval for indirect variable access
- Use `tr '[:upper:]' '[:lower:]'` for case conversion

**Implementation pattern for category flow:**
The wizard should loop through categories, letting user pick which to configure. After configuring a category, return to the category menu. User selects "Done" from category menu to proceed to summary. This avoids a forced linear walk-through.

```
Category menu:
  1) Deploy targets
  2) Content
  3) Behaviour
  4) Configure all
  5) Done — show summary
```
  </action>
  <verify>
- `grep -c "Deploy targets" plugins/claude/setup.sh` returns at least 1
- `grep -c "Content" plugins/claude/setup.sh` returns at least 1
- `grep -c "Behaviour" plugins/claude/setup.sh` returns at least 1
- `grep -c "not managed" plugins/claude/setup.sh` returns at least 1
- `grep -c "wizard_edit_mode_display\|edit.mode\|edit_mode" plugins/claude/setup.sh` returns at least 1
- `grep -c "CLAUDE_GIT_USER_NAME\|CLAUDE_GIT_USER_EMAIL" plugins/claude/setup.sh` returns 0 in the main wizard flow (migration helper is fine)
- No bash 4+ syntax: `grep -c "local -n\|declare -n\|declare -A" plugins/claude/setup.sh` returns 0
  </verify>
  <done>
- Claude wizard uses 3-category opt-in model (Deploy targets, Content, Behaviour)
- Edit mode works on re-run showing current config state
- Unselected configs get no value written to .env
- Opted-in configs show opinionated defaults
- Summary shows managed + not-managed configs
- Git identity removed from Claude wizard
- All bash 3.2 compatible
  </done>
</task>

</tasks>

<verification>
- Claude wizard shows category menu on first run
- Claude wizard shows edit mode on re-run (when .env has CLAUDE_DEPLOY_TARGET)
- Unmanaged configs are not written to .env
- Summary distinguishes managed from not-managed configs
- No bash 4+ features used
</verification>

<success_criteria>
1. Category-based opt-in wizard works for Claude plugin
2. Edit mode works on re-run
3. Only opted-in configs written to .env
4. Opinionated defaults shown for each opted-in config
</success_criteria>

<output>
After completion, create `.planning/phases/09-config-ux-redesign/09-03-SUMMARY.md`
</output>
