---
phase: 09-config-ux-redesign
plan: 04
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - plugins/git/setup.sh
autonomous: true

must_haves:
  truths:
    - "Git wizard groups configs into 4 categories: Identity, Workflow, Aliases, Hooks"
    - "User picks which configs to manage (opt-in); unselected configs get NO value in .env"
    - "Re-run shows edit mode with current state"
    - "All select loops replaced with read-based prompts"
    - "Final summary shows selected configs with values + skipped ones as [not managed]"
  artifacts:
    - path: "plugins/git/setup.sh"
      provides: "Opt-in category-based Git setup wizard"
      contains: "Identity"
  key_links:
    - from: "plugins/git/setup.sh"
      to: "lib/wizard.sh"
      via: "wizard helpers"
      pattern: "wizard_category_menu\\|wizard_edit_mode_display"
---

<objective>
Rewrite the Git global-configs wizard to use opt-in category-based config selection with edit mode, replacing all `select` loops with `read` prompts.

Purpose: Success criteria 1, 2, 7, 8 require opt-in config selection and replacement of remaining `select` loops (2 in git setup).
Output: Completely rewritten plugins/git/setup.sh with category menus, edit mode, and read-based prompts.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@plugins/git/setup.sh
@lib/wizard.sh
@lib/colours.sh
@.planning/phases/09-config-ux-redesign/09-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite Git global-configs wizard with opt-in categories and read prompts</name>
  <files>plugins/git/setup.sh</files>
  <action>
Rewrite `plugin_git_setup()` and all `_git_wizard_*` internal functions. Keep `_git_save_config()` largely intact (adjust for opt-in model). Replace the current menu-based flow with category opt-in.

**Category structure (4 categories for Git — Claude's discretion, aligned with existing wizard sections):**

Category 1 - **Identity:**
- Git user.name
- Git user.email

Category 2 - **Workflow:**
- pull.rebase (default: `true`)
- push.default (default: `simple`)
- fetch.prune (default: `true`)
- init.defaultBranch (default: `main`)
- rerere.enabled (default: `false`)
- diff.algorithm (default: empty/not set)
- help.autocorrect (default: empty/not set)

Category 3 - **Aliases:**
- Default aliases: unstage, last, lg, amend, undo, wip (each toggleable)
- Custom aliases (add interactively)

Category 4 - **Hooks:**
- Hooks scope (project/global)
- Config file location — **REPLACE the `select` loop** (line ~201) with a numbered `read` prompt:
  ```
  Hook config file location:
    1) .githooks/config
    2) .claude/git-hooks.conf
    3) .git/hooks/hooks.conf
    4) Custom path
  Select [1-4, default: 1]:
  ```
- Pre-commit checks (secrets, large file, debug)
- Commit message validation (AI attribution, WIP, conventional)
- Pre-push protection — **REPLACE the `select` loop** (line ~290) with a numbered `read` prompt:
  ```
  Pre-push protection level:
    1) warn  — show warning but allow push
    2) block — prevent force-push to main/master
    3) off   — no pre-push checks
  Select [1-3, default: 1]:
  ```
- Prepare-commit-msg (branch prefix)
- Post-merge/rewrite helpers
- Post-checkout (branch info)
- Advanced settings submenu

**First-run flow:**
1. Show banner: `dotconfigs — Git Configuration`
2. Initialise colours via `init_colours`
3. Show category menu:
   ```
   Category menu:
     1) Identity
     2) Workflow
     3) Aliases
     4) Hooks
     5) Configure all
     6) Done — show summary
   ```
4. For each selected category, run the category's config flow
5. After all categories or "Done", show summary
6. Summary shows all managed configs with values + not-managed as `[not managed]`
7. Confirm save

**Edit mode (re-run when .env has GIT_* keys):**
1. Detect existing config: if .env has GIT_USER_NAME or GIT_PULL_REBASE, enter edit mode
2. Show current state in numbered list format (like Claude wizard)
3. User picks numbers to edit
4. Only prompt for selected items
5. Show updated summary and confirm

**Select loop replacements (CRITICAL — 2 remaining select loops):**

1. **Hook config path** (currently `select config_path in ...`):
   Replace with read-based numbered prompt. Parse numeric input, validate range, handle default.

2. **Branch protection level** (currently `select protection_level in ...`):
   Replace with read-based numbered prompt. Parse numeric input, map to value.

**Save logic for opt-in:**
- Only write keys that are opted-in (have values set)
- Do NOT write keys for configs user didn't select
- When re-running, preserve unmodified keys in .env

**Bash 3.2 constraints:**
- No namerefs, no associative arrays, no `${var,,}`
- Use indexed arrays and eval for indirect access
  </action>
  <verify>
- `grep -c "select " plugins/git/setup.sh` returns 0 (no select loops remaining)
- `grep -c "Identity" plugins/git/setup.sh` returns at least 1
- `grep -c "Workflow" plugins/git/setup.sh` returns at least 1
- `grep -c "Aliases" plugins/git/setup.sh` returns at least 1
- `grep -c "Hooks" plugins/git/setup.sh` returns at least 1
- `grep -c "not managed" plugins/git/setup.sh` returns at least 1
- `grep -c "edit.mode\|edit_mode" plugins/git/setup.sh` returns at least 1
- No bash 4+ syntax: `grep -c "local -n\|declare -n\|declare -A" plugins/git/setup.sh` returns 0
  </verify>
  <done>
- Git wizard uses 4-category opt-in model (Identity, Workflow, Aliases, Hooks)
- Edit mode works on re-run
- All `select` loops replaced with `read` prompts (0 select loops remain)
- Unselected configs not written to .env
- Summary distinguishes managed from not-managed
- All bash 3.2 compatible
  </done>
</task>

</tasks>

<verification>
- Git wizard shows category menu on first run
- No `select` loops remain in the file
- Edit mode works on re-run
- Hook config path uses read prompt
- Branch protection level uses read prompt
- No bash 4+ features
</verification>

<success_criteria>
1. Category-based opt-in wizard works for Git plugin
2. All select loops replaced with read prompts
3. Edit mode works on re-run
4. Only opted-in configs written to .env
</success_criteria>

<output>
After completion, create `.planning/phases/09-config-ux-redesign/09-04-SUMMARY.md`
</output>
