---
phase: 09-config-ux-redesign
plan: 05
type: execute
wave: 3
depends_on: ["09-02", "09-03", "09-04"]
files_modified:
  - plugins/claude/project.sh
  - plugins/claude/deploy.sh
  - plugins/git/project.sh
autonomous: true

must_haves:
  truths:
    - "Project-configs wizard shows global values with cyan [G] badge as reference when overriding"
    - "Local overrides shown with green [L] badge in summary"
    - "CLAUDE.md exclusion is applied during `dotconfigs deploy` (writes to .git/info/exclude)"
    - "Per-project CLAUDE.md override available in project-configs wizard"
    - "select loop in claude project.sh replaced with read prompt"
    - "Settings.json assembly uses language rule selection (Python/Node)"
  artifacts:
    - path: "plugins/claude/project.sh"
      provides: "Project-configs wizard with G/L indicators"
      contains: "colour_badge_global"
    - path: "plugins/claude/deploy.sh"
      provides: "Deploy with CLAUDE.md exclusion application"
      contains: "_claude_apply_md_exclusion"
    - path: "plugins/git/project.sh"
      provides: "Git project-configs with G/L indicators"
      contains: "colour_badge_global"
  key_links:
    - from: "plugins/claude/deploy.sh"
      to: ".git/info/exclude"
      via: "_claude_apply_md_exclusion"
      pattern: "CLAUDE_MD_EXCLUDE"
    - from: "plugins/claude/project.sh"
      to: "lib/colours.sh"
      via: "colour_badge_global, colour_badge_local"
      pattern: "colour_badge"
---

<objective>
Enhance project-configs wizards with G/L provenance indicators, implement CLAUDE.md exclusion during deploy, replace remaining select loop in claude project.sh, and add settings.json language rule assembly.

Purpose: Success criteria 3, 4, 5, 6, 8, 11 require project-configs with visual indicators, CLAUDE.md exclusion during deploy, and settings.json logical separation.
Output: Updated project.sh files with G/L badges, deploy.sh with CLAUDE.md exclusion, settings.json assembly with language selection.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@plugins/claude/project.sh
@plugins/claude/deploy.sh
@plugins/git/project.sh
@lib/colours.sh
@lib/wizard.sh
@.planning/phases/09-config-ux-redesign/09-CONTEXT.md
@.planning/phases/09-config-ux-redesign/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CLAUDE.md exclusion to deploy + settings.json language assembly</name>
  <files>plugins/claude/deploy.sh</files>
  <action>
**Part A: CLAUDE.md exclusion during deploy**

Add a function `_claude_apply_md_exclusion()` to plugins/claude/deploy.sh that:
1. Checks if `CLAUDE_MD_EXCLUDE_GLOBAL` is set to "true" in .env
2. Reads the exclusion pattern from `CLAUDE_MD_EXCLUDE_PATTERN` (default: "CLAUDE.md")
3. Writes the pattern to `.git/info/exclude` of the dotconfigs repo if not already present
4. Also adds `.claude/` pattern if not present
5. Works with dry-run mode (prints "Would add..." instead of writing)
6. Handles missing `.git/info/exclude` gracefully

Call this function from `plugin_claude_deploy()` after the existing step 6 (which currently only adds CLAUDE.md to the dotconfigs repo's exclude). Refactor step 6 to use this new function — currently step 6 hardcodes the patterns, the new function should read them from .env config.

The existing step 6 code (lines 440-452) should be replaced with a call to `_claude_apply_md_exclusion "$DOTCONFIGS_ROOT"`.

**Part B: Settings.json language rule assembly**

Enhance the settings.json deployment (step 1 in `plugin_claude_deploy`) to support language rule assembly:

1. When deploying settings.json, check if language rule configs exist in .env:
   - `CLAUDE_SETTINGS_PYTHON` — if "true", merge python.json template
   - `CLAUDE_SETTINGS_NODE` — if "true", merge node.json template
2. Assembly order: base.json + python.json (if enabled) + node.json (if enabled) + hooks.json (if hooks deployed)
3. The root settings.json is the assembled result
4. Deploy rebuilds the whole file each time (assembly model per CONTEXT.md)

Use the existing `_claude_merge_settings_json()` function from project.sh for merging. Since deploy.sh and project.sh are separate files, extract the merge function to be accessible from deploy.sh. The simplest approach: duplicate the jq/python merge logic in deploy.sh as `_claude_assemble_settings()`.

Actually, re-reading the deploy code — settings.json is currently symlinked from the repo root. The assembly model means we should BUILD the root settings.json from templates during deploy, then symlink that built file. The flow becomes:

1. Assemble settings.json from templates → write to `$DOTCONFIGS_ROOT/settings.json`
2. Symlink `$DEPLOY_TARGET/settings.json` → `$DOTCONFIGS_ROOT/settings.json`

This preserves the symlink model while enabling assembly.
  </action>
  <verify>
- `grep -c "_claude_apply_md_exclusion" plugins/claude/deploy.sh` returns at least 2 (definition + call)
- `grep -c "CLAUDE_MD_EXCLUDE_GLOBAL" plugins/claude/deploy.sh` returns at least 1
- `grep -c "CLAUDE_SETTINGS_PYTHON\|CLAUDE_SETTINGS_NODE\|assemble" plugins/claude/deploy.sh` returns at least 1
- No bash 4+ syntax: `grep -c "local -n\|declare -n\|declare -A" plugins/claude/deploy.sh` returns 0
  </verify>
  <done>
- CLAUDE.md exclusion applied during deploy (reads from .env, writes to .git/info/exclude)
- Settings.json assembled from templates with language rule selection
- Dry-run mode works for both features
  </done>
</task>

<task type="auto">
  <name>Task 2: Add G/L indicators to project-configs wizards + fix select loop</name>
  <files>plugins/claude/project.sh, plugins/git/project.sh</files>
  <action>
**Part A: Claude project.sh — G/L indicators + select fix**

1. **Initialise colours** at the start of `plugin_claude_project()`: call `init_colours`

2. **Add G/L provenance indicators:** When showing project config options, load the global .env values and display them with `[G]` badge in cyan:
   - Before prompting for settings.json: show current global setting with `[G]` badge
   - Before prompting for hooks: show globally-enabled hooks with `[G]` badge
   - Before prompting for CLAUDE.md: show global sections with `[G]` badge
   - When user sets a local value, display it with `[L]` badge in green

3. **Add CLAUDE.md exclusion to project wizard:** Add a step that:
   - Shows global CLAUDE.md exclusion setting with `[G]` badge
   - Asks if user wants to override for this project
   - If yes, writes pattern to project's `.git/info/exclude`
   - Default: use global setting (no override needed)

4. **Replace select loop** (the remaining `select action in "Append dotconfigs section" "Skip"` on line ~300):
   Replace with read-based numbered prompt:
   ```
   Existing CLAUDE.md found. Choose action:
     1) Append dotconfigs section
     2) Skip
   Select [1-2]:
   ```

5. **Summary with provenance:** Final summary should show each config with G/L provenance label:
   ```
   Configuration applied:
     [G] Settings.json:  base+python (global default)
     [L] Hooks:          block-destructive.sh (project override)
     [G] CLAUDE.md:      minimal (global default)
   ```

**Part B: Git project.sh — G/L indicators**

1. **Initialise colours** at the start of `plugin_git_project()`: call `init_colours`

2. **Show global git config as reference:** When prompting for project-specific identity:
   - Show current global identity with `[G]` badge
   - Show current local identity (if set) with `[L]` badge
   - When user sets new local value, confirm with `[L]` badge

3. **Show global hook settings as reference:** When deploying hooks:
   - Show which hooks are globally enabled with `[G]` badge
   - Indicate which are being deployed to this project

4. **Summary with provenance labels**

**Bash 3.2 constraints:** No namerefs, no associative arrays, no `${var,,}`.
  </action>
  <verify>
- `grep -c "select " plugins/claude/project.sh` returns 0 (no select loops)
- `grep -c "colour_badge_global\|badge_global" plugins/claude/project.sh` returns at least 1
- `grep -c "colour_badge_local\|badge_local" plugins/claude/project.sh` returns at least 1
- `grep -c "init_colours" plugins/claude/project.sh` returns at least 1
- `grep -c "colour_badge_global\|badge_global" plugins/git/project.sh` returns at least 1
- `grep -c "init_colours" plugins/git/project.sh` returns at least 1
- No bash 4+ syntax in either file
  </verify>
  <done>
- Claude project-configs shows G/L provenance indicators
- Git project-configs shows G/L provenance indicators
- Claude project.sh select loop replaced with read prompt
- CLAUDE.md exclusion available in project-configs wizard
- Summary shows provenance labels (Global/Local)
- All bash 3.2 compatible
  </done>
</task>

</tasks>

<verification>
- `dotconfigs deploy claude` applies CLAUDE.md exclusion from .env to .git/info/exclude
- Project-configs wizards show [G] and [L] badges with correct colours
- No `select` loops remain in any plugin file
- Settings.json is assembled from templates during deploy
- All bash 3.2 compatible
</verification>

<success_criteria>
1. CLAUDE.md exclusion applied during deploy
2. G/L provenance indicators in both project-configs wizards
3. Last select loop (claude project.sh) replaced
4. Settings.json assembled with language rules
5. Summary shows provenance for all configs
</success_criteria>

<output>
After completion, create `.planning/phases/09-config-ux-redesign/09-05-SUMMARY.md`
</output>
