---
phase: 09-config-ux-redesign
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - plugins/claude/setup.sh
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Boolean opt-out leaves variable unset — no 'false' written to .env"
    - "Content collections (sections, skills) start empty on first run — user opts in"
    - "Re-run pre-fills from .env values (edit mode unchanged)"
  artifacts:
    - path: "plugins/claude/setup.sh"
      provides: "Corrected opt-in model for booleans and collections"
  key_links:
    - from: "plugins/claude/setup.sh"
      to: ".env"
      via: "_claude_save_config"
      pattern: "wizard_save_env.*CLAUDE_"
---

<objective>
Fix two opt-in model bugs in the Claude setup wizard identified in VERIFICATION.md.

Purpose: The opt-in model requires that unselected configs get NO value in .env. Two bugs violate this: (1) boolean configs write "false" instead of staying unset, and (2) content collections default to all items selected on first run.
Output: Corrected `plugins/claude/setup.sh` where boolean opt-outs leave variables unset and first-run collections start empty.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-config-ux-redesign/09-VERIFICATION.md
@plugins/claude/setup.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix boolean opt-out to leave variables unset</name>
  <files>plugins/claude/setup.sh</files>
  <action>
    Fix three locations where boolean configs are set to "false" when user opts out. The correct pattern is: set to "true" on opt-in, leave unset (do not assign) on opt-out.

    **Location 1 — `_claude_configure_deploy_targets` (line ~121):**
    Change the else branch of the GSD wizard_yesno from `CLAUDE_GSD_INSTALL="false"` to `unset CLAUDE_GSD_INSTALL`. This ensures the save function's `[[ -n "$CLAUDE_GSD_INSTALL" ]]` check correctly skips writing it.

    **Location 2 — `_claude_configure_behaviour` (line ~218):**
    Change the else branch of the settings.json wizard_yesno from `CLAUDE_SETTINGS_ENABLED="false"` to `unset CLAUDE_SETTINGS_ENABLED`.

    **Location 3 — `_claude_configure_behaviour` (line ~254):**
    Change the else branch of the CLAUDE.md exclusion wizard_yesno from `CLAUDE_MD_EXCLUDE_GLOBAL="false"` to `unset CLAUDE_MD_EXCLUDE_GLOBAL`. Also unset CLAUDE_MD_EXCLUDE_PATTERN in the same branch (it currently sets to empty string which is fine, but `unset` is more explicit).

    **Location 4 — `_claude_edit_mode` (line ~479):**
    In the edit mode GSD section (case 1), change `CLAUDE_GSD_INSTALL="false"` to `unset CLAUDE_GSD_INSTALL`.

    **Location 5 — `_claude_edit_mode` (line ~491):**
    In the edit mode settings section (case 2), change `CLAUDE_SETTINGS_ENABLED="false"` to `unset CLAUDE_SETTINGS_ENABLED`.

    **Location 6 — `_claude_edit_mode` (line ~512):**
    In the edit mode CLAUDE.md exclusion section (case 3), change `CLAUDE_MD_EXCLUDE_GLOBAL="false"` to `unset CLAUDE_MD_EXCLUDE_GLOBAL`. Also `unset CLAUDE_MD_EXCLUDE_PATTERN`.

    **Also fix the default detection logic** in `_claude_configure_behaviour` (line ~214):
    Change `[[ "$CLAUDE_SETTINGS_ENABLED" == "false" ]] && settings_default="n"` to use the positive check pattern instead: default is "n" unless the variable is "true". Replace with:
    ```
    local settings_default="n"
    [[ "$CLAUDE_SETTINGS_ENABLED" == "true" ]] && settings_default="y"
    ```
    This way, unset variables default to "n" (opt-in model: nothing selected by default).

    Apply the same pattern fix to `_claude_edit_mode` case 2 (settings default detection).

    **Also fix the .env header comments** (lines 12-13): Change `dots global-configs` to `dotconfigs global-configs` (two occurrences).
  </action>
  <verify>
    Run: `grep -n '"false"' plugins/claude/setup.sh` — should return 0 matches.
    Run: `grep -n 'unset CLAUDE_GSD_INSTALL\|unset CLAUDE_SETTINGS_ENABLED\|unset CLAUDE_MD_EXCLUDE' plugins/claude/setup.sh` — should show 6 unset lines.
    Run: `grep -n 'dots global-configs' plugins/claude/setup.sh` — should return 0 matches (all changed to dotconfigs).
  </verify>
  <done>No boolean config is ever set to "false". Opt-out leaves the variable unset. Save function's `-n` check correctly skips unset variables.</done>
</task>

<task type="auto">
  <name>Task 2: Fix first-run content collection defaults to empty</name>
  <files>plugins/claude/setup.sh</files>
  <action>
    Fix two locations where content collections default to ALL items selected on first run. The opt-in model requires first run to start with empty selection.

    **Location 1 — `_claude_configure_content` sections (line ~159):**
    Change the else branch (first run) from:
    ```
    selected_sections=("${available_sections[@]}")
    ```
    to:
    ```
    selected_sections=()
    ```

    **Location 2 — `_claude_configure_content` skills (line ~190):**
    Change the else branch (first run) from:
    ```
    selected_skills=("${available_skills[@]}")
    ```
    to:
    ```
    selected_skills=()
    ```

    The re-run path (pre-fill from .env) remains unchanged — when `prev_sections` or `prev_skills` is non-empty, the previous selections are loaded correctly.

    Also update the comment on these else branches from "# First run: default to all sections/skills" to "# First run: start empty (opt-in model)".
  </action>
  <verify>
    Run: `grep -n 'default to all' plugins/claude/setup.sh` — should return 0 matches.
    Run: `grep -n 'start empty' plugins/claude/setup.sh` — should return 2 matches (sections and skills).
    Run: `grep -A1 'start empty' plugins/claude/setup.sh` — should show `selected_sections=()` and `selected_skills=()`.
  </verify>
  <done>First-run wizard starts with empty content selection. User explicitly opts in to sections and skills. Re-run pre-fills from previous .env values.</done>
</task>

</tasks>

<verification>
1. `grep '"false"' plugins/claude/setup.sh` returns no matches
2. `grep 'default to all' plugins/claude/setup.sh` returns no matches
3. `grep -c 'unset CLAUDE_' plugins/claude/setup.sh` returns 6 or more
4. `grep -c 'start empty' plugins/claude/setup.sh` returns 2
5. `grep 'dots global-configs' plugins/claude/setup.sh` returns no matches
</verification>

<success_criteria>
- Boolean opt-out (GSD, settings.json, CLAUDE.md exclusion) leaves variables unset — save function skips them
- Content collections (sections, skills) start empty on first run — user explicitly selects items
- Edit mode boolean handling matches category menu behaviour (unset on opt-out)
- Re-run pre-fill from .env still works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/09-config-ux-redesign/09-06-SUMMARY.md`
</output>
