---
phase: 03-settings-hooks-deploy-skills
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - settings.json
  - templates/settings/base.json
  - templates/settings/python.json
  - templates/settings/node.json
  - templates/hooks-conf/default.conf
  - templates/hooks-conf/strict.conf
  - templates/hooks-conf/permissive.conf
autonomous: true

must_haves:
  truths:
    - "Global settings.json has allow/deny/ask rules covering tool permissions and file access"
    - "*.pem, *credentials*, *secret* files are denied by settings.json"
    - ".env files trigger an ask prompt (not deny)"
    - "Project settings templates exist for Python and Node projects"
    - "hooks.conf templates provide default, strict, and permissive presets"
  artifacts:
    - path: "settings.json"
      provides: "Global settings source of truth"
      contains: "deny.*pem"
    - path: "templates/settings/base.json"
      provides: "Base project settings template"
      contains: "permissions"
    - path: "templates/settings/python.json"
      provides: "Python project settings overlay"
      contains: "ruff"
    - path: "templates/settings/node.json"
      provides: "Node project settings overlay"
      contains: "npm"
    - path: "templates/hooks-conf/default.conf"
      provides: "Default hooks configuration"
      contains: "BRANCH_PROTECTION=warn"
    - path: "templates/hooks-conf/strict.conf"
      provides: "Strict hooks configuration"
      contains: "BRANCH_PROTECTION=block"
  key_links:
    - from: "settings.json"
      to: "templates/settings/base.json"
      via: "base.json is the project-level equivalent of global settings.json"
      pattern: "permissions"
---

<objective>
Create the settings.json permission model and all configuration templates that other plans depend on.

Purpose: Establishes the security/permissions layer (SETT-01 through SETT-04) and the config templates that deploy.sh will use to scaffold projects. These are foundational artefacts — hooks, deploy, and skills all reference them.

Output: Updated global settings.json, project settings templates (base/python/node), and hooks.conf presets (default/strict/permissive).
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@settings.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update global settings.json with proper deny/ask rules</name>
  <files>settings.json</files>
  <action>
Update the existing settings.json to have correct deny/ask rules per user decisions:

**deny rules** (accept Claude Code bugs #6699/#8961 — ship anyway for future-proofing):
- `Read(*.pem)` — certificate/key files
- `Read(*credentials*)` — credential files
- `Read(*secret*)` — secret files
- `Read(**/.ssh/**)` — SSH directory
- `Read(**/*_key)` — key files (already exists)
- `Read(**/*_secret)` — secret files (already exists)
- `Bash(rm -rf /)` — destructive commands (keep existing)
- `Bash(mkfs:*)` — filesystem commands (keep existing)
- `Bash(dd if=:*)` — disk commands (keep existing)

**ask rules** (NOT deny):
- `Read(.env)` — .env files should ask, not deny (per user decision: "strict deny was annoying")
- `Read(.env.*)` — .env variant files should ask
- Move existing .env deny rules to ask
- Keep existing systemctl/kill/reboot ask rules

**allow rules**: Keep existing allows (git, ruff, pytest, pip, python, docker, nvidia-smi, proc reads). Add:
- `Bash(npm:*)` — for Node projects
- `Bash(npx:*)` — for GSD install and tools
- `Bash(node:*)` — for Node projects

Keep existing: alwaysThinkingEnabled, includeCoAuthoredBy=false, gitAttribution=false, env vars, sandbox config, hooks config (PostToolUse for ruff, empty PreToolUse array).

Remove the `.env` entries from deny and add them to ask instead.
  </action>
  <verify>
Validate JSON syntax: `python3 -c "import json; json.load(open('settings.json'))"`

Check deny rules include *.pem, *credentials*, *secret*: `grep -E "pem|credentials|secret" settings.json`

Check .env is in ask, not deny: `python3 -c "import json; d=json.load(open('settings.json')); assert any('.env' in r for r in d['permissions']['ask']); assert not any('.env' in r for r in d['permissions']['deny'])"`
  </verify>
  <done>settings.json has deny rules for *.pem/*credentials*/*secret*/.ssh, ask rules for .env/.env.*, and all existing allow/ask rules preserved. JSON validates.</done>
</task>

<task type="auto">
  <name>Task 2: Create settings and hooks-conf templates</name>
  <files>
    templates/settings/base.json
    templates/settings/python.json
    templates/settings/node.json
    templates/hooks-conf/default.conf
    templates/hooks-conf/strict.conf
    templates/hooks-conf/permissive.conf
  </files>
  <action>
Create `templates/` directory structure with settings and hooks-conf templates.

**templates/settings/base.json** — Minimal project settings.json template:
```json
{
  "permissions": {
    "allow": [],
    "deny": [
      "Read(*.pem)",
      "Read(*credentials*)",
      "Read(*secret*)"
    ],
    "ask": [
      "Read(.env)",
      "Read(.env.*)"
    ]
  }
}
```

**templates/settings/python.json** — Python project overlay (additional rules to merge with base):
```json
{
  "permissions": {
    "allow": [
      "Bash(ruff:*)",
      "Bash(pytest:*)",
      "Bash(pip:*)",
      "Bash(python:*)"
    ]
  },
  "env": {
    "PYTHONDONTWRITEBYTECODE": "1",
    "PYTHONUNBUFFERED": "1"
  }
}
```

**templates/settings/node.json** — Node project overlay:
```json
{
  "permissions": {
    "allow": [
      "Bash(npm:*)",
      "Bash(npx:*)",
      "Bash(node:*)",
      "Bash(pnpm:*)"
    ]
  }
}
```

**templates/hooks-conf/default.conf** — Sensible defaults for most projects:
```bash
# .claude/hooks.conf — Generated by deploy.sh project
# Modify these settings to control git hook behaviour for this project.

# Require conventional commit format on main branch (type(scope): description)
CONVENTIONAL_COMMITS=true

# Branch protection for main: warn | block | off
BRANCH_PROTECTION=warn

# Auto-format Python files with Ruff on commit
RUFF_ENABLED=true

# AI attribution blocking (always enforced, cannot be disabled)
# BLOCK_AI_ATTRIBUTION=true
```

**templates/hooks-conf/strict.conf** — For projects requiring strict enforcement:
Same as default but with `BRANCH_PROTECTION=block`.

**templates/hooks-conf/permissive.conf** — For experimental/personal projects:
Same as default but with `CONVENTIONAL_COMMITS=false` and `BRANCH_PROTECTION=off`.
  </action>
  <verify>
Validate JSON templates: `for f in templates/settings/*.json; do python3 -c "import json; json.load(open('$f'))" && echo "OK: $f"; done`

Check hooks-conf templates exist and are valid shell: `for f in templates/hooks-conf/*.conf; do bash -n "$f" && echo "OK: $f"; done`

Check directory structure: `find templates/ -type f | sort`
  </verify>
  <done>
templates/settings/ contains base.json, python.json, node.json — all valid JSON.
templates/hooks-conf/ contains default.conf, strict.conf, permissive.conf — all valid shell.
Templates are ready for deploy.sh to use when scaffolding projects.
  </done>
</task>

</tasks>

<verification>
- `python3 -c "import json; json.load(open('settings.json'))"` passes
- `find templates/ -type f | wc -l` returns 6
- settings.json deny rules include pem/credentials/secret patterns
- settings.json ask rules include .env patterns (not in deny)
- hooks-conf templates source cleanly in bash
</verification>

<success_criteria>
- Global settings.json updated with correct deny/ask/allow rules (SETT-01, SETT-04)
- Project settings templates exist for base/python/node (SETT-02)
- Hooks.conf templates exist for default/strict/permissive
- All JSON validates, all shell sources cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-settings-hooks-deploy-skills/03-01-SUMMARY.md`
</output>
