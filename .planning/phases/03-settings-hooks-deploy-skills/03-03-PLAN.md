---
phase: 03-settings-hooks-deploy-skills
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - githooks/commit-msg
  - githooks/pre-commit
autonomous: true

must_haves:
  truths:
    - "commit-msg hook validates conventional commits on main and blocks AI attribution"
    - "pre-commit hook does branch protection (warn by default, configurable block) and Ruff formatting"
    - "Both hooks read per-project .claude/hooks.conf for config-driven behaviour"
    - "No hardcoded identity check in any hook"
    - "Commit message validation is in commit-msg (not pre-commit) — fixes COMMIT_EDITMSG timing bug"
    - "Projects without .claude/hooks.conf get sensible defaults"
  artifacts:
    - path: "githooks/commit-msg"
      provides: "Commit message validation and AI attribution blocking"
      contains: "CONVENTIONAL_COMMITS"
    - path: "githooks/pre-commit"
      provides: "Branch protection and Ruff formatting"
      contains: "BRANCH_PROTECTION"
  key_links:
    - from: "githooks/commit-msg"
      to: ".claude/hooks.conf"
      via: "source if exists, otherwise use defaults"
      pattern: "source.*hooks\\.conf"
    - from: "githooks/pre-commit"
      to: ".claude/hooks.conf"
      via: "source if exists, otherwise use defaults"
      pattern: "source.*hooks\\.conf"
---

<objective>
Refactor both git hooks to be config-driven via .claude/hooks.conf, fix the COMMIT_EDITMSG timing bug, and remove the hardcoded identity check.

Purpose: Git hooks will be deployed globally via core.hooksPath (per user decision). They must work across all projects with per-project configuration. The pre-commit hook currently has a COMMIT_EDITMSG timing bug (reads stale data) and a hardcoded identity check — both must be fixed. Commit message validation must move to commit-msg hook.

Output: Refactored githooks/commit-msg and githooks/pre-commit, both config-driven and portable.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@githooks/commit-msg
@githooks/pre-commit
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor commit-msg hook with conventional commit validation</name>
  <files>githooks/commit-msg</files>
  <action>
Rewrite githooks/commit-msg to include ALL commit message validation (moved from pre-commit) plus existing AI attribution blocking. This hook receives $1 as the commit message file — no COMMIT_EDITMSG timing issue.

Structure:
```bash
#!/bin/bash
# commit-msg hook — validates commit messages
# Deployed globally via core.hooksPath. Config-driven via .claude/hooks.conf.
#
# Source of truth: dotclaude/githooks/commit-msg
# Deployed to: ~/.claude/git-hooks/commit-msg

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
SUBJECT_LINE=$(echo "$COMMIT_MSG" | head -1)
REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || echo ".")"
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")

# --- Load project config ---
HOOK_CONFIG="$REPO_ROOT/.claude/hooks.conf"

# Defaults
CONVENTIONAL_COMMITS=true
BLOCK_AI_ATTRIBUTION=true  # Cannot be disabled

if [ -f "$HOOK_CONFIG" ]; then
    source "$HOOK_CONFIG"
    # Force AI attribution blocking regardless of config
    BLOCK_AI_ATTRIBUTION=true
fi
```

**Section 1: AI attribution blocking (always enforced, cannot be disabled)**
Keep the existing AI_PATTERNS array and matching logic. Same patterns as current commit-msg hook. This runs regardless of .claude/hooks.conf settings.

**Section 2: Conventional commit validation (config-driven)**
Moved from pre-commit lines 88-130. Only applies on main branch when `CONVENTIONAL_COMMITS=true`.

- On main: require conventional commit format (`type:` or `type(scope):` prefix) — block WIP commits
- On main: warn (not block) if subject line exceeds 72 chars
- On branches: allow anything (WIP, notes, experiments)
- Skip validation during squash merge (check for SQUASH_MSG or merge commit indicators)

**Important:** The squash merge detection must check for `$REPO_ROOT/.git/SQUASH_MSG` or `$GIT_MERGE_SQUASH` env var. During squash merge, the user crafts the commit message themselves via /squash-merge skill, so conventional commit validation SHOULD still apply (they want a clean conventional commit on main). But WIP blocking should be relaxed during squash merge since the squash-merge flow handles message formatting.
  </action>
  <verify>
Check hook is executable-ready: `bash -n githooks/commit-msg && echo "Syntax OK"`

Verify AI patterns are present: `grep -c "AI_PATTERNS\|Co-Authored-By\|Generated by" githooks/commit-msg`

Verify config loading: `grep "hooks.conf" githooks/commit-msg`

Verify conventional commit logic exists: `grep "CONVENTIONAL_COMMITS" githooks/commit-msg`

Verify no hardcoded identity: `! grep -i "henrycgbaker\|henry.c.g.baker" githooks/commit-msg && echo "No hardcoded identity"`
  </verify>
  <done>
commit-msg hook validates conventional commits (config-driven) and blocks AI attribution (always enforced).
Reads .claude/hooks.conf for project-specific settings.
No hardcoded identity. No COMMIT_EDITMSG timing bug (receives message file as $1).
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor pre-commit hook to config-driven branch protection + Ruff</name>
  <files>githooks/pre-commit</files>
  <action>
Rewrite githooks/pre-commit to keep ONLY branch protection and Ruff formatting. All commit message validation has moved to commit-msg hook. Remove the hardcoded identity check entirely.

Structure:
```bash
#!/bin/bash
# pre-commit hook — branch protection and auto-formatting
# Deployed globally via core.hooksPath. Config-driven via .claude/hooks.conf.
#
# Source of truth: dotclaude/githooks/pre-commit
# Deployed to: ~/.claude/git-hooks/pre-commit

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || echo ".")"
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")

# --- Load project config ---
HOOK_CONFIG="$REPO_ROOT/.claude/hooks.conf"

# Defaults
BRANCH_PROTECTION=warn  # warn | block | off
RUFF_ENABLED=true

if [ -f "$HOOK_CONFIG" ]; then
    source "$HOOK_CONFIG"
fi
```

**Section 1: Branch protection (config-driven)**
Three modes based on `BRANCH_PROTECTION` setting:
- `block`: Hard block direct commits to main. Exit 1 with helpful error message (create branch, commit there, use /squash-merge). Allow squash merge (check SQUASH_MSG).
- `warn`: Print warning but allow the commit. This is the default.
- `off`: No branch protection.

The squash merge detection: if `$REPO_ROOT/.git/SQUASH_MSG` exists, skip branch protection entirely (user is doing a squash merge).

**Section 2: Ruff formatting (config-driven)**
Keep the existing Python linting/formatting logic (lines 52-77 of current pre-commit). Only runs when `RUFF_ENABLED=true`.
- Find staged Python files
- Run `ruff format` and `ruff check --fix`
- Re-stage fixed files
- If ruff made changes, warn and exit 1 (forces re-commit with fixes)
- Skip silently if ruff not installed

**Remove entirely:**
- Identity check (lines 33-49) — removed per user decision (git identity configured at deploy time, not enforced by hooks)
- Commit message validation (lines 88-130) — moved to commit-msg hook
- Agent sync block (lines 79-86) — already disabled/commented, delete completely
  </action>
  <verify>
Check hook is executable-ready: `bash -n githooks/pre-commit && echo "Syntax OK"`

Verify branch protection: `grep "BRANCH_PROTECTION" githooks/pre-commit`

Verify Ruff section: `grep "ruff" githooks/pre-commit`

Verify no identity check: `! grep -i "henrycgbaker\|EXPECTED_NAME\|EXPECTED_EMAIL" githooks/pre-commit && echo "No identity check"`

Verify no commit message validation: `! grep "COMMIT_EDITMSG\|COMMIT_MSG" githooks/pre-commit && echo "No commit msg validation"`

Verify no agent sync: `! grep "sync-project-agents\|Agent Sync" githooks/pre-commit && echo "No agent sync"`

Verify config loading: `grep "hooks.conf" githooks/pre-commit`
  </verify>
  <done>
pre-commit hook does branch protection (warn/block/off, config-driven) and Ruff formatting (config-driven).
No hardcoded identity check. No commit message validation (moved to commit-msg).
No agent sync code. Reads .claude/hooks.conf for project-specific settings.
  </done>
</task>

</tasks>

<verification>
- Both hooks pass `bash -n` syntax check
- Neither hook contains hardcoded identity (henrycgbaker/henry.c.g.baker)
- commit-msg handles AI attribution + conventional commits
- pre-commit handles branch protection + Ruff
- Both hooks read .claude/hooks.conf when present
- Both hooks work with sensible defaults when no .claude/hooks.conf exists
</verification>

<success_criteria>
- HOOK-02: commit-msg validates conventional commits (DONE)
- HOOK-03: commit-msg blocks AI attribution (DONE)
- HOOK-04: Layered branch protection — warn default, block configurable (DONE)
- HOOK-05: Hooks exist as templates in dotclaude repo (DONE — githooks/ directory)
- COMMIT_EDITMSG timing bug fixed (validation moved to commit-msg hook)
- Hardcoded identity check removed
</success_criteria>

<output>
After completion, create `.planning/phases/03-settings-hooks-deploy-skills/03-03-SUMMARY.md`
</output>
