---
phase: 03-settings-hooks-deploy-skills
plan: 06
type: execute
wave: 3
depends_on: ["03-05"]
files_modified:
  - deploy.sh
autonomous: true

must_haves:
  truths:
    - "deploy.sh project scaffolds a project with .claude/settings.json, CLAUDE.md, .git/info/exclude"
    - "Project wizard detects greenfield vs brownfield (existing .claude/, CLAUDE.md)"
    - "Existing CLAUDE.md offered merge/append, never blindly overwritten"
    - "Project type detection adjusts defaults (Python → Ruff enabled, Node → npm allowed)"
    - "deploy.sh project handles remote deployment via SSH (clone + symlink)"
    - "Remote deployment clones dotclaude repo then runs deploy.sh global on remote"
  artifacts:
    - path: "deploy.sh"
      provides: "Complete deployment script with global, project, and remote support"
      contains: "deploy_project"
      min_lines: 300
  key_links:
    - from: "deploy.sh (project)"
      to: "templates/settings/base.json"
      via: "builds project settings.json from base + type overlay"
      pattern: "templates/settings"
    - from: "deploy.sh (project)"
      to: "templates/hooks-conf/default.conf"
      via: "copies hooks.conf template for project"
      pattern: "templates/hooks-conf"
---

<objective>
Add project scaffolding and remote deployment to deploy.sh.

Purpose: Completes the deployment system with project-level scaffolding (DEPL-03) and remote SSH deployment (DEPL-04). The project subcommand creates per-project configuration (.claude/settings.json, CLAUDE.md, .git/info/exclude, .claude/hooks.conf). Remote deployment clones the dotclaude repo on a remote machine and runs global deploy via SSH.

Output: deploy.sh with all three capabilities: global, project, and remote deployment.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-settings-hooks-deploy-skills/03-05-SUMMARY.md
@deploy.sh
@deploy-remote.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add project subcommand to deploy.sh</name>
  <files>deploy.sh</files>
  <action>
Add the `deploy.sh project [path]` subcommand to the existing deploy.sh. Replace the stub created in Plan 05.

**Project deploy flow:**

1. Parse args: `deploy.sh project [path] [--interactive]`
   - `path` defaults to current directory
   - Validate path is a git repo (check for .git/)
2. Detect project state (greenfield vs brownfield):
   - Check for existing `.claude/` directory
   - Check for existing `CLAUDE.md`
   - Check for existing `.git/info/exclude`
   - Report what was found
3. Detect project type from files:
   - Python: `pyproject.toml`, `setup.py`, `requirements.txt`, `*.py` in root → set type=python
   - Node: `package.json` → set type=node
   - Go: `go.mod` → set type=go
   - Default: generic
4. Interactive wizard (or non-interactive with defaults):

   **Step 1: Project settings.json**
   - Build from templates/settings/base.json + type overlay (python.json, node.json, etc.)
   - If .claude/settings.json exists: show diff, offer overwrite/skip/merge
   - Write to `[path]/.claude/settings.json`

   **Step 2: Hooks configuration**
   - Copy appropriate hooks.conf template to `[path]/.claude/hooks.conf`
   - Default: templates/hooks-conf/default.conf
   - Ask: strict, permissive, or default? (if interactive)
   - Adjust defaults based on project type (Python → RUFF_ENABLED=true, etc.)

   **Step 3: CLAUDE.md**
   - If no existing CLAUDE.md: create a minimal project CLAUDE.md with project-specific notes
   - If existing CLAUDE.md found: offer to append dotclaude sections or skip
   - Project CLAUDE.md should include: project name, detected type, reference to global CLAUDE.md

   **Step 4: .git/info/exclude**
   - Add entries for AI artefacts if not already present:
     ```
     # Claude Code
     CLAUDE.md
     .claude/
     .claude-project
     ```
   - Read existing .git/info/exclude, append only missing entries
   - Never overwrite existing entries

   **Step 5: Optional commands/skills**
   - Ask if user wants project-specific commands symlinked (usually no — global is sufficient)

**Conflict resolution:** Same pattern as global deploy — interactive prompts or non-interactive skip.

**Key requirements:**
- Never blindly overwrite (per user decision)
- Greenfield detection informs defaults, doesn't change flow
- Project settings.json is BUILT (merged from templates), not symlinked
- .claude/hooks.conf is a COPY of a template, not a symlink (per-project customisation)
- .git/info/exclude only appends, never overwrites
  </action>
  <verify>
Syntax check: `bash -n deploy.sh && echo "Syntax OK"`

Check project subcommand exists: `grep "deploy_project\|project)" deploy.sh`

Check greenfield/brownfield detection: `grep -c "brownfield\|greenfield\|existing" deploy.sh`

Check project type detection: `grep -c "pyproject\|package.json\|go.mod" deploy.sh`

Check settings merge: `grep "templates/settings" deploy.sh`

Check hooks.conf deployment: `grep "hooks.conf" deploy.sh`

Check .git/info/exclude handling: `grep "info/exclude" deploy.sh`
  </verify>
  <done>
deploy.sh project subcommand scaffolds projects with:
- .claude/settings.json built from templates + type overlay
- .claude/hooks.conf copied from appropriate template
- CLAUDE.md created or appended (never blindly overwritten)
- .git/info/exclude entries added for AI artefacts
Greenfield/brownfield detection, project type detection, conflict resolution all working.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add remote deployment support to deploy.sh</name>
  <files>deploy.sh</files>
  <action>
Add remote deployment capability to the global subcommand. This replaces deploy-remote.sh entirely.

**Invocation:**
- `deploy.sh global --remote HOST` — deploy to remote host via SSH
- `deploy.sh global --remote HOST --method clone` — clone repo on remote (default)
- `deploy.sh global --remote HOST --method rsync` — rsync local copy to remote

**Remote deploy flow:**

1. Test SSH connection: `ssh -o ConnectTimeout=10 "$HOST" "echo connected"`. Fail fast with clear error if can't connect.

2. Transfer repo to remote:
   - **clone method** (default): SSH to remote, clone dotclaude repo (or pull if already exists). The remote clone URL should be configurable via .env (`REMOTE_REPO_URL`) or default to the origin URL of the local repo.
   - **rsync method**: `rsync -av --exclude='.git' --exclude='.vscode' --exclude='.env' --exclude='.planning' "$SCRIPT_DIR/" "$HOST:~/dotclaude/"`. Exclude .env (per-machine), .planning (dev only), .git (not needed for deployment).

3. Run deploy.sh global on remote: `ssh "$HOST" "cd ~/dotclaude && chmod +x deploy.sh && ./deploy.sh global"`. This triggers the wizard on the remote machine (or reads remote .env if it exists).

4. Optionally install GSD on remote: If GSD_INSTALL=true in local .env, SSH and run `npx get-shit-done-cc --claude --global` on remote.

**Key requirements:**
- Remote deployment follows the same symlink model (per user decision: "clone repo then symlink — same ownership model everywhere")
- Remote .env is separate from local .env (per-machine config)
- Never transfer .env to remote (it's per-machine)
- Default clone URL from `git remote get-url origin` of local repo
  </action>
  <verify>
Syntax check: `bash -n deploy.sh && echo "Syntax OK"`

Check remote flag: `grep "\-\-remote" deploy.sh`

Check SSH connection test: `grep "ConnectTimeout" deploy.sh`

Check clone method: `grep "git clone" deploy.sh`

Check rsync method: `grep "rsync" deploy.sh`

Check .env excluded from rsync: `grep "exclude.*\.env" deploy.sh`

Check remote deploy.sh execution: `grep "ssh.*deploy.sh" deploy.sh`
  </verify>
  <done>
deploy.sh global --remote HOST deploys to remote servers via SSH.
Two transfer methods: clone (default) and rsync.
Remote runs deploy.sh global independently with its own .env.
Same ownership model (symlinks) on remote. .env never transferred.
deploy-remote.sh is now fully replaced.
  </done>
</task>

</tasks>

<verification>
- deploy.sh passes bash syntax check
- `deploy.sh project` scaffolds a test project correctly
- `deploy.sh global --remote` shows remote deployment logic
- No hardcoded paths, identities, or repo URLs
- Conflict resolution works in both interactive and non-interactive modes
</verification>

<success_criteria>
- DEPL-03: deploy.sh project scaffolds .claude/settings.json, CLAUDE.md, .git/info/exclude
- DEPL-04: Remote deployment works via SSH (clone or rsync)
- DEPL-09: Project type detection adjusts defaults
- Greenfield/brownfield detection works
- Existing CLAUDE.md not blindly overwritten
- deploy-remote.sh fully replaced
</success_criteria>

<output>
After completion, create `.planning/phases/03-settings-hooks-deploy-skills/03-06-SUMMARY.md`
</output>
