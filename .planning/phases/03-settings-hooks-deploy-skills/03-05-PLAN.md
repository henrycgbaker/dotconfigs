---
phase: 03-settings-hooks-deploy-skills
plan: 05
type: execute
wave: 2
depends_on: ["03-01", "03-02", "03-03", "03-04"]
files_modified:
  - deploy.sh
  - .env.example
autonomous: true

must_haves:
  truths:
    - "deploy.sh global with no .env triggers interactive wizard"
    - "deploy.sh global with existing .env deploys silently using saved config"
    - "deploy.sh global --target DIR deploys non-interactively"
    - "deploy.sh global --interactive re-runs wizard even with existing .env"
    - "Wizard has 8 steps: target, settings, CLAUDE.md sections, hooks, skills, GSD, git identity, conflicts"
    - "Dynamic discovery — wizard scans repo dirs, no hardcoded lists"
    - "Symlinks used for all deployed files except CLAUDE.md (which is built)"
    - ".env.example documents every setting with comments"
    - "GSD framework installation offered as optional step"
    - "core.hooksPath set globally to deploy target git-hooks directory"
  artifacts:
    - path: "deploy.sh"
      provides: "Main deployment script with global subcommand"
      contains: "deploy.sh global"
      min_lines: 200
    - path: ".env.example"
      provides: "Documented configuration template"
      contains: "DEPLOY_TARGET"
  key_links:
    - from: "deploy.sh"
      to: "scripts/lib/wizard.sh"
      via: "source for interactive prompts"
      pattern: "source.*lib/wizard"
    - from: "deploy.sh"
      to: "scripts/lib/symlinks.sh"
      via: "source for symlink operations"
      pattern: "source.*lib/symlinks"
    - from: "deploy.sh"
      to: "scripts/lib/discovery.sh"
      via: "source for dynamic scanning"
      pattern: "source.*lib/discovery"
    - from: "deploy.sh"
      to: "templates/claude-md/"
      via: "build_claude_md assembles from templates"
      pattern: "templates/claude-md"
    - from: "deploy.sh"
      to: "settings.json"
      via: "symlinked to deploy target"
      pattern: "settings.json"
---

<objective>
Create deploy.sh with the global subcommand, interactive wizard, and .env-driven configuration.

Purpose: This is the core deployment system (DEPL-01 through DEPL-08, GHYG-01, GHYG-02). deploy.sh replaces both setup.sh and deploy-remote.sh. The global subcommand sets up ~/.claude/ with settings, CLAUDE.md, hooks, skills, and git hooks. The wizard provides an interactive first-run experience; subsequent runs read .env silently.

Output: deploy.sh with global subcommand fully working, .env.example documenting all settings.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-settings-hooks-deploy-skills/03-01-SUMMARY.md
@.planning/phases/03-settings-hooks-deploy-skills/03-04-SUMMARY.md
@setup.sh
@deploy-remote.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deploy.sh with global subcommand and wizard</name>
  <files>deploy.sh</files>
  <action>
Create deploy.sh as the single deployment script replacing setup.sh and deploy-remote.sh. This task implements the `global` subcommand only (project and remote come in Plan 06).

**Script structure:**

```bash
#!/bin/bash
# deploy.sh — Deploy dotclaude configuration
# Usage: deploy.sh global [--interactive] [--target DIR]
#        deploy.sh project [path] [--interactive]
#        deploy.sh --help
set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ENV_FILE="$SCRIPT_DIR/.env"

# Source shared libraries
source "$SCRIPT_DIR/scripts/lib/wizard.sh"
source "$SCRIPT_DIR/scripts/lib/symlinks.sh"
source "$SCRIPT_DIR/scripts/lib/discovery.sh"
```

**Subcommand routing:**
- `deploy.sh` (no args) → show usage/help
- `deploy.sh global` → global deployment
- `deploy.sh project [path]` → project scaffolding (stub for now, implemented in Plan 06)
- `deploy.sh --help` → show help

**Global deploy flow:**

1. Parse flags: `--interactive` (force wizard), `--target DIR` (non-interactive target override)
2. Load or create config:
   - If `--target` flag provided: non-interactive mode, use flag values, skip wizard
   - If `.env` exists and no `--interactive` flag: load .env silently, proceed to deploy
   - If no `.env` or `--interactive` flag: run wizard, save to .env
3. Deploy artefacts based on .env config

**Wizard (8 steps per user decision):**

Step 1: Deploy target — where to deploy (~/.claude/ default, or custom path)
Step 2: Settings.json — symlink global settings.json to deploy target
Step 3: CLAUDE.md sections — show discovered sections, toggle each on/off, build CLAUDE.md from enabled templates
Step 4: Hooks — show discovered Claude Code hooks (from hooks/), enable/disable each, symlink enabled ones
Step 5: Skills — show discovered skills (from commands/), enable/disable each, symlink enabled ones
Step 6: GSD — offer to install GSD framework (`npx get-shit-done-cc --claude --global`)
Step 7: Git identity — configure git user.name and user.email globally (or skip to use existing)
Step 8: Conflict review — scan deploy target for existing files, show which are dotclaude-owned vs foreign, handle conflicts

**Deploy operations (after config loaded):**

1. Create deploy target directory if needed
2. Symlink settings.json → `$DEPLOY_TARGET/settings.json`
3. Build CLAUDE.md from enabled templates → write to `$DEPLOY_TARGET/CLAUDE.md` (NOT symlinked — built per user decision)
4. Create `$DEPLOY_TARGET/hooks/` directory, symlink enabled Claude Code hooks
5. Create `$DEPLOY_TARGET/commands/` directory, symlink enabled skills
6. Create `$DEPLOY_TARGET/git-hooks/` directory, copy git hooks from githooks/ (these are copies not symlinks — they go into a core.hooksPath managed dir)
7. Set `git config --global core.hooksPath "$DEPLOY_TARGET/git-hooks/"` for global git hook deployment
8. Run GSD install if enabled: `npx get-shit-done-cc --claude --global`
9. Configure git identity if provided: `git config --global user.name` and `git config --global user.email`
10. Handle .git/info/exclude for the dotclaude repo itself (GHYG-01): add CLAUDE.md and .claude/ entries

**build_claude_md function:**
Read .env flags (CLAUDE_COMMUNICATION, CLAUDE_SIMPLICITY, CLAUDE_DOCUMENTATION, CLAUDE_GIT, CLAUDE_CODE_STYLE — all default to true). Concatenate enabled section templates from templates/claude-md/ in numeric order. Write to output file. Add a blank line between sections.

**Key requirements:**
- Symlinks always point back to dotclaude repo (per user decision — ownership mechanism)
- CLAUDE.md is built, not symlinked (per user decision — the ONE exception)
- Git hooks in git-hooks/ are COPIES (they go to core.hooksPath which Git manages)
- Dynamic discovery: wizard scans repo dirs for available hooks/skills/sections
- Non-interactive mode: all operations from flags/env only, no prompts
- Conflict resolution: interactive → warn/overwrite/skip/backup. Non-interactive → skip conflicts.

**Do NOT include:**
- Project subcommand (Plan 06)
- Remote deployment (Plan 06)
- These should be stubs that print "Not yet implemented" or similar

Mark deploy.sh as executable.
  </action>
  <verify>
Syntax check: `bash -n deploy.sh && echo "Syntax OK"`

Check subcommand routing: `grep -c "global\|project\|--help" deploy.sh`

Check wizard steps: `grep -c "Step [1-8]" deploy.sh`

Check lib sourcing: `grep "source.*scripts/lib" deploy.sh | wc -l` should be 3

Check build_claude_md function: `grep "build_claude_md" deploy.sh`

Check core.hooksPath: `grep "core.hooksPath" deploy.sh`

Check CLAUDE.md is built not symlinked: `grep -A2 "CLAUDE.md" deploy.sh | grep -v "ln -sfn.*CLAUDE"`

Check no hardcoded paths: `! grep -E "~/Repositories|henrycgbaker|henry.c.g.baker" deploy.sh && echo "No hardcoded values"`

Check executable: `test -x deploy.sh && echo "Executable"`
  </verify>
  <done>
deploy.sh exists with global subcommand, 8-step wizard, .env-driven config, non-interactive mode.
Sources shared lib functions. Dynamic discovery for all artefacts.
Symlinks for all files except CLAUDE.md (built from templates).
Git hooks deployed via core.hooksPath.
Project and remote subcommands are stubs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create .env.example with all settings documented</name>
  <files>.env.example</files>
  <action>
Create .env.example documenting every setting that deploy.sh reads, with comments explaining each one and showing defaults.

```bash
# dotclaude configuration
# Generated by: deploy.sh global (wizard)
# This file is gitignored — each machine has its own .env
# Re-run wizard: deploy.sh global --interactive

# ============================================================
# Deploy Target
# ============================================================
# Where to deploy dotclaude configuration
DEPLOY_TARGET=~/.claude

# ============================================================
# CLAUDE.md Sections
# ============================================================
# Toggle which sections are included in the built CLAUDE.md
# Each maps to a template in templates/claude-md/
CLAUDE_COMMUNICATION=true
CLAUDE_SIMPLICITY=true
CLAUDE_DOCUMENTATION=true
CLAUDE_GIT=true
CLAUDE_CODE_STYLE=true

# ============================================================
# Hooks (Claude Code)
# ============================================================
# Space-separated list of enabled Claude Code hooks
# Available hooks are discovered from hooks/ directory
HOOKS_ENABLED=post-tool-format.py

# ============================================================
# Skills (Commands)
# ============================================================
# Space-separated list of enabled skills/commands
# Available skills are discovered from commands/ directory
SKILLS_ENABLED=commit squash-merge simplicity-check

# ============================================================
# Git Hooks
# ============================================================
# Space-separated list of enabled git hooks
# Available hooks are discovered from githooks/ directory
# Deployed to $DEPLOY_TARGET/git-hooks/ via core.hooksPath
GITHOOKS_ENABLED=commit-msg pre-commit

# ============================================================
# GSD Framework
# ============================================================
# Install GSD framework (npx get-shit-done-cc --claude --global)
GSD_INSTALL=false

# ============================================================
# Git Identity
# ============================================================
# Leave empty to use existing git config
GIT_USER_NAME=
GIT_USER_EMAIL=

# ============================================================
# Registry Scanner
# ============================================================
# Comma-separated paths to scan for project .claude/ directories
# Used by scripts/registry-scan.sh
SCAN_PATHS=
```

Also ensure `.env` is in .gitignore. Check the existing .gitignore and add `.env` if not already present.
  </action>
  <verify>
Check .env.example exists: `test -f .env.example && echo "exists"`

Check all key settings documented: `grep -c "DEPLOY_TARGET\|CLAUDE_\|HOOKS_ENABLED\|SKILLS_ENABLED\|GSD_INSTALL\|GIT_USER_NAME\|SCAN_PATHS" .env.example`

Check .env is gitignored: `grep "^\.env$" .gitignore || echo ".env NOT in gitignore"`

Source test: `bash -c "source .env.example && echo DEPLOY_TARGET=\$DEPLOY_TARGET"` should output the default
  </verify>
  <done>
.env.example documents all deploy.sh settings with comments and defaults.
.env is gitignored to keep per-machine config private.
Settings cover: deploy target, CLAUDE.md sections, hooks, skills, git hooks, GSD, git identity, scan paths.
  </done>
</task>

</tasks>

<verification>
- deploy.sh passes bash syntax check
- deploy.sh is executable
- .env.example is sourceable and documents all settings
- deploy.sh sources all three lib scripts
- Wizard has 8 numbered steps
- build_claude_md assembles from templates
- core.hooksPath configured during deploy
- No hardcoded paths or identities
</verification>

<success_criteria>
- DEPL-01: deploy.sh with no flags shows usage (wizard via `deploy.sh global`)
- DEPL-02: Non-interactive mode works with --target flag
- DEPL-05: .env.example documents all settings
- DEPL-06: GSD install offered as optional step
- DEPL-07: AI artefacts excluded via .git/info/exclude (GHYG-01)
- DEPL-08: core.hooksPath set globally (GHYG-02)
- Settings.json symlinked to deploy target
- CLAUDE.md built from templates
- Skills and hooks symlinked to deploy target
</success_criteria>

<output>
After completion, create `.planning/phases/03-settings-hooks-deploy-skills/03-05-SUMMARY.md`
</output>
