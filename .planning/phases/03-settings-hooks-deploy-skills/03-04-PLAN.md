---
phase: 03-settings-hooks-deploy-skills
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - commands/commit.md
  - commands/squash-merge.md
  - commands/simplicity-check.md
  - scripts/lib/wizard.sh
  - scripts/lib/symlinks.sh
  - scripts/lib/discovery.sh
autonomous: true

must_haves:
  truths:
    - "/commit skill works for both branch commits (relaxed) and main commits (conventional)"
    - "/squash-merge skill guides through full squash merge workflow"
    - "/simplicity-check skill available for on-demand complexity review"
    - "No stale references to /rules/ in any skill"
    - "Shared lib functions exist for wizard prompts, symlink management, and dynamic discovery"
  artifacts:
    - path: "commands/commit.md"
      provides: "/commit skill"
      contains: "conventional commit"
    - path: "commands/squash-merge.md"
      provides: "/squash-merge skill"
      contains: "squash merge"
    - path: "commands/simplicity-check.md"
      provides: "/simplicity-check skill"
      contains: "simplicity"
    - path: "scripts/lib/wizard.sh"
      provides: "Wizard prompt functions for deploy.sh"
      contains: "select"
    - path: "scripts/lib/symlinks.sh"
      provides: "Symlink and ownership functions"
      contains: "is_dotclaude_owned"
    - path: "scripts/lib/discovery.sh"
      provides: "Dynamic repo scanning functions"
      contains: "discover_hooks"
  key_links:
    - from: "scripts/lib/symlinks.sh"
      to: "deploy.sh"
      via: "sourced by deploy.sh for symlink operations"
      pattern: "source.*lib/symlinks"
    - from: "scripts/lib/discovery.sh"
      to: "deploy.sh"
      via: "sourced by deploy.sh for dynamic scanning"
      pattern: "source.*lib/discovery"
---

<objective>
Update the three skills (/commit, /squash-merge, /simplicity-check) and create the shared bash library functions that deploy.sh will source.

Purpose: Skills need stale references fixed and a new /simplicity-check created. The shared lib functions (wizard.sh, symlinks.sh, discovery.sh) are foundational for the deploy system — they must exist before deploy.sh can be written.

Output: 3 updated/new skill files, 3 shared library scripts.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@commands/commit.md
@commands/squash-merge.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update skills and create /simplicity-check</name>
  <files>
    commands/commit.md
    commands/squash-merge.md
    commands/simplicity-check.md
  </files>
  <action>
**commands/commit.md** — Fix stale reference:
- Line 43: `See rule: git-commits` — remove this line entirely (rules/ directory no longer exists, all rules are in CLAUDE.md)
- Everything else stays the same. The skill content is good.

**commands/squash-merge.md** — Fix stale reference:
- Line 67: `- See \`/rules/git-commits.md\` for commit conventions` — change to `- See CLAUDE.md Git section for commit conventions`
- Everything else stays the same.

**commands/simplicity-check.md** — Create NEW skill for on-demand complexity review (QUAL-02):
```markdown
---
description: Review code or architecture for unnecessary complexity
allowed-tools: Bash, Read, Grep, Glob
argument-hint: [file, directory, or description of concern]
---

# Simplicity Check

Review code or architecture against simplicity principles.

## Principles

1. **Solve only what was asked** — no premature abstractions (only generalise at 3+ similar implementations)
2. **No backwards-compatibility shims** — if code can just change, change it
3. **No hypothetical future requirements** — don't build "just in case" configurability
4. **Validate at system edges only** — trust internal code

## Process

### 1. Identify Scope

If $ARGUMENTS provided, use as target. Otherwise ask what to review.

### 2. Read and Analyse

Read the target code/files. For each file, check:

- [ ] Over-abstraction: Are there interfaces/abstractions with only one implementation?
- [ ] Premature generalisation: Are there config options nobody uses?
- [ ] Defensive overkill: Is there internal validation that duplicates edge validation?
- [ ] Speculative features: Is there code for requirements that don't exist yet?
- [ ] Layer bloat: Are there unnecessary indirection layers?

### 3. Report

For each issue found:
- **What**: Describe the unnecessary complexity
- **Where**: File and line range
- **Why it's unnecessary**: Which principle it violates
- **Suggested fix**: How to simplify (usually: delete it)

### 4. Summary

Rate overall simplicity: Simple / Acceptable / Over-engineered
List top 3 simplification opportunities if any exist.

## Notes

- This is an advisory review, not an automated fix
- Focus on structural complexity, not code style (Ruff handles style)
- "Could we delete this and nothing breaks?" is the key question
```
  </action>
  <verify>
Check no stale /rules/ references remain: `! grep -r "/rules/" commands/ && echo "No stale references"`

Check simplicity-check exists: `test -f commands/simplicity-check.md && echo "simplicity-check exists"`

Check all three skills have frontmatter: `for f in commands/commit.md commands/squash-merge.md commands/simplicity-check.md; do head -1 "$f" | grep -q "^---" && echo "OK: $f"; done`
  </verify>
  <done>
/commit and /squash-merge updated with stale /rules/ references removed.
/simplicity-check created as new on-demand complexity review skill.
All three skills have valid frontmatter and are ready for symlink deployment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create shared bash library functions</name>
  <files>
    scripts/lib/wizard.sh
    scripts/lib/symlinks.sh
    scripts/lib/discovery.sh
  </files>
  <action>
Create `scripts/lib/` directory with three shared bash libraries that deploy.sh will source.

**scripts/lib/wizard.sh** — Interactive wizard helper functions:
- `wizard_prompt()` — Display a prompt and read user input with a default value. Args: prompt_text, default_value, variable_name.
- `wizard_select()` — Display a bash `select` menu and return the choice. Args: prompt_text, options_array.
- `wizard_yesno()` — Ask a yes/no question with default. Args: prompt_text, default (y/n). Returns 0 for yes, 1 for no.
- `wizard_header()` — Print a formatted step header. Args: step_number, step_title.
- `wizard_save_env()` — Append a key=value pair to .env file. Args: env_file, key, value.

Use bash `select` for menus (per research — no external dependencies). Use `read -p` for text prompts. Keep it simple — no curses, no dialog.

**scripts/lib/symlinks.sh** — Symlink management and ownership detection:
- `is_dotclaude_owned()` — Check if a file is a symlink pointing to the dotclaude repo. Args: target_path, dotclaude_path. Uses `readlink` with macOS portability (no `-f` on macOS, check `$OSTYPE`). Returns 0 if owned.
- `backup_and_link()` — Create a symlink with conflict handling. Args: src, dest, name, interactive (true/false). If dest exists and is owned by dotclaude: overwrite silently. If dest exists and NOT owned: in interactive mode, prompt (overwrite/skip/backup); in non-interactive mode, skip. If dest doesn't exist: create symlink.
- `link_file()` — Simple symlink creation wrapper. Args: src, dest. Creates parent directory if needed, then `ln -sfn`.

macOS portability: Use `readlink` without `-f` on darwin, with `-f` on linux. Check `$OSTYPE` for detection.

**scripts/lib/discovery.sh** — Dynamic scanning of dotclaude repo contents:
- `discover_hooks()` — Find available Claude Code hooks in hooks/ directory. Returns list of hook filenames.
- `discover_githooks()` — Find available git hooks in githooks/ directory. Returns list of hook filenames.
- `discover_skills()` — Find available skills in commands/ directory. Returns list of skill filenames (without .md extension).
- `discover_claude_sections()` — Find available CLAUDE.md section templates in templates/claude-md/. Returns list of section names (extracted from filename, e.g., "01-communication.md" → "communication").
- `discover_settings_templates()` — Find available settings templates in templates/settings/. Returns list of template names.

All discovery functions: scan filesystem dynamically, no hardcoded lists. New files added to repo directories automatically appear. Each function takes the dotclaude repo root as argument.

All three files should start with:
```bash
#!/bin/bash
# scripts/lib/{name}.sh — {purpose}
# Sourced by deploy.sh. Do not execute directly.
```

Functions should use local variables to avoid polluting the caller's namespace.
  </action>
  <verify>
Syntax check all lib files: `for f in scripts/lib/*.sh; do bash -n "$f" && echo "OK: $f"; done`

Check key functions exist:
- `grep "is_dotclaude_owned" scripts/lib/symlinks.sh`
- `grep "backup_and_link" scripts/lib/symlinks.sh`
- `grep "wizard_select\|wizard_yesno" scripts/lib/wizard.sh`
- `grep "discover_hooks\|discover_skills" scripts/lib/discovery.sh`

Check macOS portability: `grep "OSTYPE\|darwin" scripts/lib/symlinks.sh`

Check no hardcoded paths: `! grep -E "~/Repositories|~/dotclaude|henrycgbaker" scripts/lib/*.sh && echo "No hardcoded paths"`
  </verify>
  <done>
scripts/lib/wizard.sh provides interactive prompt functions using bash select.
scripts/lib/symlinks.sh provides symlink creation with ownership detection and macOS portability.
scripts/lib/discovery.sh provides dynamic scanning functions for all deployable artefacts.
All pass bash syntax check. No hardcoded paths or identities.
  </done>
</task>

</tasks>

<verification>
- All 6 files exist and pass syntax checks
- No stale /rules/ references in commands/
- /simplicity-check skill has valid frontmatter
- Lib functions use local variables and take repo root as argument
- No hardcoded paths or identities in any file
</verification>

<success_criteria>
- SKIL-01: /commit works for branch and main commits (stale ref fixed)
- SKIL-02: /squash-merge guides through workflow (stale ref fixed)
- QUAL-02: /simplicity-check available for complexity review (created)
- Shared lib functions ready for deploy.sh to source
</success_criteria>

<output>
After completion, create `.planning/phases/03-settings-hooks-deploy-skills/03-04-SUMMARY.md`
</output>
