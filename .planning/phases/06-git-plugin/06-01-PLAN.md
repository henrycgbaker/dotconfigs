---
phase: 06-git-plugin
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - plugins/git/hooks/commit-msg
  - plugins/git/hooks/pre-push
  - plugins/claude/deploy.sh
autonomous: true

must_haves:
  truths:
    - "Git hooks (commit-msg, pre-push) exist under plugins/git/hooks/ ready for deployment"
    - "Claude plugin deploy.sh no longer manages git hooks or sets core.hooksPath"
    - "commit-msg hook validates conventional commit format and blocks AI attribution"
    - "pre-push hook protects main/master from force-push with configurable warn/block/off"
  artifacts:
    - path: "plugins/git/hooks/commit-msg"
      provides: "Conventional commit validation + AI attribution blocking"
      contains: "CONVENTIONAL_COMMITS"
    - path: "plugins/git/hooks/pre-push"
      provides: "Branch protection from force-push"
      contains: "PROTECTED_BRANCHES"
    - path: "plugins/claude/deploy.sh"
      provides: "Claude deploy without git hook management"
  key_links:
    - from: "plugins/git/hooks/commit-msg"
      to: ".claude/hooks.conf"
      via: "source config file"
      pattern: "HOOK_CONFIG.*hooks\\.conf"
    - from: "plugins/git/hooks/pre-push"
      to: ".env"
      via: "GIT_HOOK_PREPUSH_PROTECTION env var"
      pattern: "GIT_HOOK_PREPUSH_PROTECTION"
---

<objective>
Create git hook templates under plugins/git/hooks/ and decouple git-hook management from the Claude plugin.

Purpose: The existing commit-msg hook lives in `githooks/` and is deployed by the Claude plugin via `core.hooksPath`. This must move to the git plugin so hooks are managed by the right plugin. The pre-push hook is new (branch protection).

Output: `plugins/git/hooks/commit-msg`, `plugins/git/hooks/pre-push`, cleaned Claude deploy.sh
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@plugins/claude/deploy.sh
@githooks/commit-msg
@githooks/pre-commit
@.planning/phases/06-git-plugin/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create git plugin hook templates</name>
  <files>plugins/git/hooks/commit-msg, plugins/git/hooks/pre-push</files>
  <action>
Create `plugins/git/hooks/` directory and two hook scripts.

**commit-msg** -- Adapt the existing `githooks/commit-msg` with these changes:
- Keep the AI attribution blocking section (always enforced, same patterns)
- Keep the conventional commit validation section
- Update the header comment to reference `plugins/git/hooks/commit-msg` as source of truth (not `dotclaude/githooks/commit-msg`)
- The hook should still load per-project config from `$REPO_ROOT/.claude/hooks.conf` for the CONVENTIONAL_COMMITS toggle (backward compatible)
- Handle merge commits: skip validation when `MERGE_HEAD` exists
- Handle squash merges: skip WIP blocking when `SQUASH_MSG` exists (same as current)
- Use the conventional commit regex from research: `^(feat|fix|docs|style|refactor|test|chore|build|ci|perf|revert)(\([a-zA-Z0-9_.-]+\))?(!)?:\s.+$`
- Keep the 72-char subject line warning
- Must have `#!/bin/bash` and be executable-ready (chmod +x will be handled by deploy)

**pre-push** -- New hook for branch protection:
- `#!/bin/bash` header
- Read `GIT_HOOK_PREPUSH_PROTECTION` from environment (default: `warn`). The deploy script will inject this via a config mechanism, but the hook should also check `$REPO_ROOT/.claude/hooks.conf` as fallback for per-project override.
- Protected branches regex: `^(main|master)$`
- Detect current branch via `git symbolic-ref HEAD`
- Detect force push by reading stdin (pre-push hook receives `<local ref> <local sha1> <remote ref> <remote sha1>` lines on stdin per the githooks spec). Check if the push would delete a ref (local sha is all zeros) or if the command includes force flags by checking `ps -ocommand= -p $PPID`.
- If protection is "block": exit 1 with error message
- If protection is "warn": print warning, allow push
- If protection is "off": do nothing
- Exit 0 on success

Both hooks should NOT have shebangs stripped (unlike lib/ files, hooks ARE executables).
  </action>
  <verify>
Run: `test -f plugins/git/hooks/commit-msg && test -f plugins/git/hooks/pre-push && echo "hooks exist"`
Run: `head -1 plugins/git/hooks/commit-msg` should show `#!/bin/bash`
Run: `head -1 plugins/git/hooks/pre-push` should show `#!/bin/bash`
Run: `grep -c "AI_PATTERNS" plugins/git/hooks/commit-msg` should return 1
Run: `grep -c "PROTECTED_BRANCHES" plugins/git/hooks/pre-push` should return 1
  </verify>
  <done>Both hook templates exist under plugins/git/hooks/ with correct structure, commit-msg has AI attribution + conventional commit validation, pre-push has configurable branch protection.</done>
</task>

<task type="auto">
  <name>Task 2: Decouple git hooks from Claude plugin deploy</name>
  <files>plugins/claude/deploy.sh</files>
  <action>
Edit `plugins/claude/deploy.sh` to remove the git-hooks management section (currently section 5, lines 164-183) and the git identity section (section 6, lines 185-194).

Specifically remove:
1. Section 5: "Copy git hooks and set core.hooksPath" -- the block that copies from `$DOTCONFIGS_ROOT/githooks/` to `~/.claude/git-hooks/` and calls `git config --global core.hooksPath`. This is now the git plugin's responsibility.
2. Section 6: "Configure git identity" -- the block that sets `git config --global user.name` and `git config --global user.email` from `CLAUDE_GIT_USER_*` keys. This moves to the git plugin (GIT_* keys).

Renumber remaining sections. The Claude plugin deploy should now only handle:
- Settings.json symlink
- CLAUDE.md build
- Claude Code hooks (PreToolUse/PostToolUse)
- Skills (commands)
- GSD framework
- .git/info/exclude

Do NOT delete the `githooks/` directory yet -- that cleanup happens in a later phase or can be a minor task. The old hooks remain as reference but are no longer deployed by the Claude plugin.

Also remove `CLAUDE_GIT_USER_NAME` and `CLAUDE_GIT_USER_EMAIL` from `_claude_load_config()` if referenced there (check -- they are read from .env via source, not explicitly parsed, so this may be a no-op).
  </action>
  <verify>
Run: `grep -c "core.hooksPath" plugins/claude/deploy.sh` should return 0
Run: `grep -c "git config --global user" plugins/claude/deploy.sh` should return 0
Run: `grep -c "githooks_target" plugins/claude/deploy.sh` should return 0
Run: `grep -c "plugin_claude_deploy" plugins/claude/deploy.sh` should return 1 (function still exists)
Run: `bash -n plugins/claude/deploy.sh` should exit 0 (valid syntax)
  </verify>
  <done>Claude plugin deploy.sh no longer manages git hooks (no core.hooksPath), no longer sets git identity, and remains syntactically valid with all other Claude deployment functionality intact.</done>
</task>

</tasks>

<verification>
1. `plugins/git/hooks/commit-msg` and `plugins/git/hooks/pre-push` exist with proper bash headers
2. `plugins/claude/deploy.sh` has zero references to `core.hooksPath`, `githooks`, or `git config --global user`
3. Both new hook scripts pass `bash -n` syntax check
4. Claude plugin deploy still has its core functionality (settings, CLAUDE.md, Claude hooks, skills, GSD)
</verification>

<success_criteria>
- Git hook templates ready for deployment by the git plugin
- Claude plugin cleanly separated from git-hook management
- No broken references in either plugin
</success_criteria>

<output>
After completion, create `.planning/phases/06-git-plugin/06-01-SUMMARY.md`
</output>
