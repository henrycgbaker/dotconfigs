---
phase: 06-git-plugin
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - plugins/git/setup.sh
autonomous: true

must_haves:
  truths:
    - "dotconfigs setup git presents a grouped menu with Identity, Workflow, Aliases, Hooks sections"
    - "Menu shows configured vs not-configured status per section"
    - "Configure All walks through every section sequentially"
    - "Done -- save and exit shows summary and confirms before writing .env"
    - "Wizard pre-fills from .env values, or from git config on first run"
    - "All settings default to enabled (opinionated defaults, user opts out)"
    - "Custom aliases can be added via wizard"
  artifacts:
    - path: "plugins/git/setup.sh"
      provides: "Git plugin setup wizard with grouped menu"
      contains: "plugin_git_setup"
      min_lines: 150
  key_links:
    - from: "plugins/git/setup.sh"
      to: "lib/wizard.sh"
      via: "wizard_prompt, wizard_yesno, wizard_header, wizard_save_env"
      pattern: "wizard_(prompt|yesno|header|save_env)"
    - from: "plugins/git/setup.sh"
      to: ".env"
      via: "_git_save_config writing GIT_* keys"
      pattern: "GIT_USER_NAME|GIT_USER_EMAIL|GIT_ALIASES_ENABLED"
---

<objective>
Create the git plugin setup wizard with grouped menu navigation.

Purpose: Users configure git identity, workflow settings, aliases, and hook preferences through an interactive menu that lets them pick sections to configure individually or all at once. This follows the established plugin pattern but uses a menu (not linear steps) per user decision.

Output: `plugins/git/setup.sh` with `plugin_git_setup()` function
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@plugins/claude/setup.sh
@lib/wizard.sh
@.planning/phases/06-git-plugin/06-CONTEXT.md
@.planning/phases/06-git-plugin/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create git plugin setup wizard</name>
  <files>plugins/git/setup.sh</files>
  <action>
Create `plugins/git/setup.sh` following the established plugin pattern from `plugins/claude/setup.sh`.

**File structure:**
```
# plugins/git/setup.sh -- Git configuration setup wizard
# Sourced by dotconfigs entry point. Do not execute directly.
```

No shebang (sourced library, not executable -- per decision [04-01]).

**Internal helper functions** (prefix with `_git_`):

1. `_git_wizard_identity()` -- Identity section
   - Pre-fill: check `$GIT_USER_NAME` from .env first. If empty, fall back to `git config --global --get user.name` (first-run pre-fill from existing git config per locked decision).
   - Same pattern for email: `$GIT_USER_EMAIL` then `git config --global --get user.email`.
   - Use `wizard_prompt` for name and email inputs.
   - Store results in `GIT_USER_NAME` and `GIT_USER_EMAIL` variables.

2. `_git_wizard_workflow()` -- Workflow settings section
   - **Core settings (enabled by default, user opts out):**
     - `pull.rebase = true` (GIT_PULL_REBASE, default: "true")
     - `push.default = simple` (GIT_PUSH_DEFAULT, default: "simple")
     - `fetch.prune = true` (GIT_FETCH_PRUNE, default: "true")
     - `init.defaultBranch = main` (GIT_INIT_DEFAULT_BRANCH, default: "main")
   - **Advanced settings (opt-in, disabled by default):**
     - `rerere.enabled = true` (GIT_RERERE_ENABLED, default: "false")
     - `diff.algorithm = histogram` (GIT_DIFF_ALGORITHM, default: "")
     - `help.autocorrect = 10` (GIT_HELP_AUTOCORRECT, default: "")
   - Use `wizard_yesno` for each setting toggle. Pre-fill from .env values.
   - For defaultBranch, use `wizard_prompt` so user can change the name (not just toggle).

3. `_git_wizard_aliases()` -- Aliases section
   - **Default aliases** (all enabled by default, user can disable any):
     - `unstage` = `reset HEAD --`
     - `last` = `log -1 HEAD`
     - `lg` = `log --oneline --graph --all --decorate`
     - `amend` = `commit --amend --no-edit`
     - `undo` = `reset HEAD~1 --mixed`
     - `wip` = `commit -am "WIP"`
   - Present each with `wizard_yesno`, default "y" (unless previously disabled in .env).
   - .env storage format (Claude's discretion, research recommendation): use `GIT_ALIASES_ENABLED` as a space-separated list of enabled alias names, plus individual `GIT_ALIAS_<UPPERCASE_NAME>` keys for each alias definition.
   - Pre-fill enabled list from `$GIT_ALIASES_ENABLED`. If not set, all defaults are enabled.
   - **Custom aliases:** After defaults, ask `wizard_yesno "Add custom aliases?" "n"`. If yes, loop: prompt for alias name and command. **Validate each custom alias name against a blacklist array of git built-in commands** -- define `GIT_BUILTIN_COMMANDS=(commit push pull fetch merge rebase checkout switch branch status log diff add rm mv reset tag stash clone init remote show bisect grep blame)` at the top of the function, then iterate the array to check `if [[ "$alias_name" == "$cmd" ]]` for each entry. If the name matches a built-in, print error "Cannot create alias '$alias_name' -- conflicts with git built-in command" and re-prompt. Store valid custom aliases as `GIT_ALIAS_<UPPERCASE_NAME>`. Break loop when user enters empty name.
   - Append custom alias names to the enabled list.

4. `_git_wizard_hooks()` -- Hooks section
   - `GIT_HOOKS_SCOPE`: "project" (default) or "global". Use `wizard_yesno "Deploy hooks per-project (recommended)?" "y"`. If no (user selects global), set to "global" and **print explicit conflict warning: `echo "Note: Global hooks via core.hooksPath override ALL per-project hooks in .git/hooks/"` followed by `echo "This affects Husky, pre-commit framework, and any project-specific hooks."`** This warning is required per the locked decision "Global hook deployment via core.hooksPath opt-in with conflict warning".
   - `GIT_HOOK_PREPUSH_PROTECTION`: "warn" (default), "block", or "off". Use bash `select` with these three options.
   - `GIT_HOOK_CONVENTIONAL_COMMITS`: default "true". Use `wizard_yesno`.

5. `_git_save_config()` -- Save all GIT_* keys to .env
   - Use `wizard_save_env` for each key (same pattern as `_claude_save_config`).
   - Ensure .env exists with header if not present.
   - Keys to save: GIT_USER_NAME, GIT_USER_EMAIL, GIT_PULL_REBASE, GIT_PUSH_DEFAULT, GIT_FETCH_PRUNE, GIT_INIT_DEFAULT_BRANCH, GIT_RERERE_ENABLED, GIT_DIFF_ALGORITHM, GIT_HELP_AUTOCORRECT, GIT_ALIASES_ENABLED, each GIT_ALIAS_* key, GIT_HOOKS_SCOPE, GIT_HOOK_PREPUSH_PROTECTION, GIT_HOOK_CONVENTIONAL_COMMITS.

**Main function `plugin_git_setup()`:**
- Derive PLUGIN_DIR from `BASH_SOURCE[0]` (same pattern as Claude plugin)
- Derive REPO_ROOT from `PLUGIN_DIR/../..`
- Set ENV_FILE to `$REPO_ROOT/.env`
- Source .env if exists (for pre-fill)
- Display header banner (same style as Claude plugin but "Git Configuration")
- Enter `while true` menu loop:
  - Show status for each section: check if corresponding .env keys are set
    - Identity: show checkmark if GIT_USER_NAME is set, else show "not configured"
    - Workflow: show checkmark if GIT_PULL_REBASE is set
    - Aliases: show checkmark if GIT_ALIASES_ENABLED is set
    - Hooks: show checkmark if GIT_HOOKS_SCOPE is set
  - Menu options: "Configure Identity", "Configure Workflow Settings", "Configure Aliases", "Configure Hooks", "Configure All", "Done -- save and exit"
  - Use bash `select` for menu (per existing pattern with `wizard_select` or direct `select`)
  - Each option calls the corresponding `_git_wizard_*` function, then `break` to return to menu
  - "Configure All" calls all four wizard functions sequentially, then `break` to return to menu
  - "Done -- save and exit":
    - Show summary of all configured values (same style as Claude plugin summary)
    - Call `wizard_yesno "Save this configuration?" "y"` -- if no, print "Configuration not saved" and return
    - Call `_git_save_config "$ENV_FILE"`
    - Print "Configuration saved" and next steps ("Run 'dotconfigs deploy git' to apply")
    - Return 0

**Bash 3.2 compatibility:** No associative arrays, no namerefs, no bash 4 string ops. Use simple arrays and `_is_in_list` for checking enabled items.
  </action>
  <verify>
Run: `bash -n plugins/git/setup.sh` should exit 0 (valid syntax)
Run: `grep -c "plugin_git_setup" plugins/git/setup.sh` should return at least 1
Run: `grep -c "_git_wizard_identity" plugins/git/setup.sh` should return at least 2 (definition + call)
Run: `grep -c "_git_wizard_workflow" plugins/git/setup.sh` should return at least 2
Run: `grep -c "_git_wizard_aliases" plugins/git/setup.sh` should return at least 2
Run: `grep -c "_git_wizard_hooks" plugins/git/setup.sh` should return at least 2
Run: `grep -c "wizard_save_env" plugins/git/setup.sh` should be > 0
Run: `grep -c "select" plugins/git/setup.sh` should be > 0 (menu uses select)
Run: `grep -c "GIT_ALIASES_ENABLED" plugins/git/setup.sh` should be > 0
Run: `grep -c "core.hooksPath" plugins/git/setup.sh` should be >= 1 (conflict warning)
Run: `grep -c "GIT_BUILTIN_COMMANDS\|built-in command" plugins/git/setup.sh` should be >= 1 (alias validation)
  </verify>
  <done>plugins/git/setup.sh exists with plugin_git_setup() implementing a grouped menu wizard with Identity, Workflow, Aliases, and Hooks sections. Pre-fills from .env (or git config on first run). Opinionated defaults enabled. Global hooks scope shows explicit conflict warning about core.hooksPath overriding per-project hooks. Custom alias names validated against git built-in commands blacklist. Summary + confirm before saving. Valid bash 3.2 syntax.</done>
</task>

</tasks>

<verification>
1. `plugins/git/setup.sh` passes `bash -n` syntax check
2. Contains `plugin_git_setup` function (entry point for CLI routing)
3. Has all four wizard section functions
4. Uses `wizard_save_env` to write GIT_* keys to .env
5. Implements grouped menu with `select`
6. Pre-fills from .env, falls back to git config for identity
7. Shows summary before saving
8. Global hooks scope prints conflict warning about core.hooksPath
9. Custom alias names validated against git built-in commands blacklist
</verification>

<success_criteria>
- `plugin_git_setup` function exists and is callable by the dotconfigs CLI
- Wizard has grouped menu with all four sections + Configure All + Done
- All .env keys use GIT_* prefix
- Opinionated defaults (settings enabled, aliases enabled)
- Summary + confirm pattern consistent with Claude plugin
- Global hooks selection warns about core.hooksPath conflict with per-project hooks
- Custom alias validation rejects names matching git built-in commands
</success_criteria>

<output>
After completion, create `.planning/phases/06-git-plugin/06-02-SUMMARY.md`
</output>
