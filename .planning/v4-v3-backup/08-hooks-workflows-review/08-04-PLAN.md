---
phase: 08-hooks-workflows-review
plan: 04
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - plugins/claude/hooks/block-destructive.sh
  - plugins/claude/templates/settings/hooks.json
autonomous: true

must_haves:
  truths:
    - "PreToolUse hook blocks destructive commands (rm -rf, force push, reset --hard, DROP TABLE)"
    - "PreToolUse hook protects sensitive file paths"
    - "Both checks are independently configurable via CLAUDE_HOOK_* variables"
    - "Hook follows Claude Code hooks API (JSON stdin, JSON stdout, exit 0)"
    - "settings.json template exists with hook configuration for PreToolUse"
  artifacts:
    - path: "plugins/claude/hooks/block-destructive.sh"
      provides: "PreToolUse hook for destructive command blocking and file protection"
      contains: "CLAUDE_HOOK_DESTRUCTIVE_GUARD"
    - path: "plugins/claude/templates/settings/hooks.json"
      provides: "Settings.json hook configuration template for Claude Code"
      contains: "PreToolUse"
  key_links:
    - from: "plugins/claude/templates/settings/hooks.json"
      to: "plugins/claude/hooks/block-destructive.sh"
      via: "command path in hooks config"
      pattern: "block-destructive"
---

<objective>
Create a Claude Code PreToolUse hook for destructive command blocking and file pattern protection, plus the settings.json hook configuration template.

Purpose: This adds a Claude-specific enforcement layer separate from the existing settings.json deny rules (which have known bugs #6699, #8961). The PreToolUse hook provides active interception with configurable deny decisions.

Output: Hook script and settings template ready for deployment.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-hooks-workflows-review/08-RESEARCH.md
@.planning/phases/08-hooks-workflows-review/08-01-SUMMARY.md
@plugins/claude/hooks/post-tool-format.py
@plugins/claude/templates/settings/base.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PreToolUse destructive command guard hook</name>
  <files>plugins/claude/hooks/block-destructive.sh</files>
  <action>
Create `plugins/claude/hooks/block-destructive.sh` — a PreToolUse hook that intercepts Bash tool calls and blocks destructive commands.

**Metadata header:**
```bash
# === METADATA ===
# NAME: block-destructive
# TYPE: claude-hook
# PLUGIN: claude
# DESCRIPTION: Blocks destructive CLI commands and protects sensitive file paths
# CONFIGURABLE: CLAUDE_HOOK_DESTRUCTIVE_GUARD, CLAUDE_HOOK_FILE_PROTECTION
# ================
```

**Script structure:**

1. Must have shebang `#!/bin/bash` (this IS executed, not sourced)

2. **Config loading:**
   - Load from `$CLAUDE_PROJECT_DIR/.claude/claude-hooks.conf` if it exists (project-level)
   - Fall back to `$HOME/.claude/claude-hooks.conf` if it exists (global-level)
   - Defaults: both guards enabled

3. **Read JSON input from stdin** using `jq`:
   ```bash
   INPUT=$(cat)
   TOOL_NAME=$(echo "$INPUT" | jq -r '.tool_name // empty')
   ```

4. **Destructive command guard** (when `CLAUDE_HOOK_DESTRUCTIVE_GUARD=true`):
   - Only check when tool_name is "Bash"
   - Extract command: `COMMAND=$(echo "$INPUT" | jq -r '.tool_input.command // empty')`
   - Block patterns (case-insensitive grep):
     - `rm -rf /` or `rm -rf ~` or `rm -rf $HOME` (only catastrophic rm -rf, not all rm -rf)
     - `git push.*--force` (not --force-with-lease which is safer)
     - `git reset --hard` (without a specific commit — bare `reset --hard` is most dangerous)
     - `git clean -fd` or `git clean -fx`
     - `DROP TABLE|DROP DATABASE|TRUNCATE TABLE` (SQL destructive)
     - `chmod -R 777` (overly permissive)
     - `> /dev/sda` or similar device writes
   - On match: output JSON deny decision and exit 0
   - On no match: exit 0 silently (allow)

5. **File pattern protection** (when `CLAUDE_HOOK_FILE_PROTECTION=true`):
   - Only check when tool_name is "Read" or "Write" or "Edit"
   - Extract file_path: `FILE_PATH=$(echo "$INPUT" | jq -r '.tool_input.file_path // .tool_input.path // empty')`
   - Block patterns:
     - `*.pem` (SSL certificates/keys)
     - `*credentials*`
     - `*secret*` (but NOT `*secrets.md` or documentation)
     - `.env.production` (production env files)
     - `id_rsa|id_ed25519` (SSH private keys)
   - For Write/Edit only (allow Read — reading to analyse is fine):
     - `*.lock` files (package lock files should not be manually edited)
   - On match for write operations: output JSON deny decision
   - On match for read operations with sensitive paths: output JSON ask decision (let user confirm)

6. **JSON output format:**
   ```bash
   jq -n --arg reason "$REASON" '{
       decision: "block",
       reason: $reason
   }'
   ```
   Note: Check the exact Claude Code hooks API format from the research. The output format may be `decision`/`reason` at top level, or nested under `hookSpecificOutput`. Use the pattern from the research:
   ```json
   {"decision": "block", "reason": "..."}
   ```

7. **If no checks trigger:** exit 0 with no output (implicit allow)

**Requirements:**
- Requires `jq` — check with `command -v jq` at top, exit 0 silently if not available (don't block workflow just because jq is missing)
- Bash 3.2 compatible
- Exit 0 always (non-zero exits cause errors in Claude Code)
  </action>
  <verify>
- `bash -n plugins/claude/hooks/block-destructive.sh` passes
- `grep '=== METADATA ===' plugins/claude/hooks/block-destructive.sh` finds metadata
- `grep 'CLAUDE_HOOK_DESTRUCTIVE_GUARD' plugins/claude/hooks/block-destructive.sh` finds config var
- `grep 'CLAUDE_HOOK_FILE_PROTECTION' plugins/claude/hooks/block-destructive.sh` finds config var
- `grep 'jq' plugins/claude/hooks/block-destructive.sh` confirms jq usage
- `grep -E 'local -n|declare -n' plugins/claude/hooks/block-destructive.sh` returns nothing
- `head -1 plugins/claude/hooks/block-destructive.sh` shows `#!/bin/bash` shebang
- File is executable: `test -x plugins/claude/hooks/block-destructive.sh || chmod +x plugins/claude/hooks/block-destructive.sh`
  </verify>
  <done>block-destructive.sh PreToolUse hook created with destructive command guard and file protection, configurable via CLAUDE_HOOK_* variables, jq-based JSON processing.</done>
</task>

<task type="auto">
  <name>Task 2: Create settings.json hooks template</name>
  <files>plugins/claude/templates/settings/hooks.json</files>
  <action>
Create `plugins/claude/templates/settings/hooks.json` — a settings.json overlay that configures Claude Code hooks to use the block-destructive.sh script.

**Content:**
```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "command",
            "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/block-destructive.sh",
            "timeout": 10
          }
        ]
      },
      {
        "matcher": "Write|Edit",
        "hooks": [
          {
            "type": "command",
            "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/block-destructive.sh",
            "timeout": 10
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "Write|Edit",
        "hooks": [
          {
            "type": "command",
            "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/post-tool-format.py",
            "timeout": 30
          }
        ]
      }
    ]
  }
}
```

**Important notes:**
- The `$CLAUDE_PROJECT_DIR` variable is a Claude Code built-in that resolves to the project root
- The template includes both the NEW PreToolUse hook AND the EXISTING PostToolUse hook (post-tool-format.py) so it can serve as a complete hooks overlay
- The timeout for PreToolUse is short (10s) since it's a blocking check
- PostToolUse timeout remains 30s for Ruff formatting
- Two PreToolUse entries: one for Bash (command guard), one for Write/Edit (file protection)

This template will be merged into settings.json during deploy (using the existing `_claude_merge_settings_json` function in claude/project.sh).
  </action>
  <verify>
- `cat plugins/claude/templates/settings/hooks.json | jq .` validates as JSON
- `grep 'PreToolUse' plugins/claude/templates/settings/hooks.json` finds the hook config
- `grep 'block-destructive' plugins/claude/templates/settings/hooks.json` finds the script reference
- `grep 'post-tool-format' plugins/claude/templates/settings/hooks.json` includes existing hook
  </verify>
  <done>hooks.json template exists with PreToolUse entries for both Bash and Write/Edit matchers, plus existing PostToolUse configuration. Ready for merge into project settings.json.</done>
</task>

</tasks>

<verification>
1. `bash -n plugins/claude/hooks/block-destructive.sh` passes
2. `jq . plugins/claude/templates/settings/hooks.json` validates JSON
3. Both files reference each other correctly (hooks.json points to block-destructive.sh)
4. No bash 4+ features in hook script
</verification>

<success_criteria>
- PreToolUse hook blocks destructive commands and protects sensitive files
- settings.json hooks template configures both PreToolUse and PostToolUse
- Both checks configurable via CLAUDE_HOOK_* variables
- Hook follows Claude Code hooks API correctly
- jq dependency handled gracefully (silent skip if missing)
</success_criteria>

<output>
After completion, create `.planning/phases/08-hooks-workflows-review/08-04-SUMMARY.md`
</output>
