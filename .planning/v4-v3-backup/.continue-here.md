---
phase: project-initialization
step: requirements-definition
status: in_progress
last_updated: 2026-02-06
branch: refactor/lean-claude-setup
---

<current_state>
We're mid-way through `/gsd:new-project` for the dotclaude repo refactor. PROJECT.md, config.json, and research are all committed. We just started requirements definition but paused before completing it.

The user clarified: **all features in a single v1, across multiple phases** (not multiple version releases). So scope every feature discussed as a v1 requirement.
</current_state>

<completed_work>

## Phase 1: Setup ✓
- Brownfield detection (existing code + codebase map detected)
- Git repo confirmed, branch `refactor/lean-claude-setup` created

## Phase 2: Deep Questioning ✓
- Extensive discussion covering: purpose (portable Claude config), GSD complement, deterministic-first philosophy, deployment targets (Mac, SSH, Docker, CI/CD), project agent registry, configurable deploy.sh, layered branch protection
- Key user preferences captured

## Phase 3: PROJECT.md ✓
- Written and committed at `.planning/PROJECT.md`
- Core value: "Minimal context footprint with maximum consistency"
- 13 active requirements, 7 out-of-scope items, 8 key decisions

## Phase 4: Config ✓
- `.planning/config.json` committed
- Mode: yolo, Depth: standard, Parallel: true, All workflow agents on, Balanced model profile

## Phase 5: Research ✓
- 4 parallel researchers completed (STACK, FEATURES, ARCHITECTURE, PITFALLS)
- SUMMARY.md synthesised and committed
- Key finding: settings.json deny rules bugged (#6699) — keep PreToolUse hook
- Key finding: ~2000 tokens wasted on always-loaded rules files
- Key finding: pre-commit has stale COMMIT_EDITMSG timing bug

## Phase 6: Requirements Definition (STARTED)
- User said "all in v1, multiple phases" — no v2 deferral
- Feature scoping questions started but not completed
</completed_work>

<remaining_work>

## Requirements Definition (resume here)
- Present full feature list by category for user confirmation
- Write REQUIREMENTS.md with REQ-IDs
- Commit REQUIREMENTS.md

## Roadmap Creation
- Spawn gsd-roadmapper with PROJECT.md + REQUIREMENTS.md + research context
- Present roadmap to user for approval
- Commit ROADMAP.md + STATE.md + update REQUIREMENTS.md traceability

## Completion
- Present final summary with next steps
</remaining_work>

<decisions_made>

1. **All features in v1** — user wants everything in one version, phased execution
2. **Remove all GSD agents/commands** — GSD framework manages its own
3. **Replace 7 rules files with condensed CLAUDE.md lines** — ~400 lines → ~30 lines
4. **Replace block-sensitive.py with settings.json deny rules** — BUT keep hook until deny bug fixed (#6699)
5. **Project registry instead of agent sync** — auto-collect from projects, read-only reference + reuse
6. **Configurable deploy.sh** — target dir, selective deployment, environment profiles, configurable git identity
7. **Keep /commit, /squash-merge, /pr-review** — useful portable skills, don't duplicate GSD
8. **Layered branch protection** — soft warning hook always present, hard block/GitHub protection configurable per project
9. **Deterministic-first philosophy** — if a tool/hook can enforce it, don't put it in CLAUDE.md
10. **GSD agent modifications are accidental** — can discard unstaged changes to agents/gsd-*.md
11. **No special research tooling** — vanilla Claude handles research use case
</decisions_made>

<blockers>
- Settings.json deny rules bug (#6699, #8961) — must keep PreToolUse hook as workaround until fixed
- Pre-commit hook has stale COMMIT_EDITMSG bug — reads previous commit's message, not current (fixed temporarily by deleting stale file, needs proper fix: move AI attribution check to commit-msg hook only)
</blockers>

<context>
This is a refactor of an over-engineered dotclaude repo (94 files) down to a lean, GSD-complementary setup. The user is a solo dev who does coding + research, deploying to Mac, SSH servers, Docker, and CI/CD.

Three research sources were consulted:
1. Full repo exploration (94 files mapped)
2. Web research on Claude Code best practices 2025-2026
3. Built-in claude-code-guide agent

The key insight driving everything: **context is the scarcest resource**. The current setup wastes ~2000 tokens on always-loaded rules that either Claude can infer or deterministic tools can enforce.

The modified GSD agent/command files in git status are accidental changes that should be discarded — they're not part of this work.
</context>

<next_action>
Resume `/gsd:new-project` from the requirements definition step:

1. Since user said "all in v1", skip per-category scoping — include everything discussed
2. Write REQUIREMENTS.md with all features as v1 requirements (REQ-IDs by category)
3. Categories: CORE (CLAUDE.md, settings), HOOKS (enforcement), DEPLOY (setup script), GIT (hooks, branch protection), REGISTRY (project agents), SKILLS (portable commands), TEMPLATES (project starter, GitHub Actions)
4. Present to user for confirmation
5. Then spawn roadmapper for ROADMAP.md
6. Complete the /gsd:new-project flow
</next_action>
