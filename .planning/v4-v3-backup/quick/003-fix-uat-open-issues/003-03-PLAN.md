---
phase: 003
plan: 03
type: execute
wave: 2
depends_on: ["003-01"]
files_modified:
  - lib/wizard.sh
  - plugins/claude/setup.sh
autonomous: true
---

<objective>
Fix edit mode (UAT Test 7) — selection logic, garbled display, meaningless labels, and add 'rerun as new' option.

Depends on 003-01 because that plan removes GSD from the edit mode display arrays, changing the item count and indices.

Covers:
- 7a: Number 13 rejected as invalid — selection logic broken (max_index calculation)
- 7b: Options repeating/garbled from item 7 onwards — already partially fixed in uncommitted lib/wizard.sh changes (wizard_edit_mode_display uses indexed eval instead of word-splitting). Verify the fix works.
- 7c: Labels meaningless ('target: true', 'path: true') — edit mode needs descriptive labels
- 7d: Full review of edit mode display — ensure it works end-to-end
- 7e: Should offer 'rerun as new' (fresh wizard, overwrite) vs 'edit existing'

Purpose: Make edit mode actually functional — it's completely broken currently.
Output: Updated lib/wizard.sh, plugins/claude/setup.sh
</objective>

<context>
@lib/wizard.sh
@plugins/claude/setup.sh
@lib/colours.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix edit mode selection logic and add 'rerun as new' option</name>
  <files>plugins/claude/setup.sh</files>
  <action>
IMPORTANT: This plan runs AFTER 003-01, which removes GSD from the edit mode arrays. After 003-01, the edit mode has 6 items (deploy target, settings, exclusion, sections, hooks, skills), not 7.

1. **Fix selection logic (7a):**
   The issue is that `wizard_parse_edit_selection` in lib/wizard.sh uses `max_index` (0-based). In `_claude_edit_mode()`, `max_index` is calculated as `${#labels[@]} - 1`.

   After 003-01 removes GSD, there will be 6 items, so max_index=5, valid inputs are 1-6.

   Check that `wizard_parse_edit_selection` correctly handles all numbers 1 through max_count. The current implementation converts user input (1-based) to 0-based indices and checks `$idx -le $max_index`. This should work for any count.

   The original bug (number 13 rejected) was because the old display had 7 items but the garbled display made it look like there were 13+ entries. With the display fix (7b), this resolves itself. Still — verify the max_index calculation is correct after GSD removal.

2. **Fix labels for clarity (7c):**
   After 003-01, the edit mode display array labels in `_claude_edit_mode()` should be:
   ```
   1) Deploy target path = ~/.claude
   2) Settings.json = true
   3) CLAUDE.md exclusion = true (CLAUDE.md)
   4) CLAUDE.md sections = communication simplicity documentation git code-style
   5) Hooks enabled = block-destructive.sh post-tool-format.py
   6) Skills enabled = commit pr-review simplicity-check squash-merge
   ```
   These labels are already set in the display arrays. Verify after 003-01's changes that:
   - Item 1 label is "Deploy target path" (not just "target")
   - Item 2 label is "Settings.json" (not "Settings.json enabled" — drop "enabled", it's confusing with 'true' value)
   - Items should show the human-readable value, not the raw env var

   Actually, looking at the current code, labels are explicitly set in `_claude_edit_mode()`. After GSD removal, check they read:
   - "Deploy target path"
   - "Settings.json"
   - "CLAUDE.md exclusion"
   - "CLAUDE.md sections"
   - "Hooks enabled"
   - "Skills enabled"

   For the "enabled" labels, change to just "Hooks" and "Skills" — "enabled" adds nothing when the value already shows the list.

3. **Add 'rerun as new' option (7e):**
   In `plugin_claude_setup()`, when edit_mode is detected (CLAUDE_DEPLOY_TARGET is set), offer a choice BEFORE entering edit mode:
   ```
   echo "Existing configuration detected."
   echo ""
   echo "  1) Edit current configuration"
   echo "  2) Start fresh (rerun wizard from scratch)"
   echo ""
   read -p "Choice [1-2, default: 1]: " mode_choice
   ```
   - Option 1: proceed to `_claude_edit_mode` as now
   - Option 2: unset all CLAUDE_* variables and fall through to first-run category menu
     ```bash
     unset CLAUDE_DEPLOY_TARGET CLAUDE_SETTINGS_ENABLED CLAUDE_MD_EXCLUDE_GLOBAL
     unset CLAUDE_MD_EXCLUDE_PATTERN CLAUDE_GSD_INSTALL
     CLAUDE_MD_SECTIONS_ENABLED=()
     CLAUDE_HOOKS_ENABLED=()
     CLAUDE_SKILLS_ENABLED=()
     edit_mode=false
     ```

   This replaces the current direct call to `_claude_edit_mode`.
  </action>
  <verify>Run `bash -n plugins/claude/setup.sh` for syntax check. Count labels array entries in _claude_edit_mode — should be exactly 6.</verify>
  <done>Edit mode offers 'rerun as new' option, labels are descriptive, selection logic works for all valid numbers.</done>
</task>

<task type="auto">
  <name>Task 2: Verify and finalise wizard_edit_mode_display fix</name>
  <files>lib/wizard.sh</files>
  <action>
The uncommitted changes to `wizard_edit_mode_display()` in lib/wizard.sh already fix the garbled display (7b) by using indexed eval access instead of word-splitting arrays.

1. **Verify the fix is correct:**
   The current uncommitted version uses:
   ```bash
   eval "local count=\${#${labels_var}[@]}"
   local i=0
   while [[ $i -lt $count ]]; do
       eval "local label=\"\${${labels_var}[$i]}\""
       eval "local value=\"\${${values_var}[$i]}\""
       eval "local is_managed=\"\${${managed_var}[$i]}\""
   ```
   This is correct for bash 3.2. The old version word-split with `$labels_str` which broke on multi-word labels like "Deploy target path".

2. **Confirm no `local -n` or `declare -n` usage:**
   Grep the entire file for namerefs. Must be zero matches.

3. **No changes needed if the fix is already correct.** Just preserve the uncommitted changes. If any issues found during review, fix them.

4. **Test the display format:**
   The managed items show `$display_num) $label = $value` and unmanaged show `$display_num) $label: [not managed]`. This is clear. The `=` for managed and `:` for unmanaged is a nice distinction. Keep it.
  </action>
  <verify>Run `bash -n lib/wizard.sh` for syntax check. Grep for `local -n\|declare -n` in lib/wizard.sh — should be 0 matches.</verify>
  <done>wizard_edit_mode_display uses indexed eval (bash 3.2 safe), no namerefs, display is clear.</done>
</task>

</tasks>

<verification>
- `bash -n plugins/claude/setup.sh` — no syntax errors
- `bash -n lib/wizard.sh` — no syntax errors
- `grep -c 'local -n\|declare -n' lib/wizard.sh` — 0
- Edit mode display arrays have exactly 6 entries (after GSD removal)
- 'rerun as new' option exists in plugin_claude_setup
</verification>

<success_criteria>
- Edit mode displays correctly with no garbled output
- All numbers 1-6 accepted as valid selections
- Labels are descriptive (not raw var names)
- User can choose 'rerun as new' to start fresh wizard
- No bash 3.2 incompatibilities
</success_criteria>
