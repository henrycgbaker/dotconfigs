---
phase: 003
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - plugins/claude/setup.sh
  - plugins/claude/deploy.sh
  - settings.json
autonomous: true
---

<objective>
Fix Claude wizard UX issues from UAT Test 5 and add missing hooks/skills to first-run menu (Test 7f).

Covers:
- 5a: Remove GSD install from wizard (npm handles this, not wizard config)
- 5b: Add inline content preview for sections and skills before toggle selection
- 5c: Simplify settings.json assembly — replace template merge with single-file approach
- 5d: Add 'both' option for CLAUDE.md exclusion in first-run flow (edit mode already has it in uncommitted changes)
- 7f: First-run wizard doesn't offer hooks or skills — they're buried in Behaviour category. Move hooks and skills out into their own category or add as visible items in the category menu.

Purpose: Make the Claude wizard usable and honest (don't offer things npm handles, show what you're selecting, simplify internals).
Output: Updated plugins/claude/setup.sh, plugins/claude/deploy.sh, settings.json
</objective>

<context>
@plugins/claude/setup.sh
@plugins/claude/deploy.sh
@plugins/claude/templates/settings/settings-template.json
@plugins/claude/templates/settings/base.json
@plugins/claude/templates/settings/hooks.json
@plugins/claude/templates/settings/python.json
@plugins/claude/templates/settings/node.json
@settings.json
@lib/wizard.sh
@lib/discovery.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove GSD install, add content previews, fix CLAUDE.md exclusion pattern</name>
  <files>plugins/claude/setup.sh</files>
  <action>
PRESERVE all uncommitted changes already in plugins/claude/setup.sh (GSD wording, 'both' option in edit mode).

1. **Remove GSD from wizard entirely (5a):**
   - Delete `_claude_configure_deploy_targets()` GSD section entirely (the echo about GSD, the wizard_yesno, and CLAUDE_GSD_INSTALL assignment — lines ~113-123 in current working copy)
   - Remove GSD from `_claude_edit_mode()` case 1 (lines ~473-482)
   - Remove GSD from `_claude_show_summary()` (lines ~303-309)
   - Remove GSD from `_claude_edit_mode()` display arrays (the "GSD install (npm)" entry — item 2)
   - After removing GSD, renumber the edit mode case indices: deploy target stays 0, settings.json becomes 1, CLAUDE.md exclusion becomes 2, CLAUDE.md sections becomes 3, hooks becomes 4, skills becomes 5
   - Remove GSD from `_claude_save_config()` (lines ~54-56)
   - The display array in `_claude_edit_mode()` should now have 6 items (not 7)

2. **Add inline content preview for sections and skills (5b):**
   - In `_claude_configure_content()`, before the `wizard_config_toggle` call for sections, add a preview helper. For each available section, read the first 2 lines of the template file to show what it contains. Use format:
     ```
     Available sections:
       communication — "Concise during execution, detailed when asked..."
       simplicity — "Solve only what was asked..."
       ...
     ```
   - Do this by iterating `available_sections` array, finding the matching template file in `$PLUGIN_DIR/templates/claude-md/`, reading line 2 (skip the `## Header` line), truncating to 60 chars, and printing.
   - Similarly for skills: read line 1 of each `$PLUGIN_DIR/commands/*.md`, truncate to 60 chars.
   - Keep the actual toggle menu unchanged — previews are informational only, shown before the toggle.

3. **Add 'both' option for CLAUDE.md exclusion in first-run flow (5d):**
   - In `_claude_configure_behaviour()`, the exclusion pattern selection (lines ~236-251) currently only offers options 1 and 2. Add option 3 matching what's already in the edit mode uncommitted changes:
     ```
     echo "  1) CLAUDE.md (root only)"
     echo "  2) **/CLAUDE.md (all directories)"
     echo "  3) Both (root + all directories)"
     ```
   - Case 3 should set `CLAUDE_MD_EXCLUDE_PATTERN="CLAUDE.md\n**/CLAUDE.md"`
   - Update the read prompt to say `[1-3, ...]`

4. **Restructure first-run category menu to surface hooks and skills (7f):**
   - Currently the categories are: "Deploy targets", "Content", "Behaviour", "Configure all", "Done"
   - The problem: hooks and skills are hidden inside "Content" and "Behaviour" respectively (actually hooks are in Behaviour, skills in Content — confusing).
   - New categories: "Deploy targets", "Content (sections, skills)", "Behaviour (settings, exclusion, hooks)", "Configure all", "Done"
   - OR simpler: just rename so it's clear what's inside each. The actual function calls stay the same.
   - Update the category name strings in the `categories` array at line ~619.
  </action>
  <verify>Run `bash -n plugins/claude/setup.sh` to check syntax. Grep for CLAUDE_GSD_INSTALL in setup.sh — should only appear in removal context (or not at all).</verify>
  <done>GSD install removed from wizard, content previews shown before toggle menus, CLAUDE.md exclusion offers 3 options in both first-run and edit mode, category menu names are descriptive.</done>
</task>

<task type="auto">
  <name>Task 2: Simplify settings.json assembly to single template</name>
  <files>plugins/claude/deploy.sh, settings.json</files>
  <action>
Issue 5c: The settings.json assembly in deploy.sh is overengineered — it merges base.json + python.json + node.json + hooks.json using jq or python3 fallback. The user wants a single template approach.

1. **Replace `_claude_assemble_settings()` in deploy.sh:**
   - Instead of merging multiple JSON files, just copy `settings-template.json` as the assembled output.
   - The function becomes trivial:
     ```bash
     _claude_assemble_settings() {
         local plugin_dir="$1"
         local output_file="$2"
         local template="$plugin_dir/templates/settings/settings-template.json"
         if [[ ! -f "$template" ]]; then
             echo "Error: settings-template.json not found" >&2
             return 1
         fi
         cp "$template" "$output_file"
     }
     ```
   - Remove the CLAUDE_SETTINGS_PYTHON and CLAUDE_SETTINGS_NODE env var checks — they were never exposed in the wizard anyway.
   - Update the dry-run output to just say "Would copy settings-template.json" instead of listing merge layers.

2. **Verify settings.json (uncommitted):**
   - The uncommitted settings.json already has a simplified structure. Keep it as-is — it matches what settings-template.json should produce.
   - Note: settings-template.json already exists and is the complete reference. The repo-root settings.json is what gets deployed (assembled into repo root, then symlinked to deploy target).

3. **Do NOT delete the individual template files (base.json, python.json, etc.)** — they serve as reference/documentation. Just stop merging them in the deploy pipeline.
  </action>
  <verify>Run `bash -n plugins/claude/deploy.sh` for syntax check. Grep for `_claude_assemble_settings` to confirm simplified version.</verify>
  <done>Settings assembly uses single template copy instead of multi-file merge. No jq/python3 dependency for settings build.</done>
</task>

</tasks>

<verification>
- `bash -n plugins/claude/setup.sh` — no syntax errors
- `bash -n plugins/claude/deploy.sh` — no syntax errors
- `grep -c 'GSD' plugins/claude/setup.sh` — should be 0 or minimal (only in migration code if kept)
- `grep 'CLAUDE_SETTINGS_PYTHON\|CLAUDE_SETTINGS_NODE' plugins/claude/deploy.sh` — should return nothing
</verification>

<success_criteria>
- GSD install completely removed from wizard flow and save logic
- Content previews appear before section and skill toggle menus
- CLAUDE.md exclusion offers 'both' pattern option in first-run and edit mode
- First-run category names describe what's inside
- Settings assembly simplified to single template copy
</success_criteria>
