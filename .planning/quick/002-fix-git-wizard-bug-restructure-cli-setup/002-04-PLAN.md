---
phase: quick-002
plan: 04
type: execute
wave: 3
depends_on: ["002-03"]
files_modified:
  - lib/wizard.sh
  - plugins/claude/setup.sh
  - plugins/git/setup.sh
autonomous: true

must_haves:
  truths:
    - "Wizards show opt-in config selection menu"
    - "Selected configs show opinionated defaults"
    - "Unselected configs don't appear in .env"
    - "Toggleable hooks shown as individual checkboxes"
    - "CLAUDE.md exclusion option appears in Claude wizard"
  artifacts:
    - path: "lib/wizard.sh"
      provides: "Opt-in config selection helpers"
      exports: ["wizard_select_configs", "wizard_checkbox_menu"]
    - path: "plugins/claude/setup.sh"
      provides: "Updated wizard with opt-in model"
      contains: "CLAUDE_MD_EXCLUDE_PATTERN"
    - path: "plugins/git/setup.sh"
      provides: "Individual hook toggles"
      contains: "GIT_HOOK_.*_ENABLED"
  key_links:
    - from: "plugins/claude/setup.sh"
      to: "lib/wizard.sh:wizard_select_configs"
      via: "config selection menu"
---

<objective>
Implement opt-in config selection model, toggleable hooks, and CLAUDE.md exclusion feature.

Purpose: User control over which configs to manage and per-hook enablement (todos #2, user decisions)
Output: Updated wizards with opt-in selection and new features
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/quick/002-fix-git-wizard-bug-restructure-cli-setup/002-03-SUMMARY.md
@lib/wizard.sh
@plugins/claude/setup.sh
@plugins/git/setup.sh
</context>

<tasks>

<task type="auto">
  <name>Add opt-in config selection helpers to wizard lib</name>
  <files>lib/wizard.sh</files>
  <action>
Add new wizard helper functions for opt-in config selection:

**1. wizard_checkbox_menu** — multi-select menu with spacebar toggle:
```bash
# Display checkbox menu for multi-select
# Args: title, options_array_name, selected_array_name
# Usage: wizard_checkbox_menu "Select configs:" available_configs selected_configs
wizard_checkbox_menu() {
    local title="$1"
    local options_var="$2"
    local selected_var="$3"

    echo "$title"
    echo "  (Use number to toggle, Enter when done)"
    echo ""

    eval "local opts=(\"\${${options_var}[@]}\")"
    eval "local sel=(\"\${${selected_var}[@]}\")"

    local i=1
    for opt in "${opts[@]}"; do
        local checked=" "
        if _is_in_list "$opt" "${sel[*]}"; then
            checked="x"
        fi
        echo "  [$checked] $i) $opt"
        i=$((i + 1))
    done
    echo ""

    read -p "Toggle item number (or Enter to finish): " choice

    if [[ -z "$choice" ]]; then
        return 0
    elif [[ "$choice" =~ ^[0-9]+$ ]] && [[ "$choice" -ge 1 ]] && [[ "$choice" -le "${#opts[@]}" ]]; then
        local idx=$((choice - 1))
        local item="${opts[$idx]}"

        # Toggle: remove if present, add if absent
        if _is_in_list "$item" "${sel[*]}"; then
            # Remove from selected
            local new_sel=()
            for s in "${sel[@]}"; do
                [[ "$s" != "$item" ]] && new_sel+=("$s")
            done
            eval "${selected_var}=(\"\${new_sel[@]}\")"
        else
            # Add to selected
            sel+=("$item")
            eval "${selected_var}=(\"\${sel[@]}\")"
        fi

        # Recurse to show updated menu
        wizard_checkbox_menu "$title" "$options_var" "$selected_var"
    else
        echo "Invalid choice, try again"
        wizard_checkbox_menu "$title" "$options_var" "$selected_var"
    fi
}
```

**2. wizard_opt_in_prompt** — ask which configs to manage:
```bash
# Prompt user to select which configs to manage
# Args: prompt_text, options_array_name
# Returns: selected items as space-separated string
wizard_opt_in_prompt() {
    local prompt="$1"
    local options_var="$2"

    echo "$prompt"
    echo ""

    eval "local opts=(\"\${${options_var}[@]}\")"
    local selected=()

    wizard_checkbox_menu "Select configurations to manage:" "$options_var" "selected"

    echo "${selected[*]}"
}
```

Note: These helpers enable multi-select opt-in UI. Bash 3.2 compatible (no assoc arrays).
  </action>
  <verify>
```bash
# Verify functions added
grep -q "wizard_checkbox_menu()" lib/wizard.sh && echo "PASS" || echo "FAIL"
grep -q "wizard_opt_in_prompt()" lib/wizard.sh && echo "PASS" || echo "FAIL"

# Verify bash 3.2 compat (no associative arrays)
! grep -q "declare -A" lib/wizard.sh && echo "PASS: no assoc arrays" || echo "FAIL"
```
  </verify>
  <done>Wizard helpers support opt-in config selection with checkbox UI</done>
</task>

<task type="auto">
  <name>Update Claude wizard with opt-in model and CLAUDE.md exclusion</name>
  <files>plugins/claude/setup.sh</files>
  <action>
Update Claude wizard to use opt-in config selection model:

**1. Add config selection menu at start (after header):**
```bash
# Step 0: Config Selection
echo "Which Claude configurations do you want to manage?"
echo ""

local available_configs=(
    "deploy_target"
    "settings_json"
    "claude_md"
    "hooks"
    "skills"
    "gsd_framework"
    "git_identity"
)

local manage_configs=()
wizard_checkbox_menu "Select configurations:" "available_configs" "manage_configs"

# Convert to associative check helper
_should_configure() {
    _is_in_list "$1" "${manage_configs[*]}"
}
```

**2. Wrap each existing step in conditional:**
```bash
# Step 1: Deploy Target
if _should_configure "deploy_target"; then
    wizard_header 1 "Deploy Target"
    # existing logic
fi

# Step 2: Settings.json
if _should_configure "settings_json"; then
    wizard_header 2 "Settings"
    # existing logic
fi

# ... etc for all steps
```

**3. Add CLAUDE.md exclusion step after settings.json:**
```bash
# Step 2b: CLAUDE.md Exclusion
if _should_configure "claude_md"; then
    echo ""
    echo "Exclude CLAUDE.md from git repositories?"
    echo "  - Prevents committing project instructions to repos"
    echo "  - Can be added globally or per-project"
    echo ""

    if wizard_yesno "Exclude CLAUDE.md globally?" "y"; then
        CLAUDE_MD_EXCLUDE_GLOBAL="true"

        local patterns=("CLAUDE.md (root only)" "**/*CLAUDE.md (all directories)")
        PS3="Select exclusion pattern: "
        select pattern_choice in "${patterns[@]}"; do
            case "$REPLY" in
                1) CLAUDE_MD_EXCLUDE_PATTERN="CLAUDE.md"; break ;;
                2) CLAUDE_MD_EXCLUDE_PATTERN="**/*CLAUDE.md"; break ;;
            esac
        done
    else
        CLAUDE_MD_EXCLUDE_GLOBAL="false"
    fi
fi
```

**4. Update _claude_save_config to save new vars:**
```bash
wizard_save_env "$env_file" "CLAUDE_MD_EXCLUDE_GLOBAL" "$CLAUDE_MD_EXCLUDE_GLOBAL"
wizard_save_env "$env_file" "CLAUDE_MD_EXCLUDE_PATTERN" "$CLAUDE_MD_EXCLUDE_PATTERN"
```

**5. Update summary to show selected configs only:**
```bash
echo "Configurations managed:"
for cfg in "${manage_configs[@]}"; do
    echo "  - $cfg"
done
echo ""
echo "Configuration values:"
# Only show values for managed configs
```

This implements opt-in: users pick which configs to set, unpicked configs = unset (no .env entry).
  </action>
  <verify>
```bash
# Verify opt-in structure added
grep -q "wizard_checkbox_menu.*available_configs" plugins/claude/setup.sh && echo "PASS" || echo "FAIL"
grep -q "_should_configure" plugins/claude/setup.sh && echo "PASS" || echo "FAIL"

# Verify CLAUDE.md exclusion added
grep -q "CLAUDE_MD_EXCLUDE_GLOBAL" plugins/claude/setup.sh && echo "PASS" || echo "FAIL"
grep -q "CLAUDE_MD_EXCLUDE_PATTERN" plugins/claude/setup.sh && echo "PASS" || echo "FAIL"
```
  </verify>
  <done>Claude wizard uses opt-in model with CLAUDE.md exclusion option</done>
</task>

<task type="auto">
  <name>Update git wizard with toggleable hooks and opt-in model</name>
  <files>plugins/git/setup.sh</files>
  <action>
Update git wizard with opt-in config selection and per-hook toggles:

**1. Add config selection at start (same pattern as Claude):**
```bash
local available_configs=(
    "git_identity"
    "git_hooks"
    "git_aliases"
)

local manage_configs=()
wizard_checkbox_menu "Select git configurations:" "available_configs" "manage_configs"
```

**2. Replace hook roster section (lines 224+) with per-hook toggles:**

Current: Long list of y/n prompts for each hook
New: Show hooks with ENABLED/DISABLED state, let user toggle

```bash
if _should_configure "git_hooks"; then
    echo ""
    echo "Git Hooks Configuration"
    echo "Toggle individual hooks on/off"
    echo ""

    # Discover hooks from metadata
    local available_hooks=()
    while IFS= read -r hook; do
        available_hooks+=("$hook")
    done < <(discover_hooks "$PLUGIN_DIR")

    # Pre-fill from existing config
    local enabled_hooks=()
    for hook in "${available_hooks[@]}"; do
        local var_name="GIT_HOOK_${hook^^}_ENABLED"
        local prev_val="${!var_name:-true}"  # default enabled
        [[ "$prev_val" == "true" ]] && enabled_hooks+=("$hook")
    done

    # Show checkbox menu
    wizard_checkbox_menu "Select hooks to enable:" "available_hooks" "enabled_hooks"

    # Save individual {HOOK}_ENABLED variables
    for hook in "${available_hooks[@]}"; do
        local var_name="GIT_HOOK_${hook^^}_ENABLED"
        if _is_in_list "$hook" "${enabled_hooks[*]}"; then
            eval "$var_name=true"
        else
            eval "$var_name=false"
        fi
    done
fi
```

**3. Update _git_save_config to save per-hook ENABLED vars:**
```bash
# Save hook toggles
for hook in "${available_hooks[@]}"; do
    local var_name="GIT_HOOK_${hook^^}_ENABLED"
    wizard_save_env "$env_file" "$var_name" "${!var_name}"
done
```

**4. Update summary to show enabled/disabled hook counts:**
```bash
echo "Hooks enabled: ${#enabled_hooks[@]}/${#available_hooks[@]}"
```

This implements toggleable hooks (todo #2): each hook can be enabled/disabled individually.
  </action>
  <verify>
```bash
# Verify opt-in structure
grep -q "wizard_checkbox_menu.*available_configs" plugins/git/setup.sh && echo "PASS" || echo "FAIL"

# Verify per-hook toggles
grep -q "GIT_HOOK_.*_ENABLED" plugins/git/setup.sh && echo "PASS" || echo "FAIL"
grep -q "wizard_checkbox_menu.*available_hooks" plugins/git/setup.sh && echo "PASS" || echo "FAIL"
```
  </verify>
  <done>Git wizard uses opt-in model with per-hook toggle controls</done>
</task>

</tasks>

<verification>
1. Wizards show config selection menu at start
2. Only selected configs prompt for values
3. CLAUDE.MD exclusion option appears in Claude wizard
4. Git wizard shows individual hook toggles
5. Unselected configs don't create .env entries
</verification>

<success_criteria>
- Opt-in config selection working in both wizards
- CLAUDE.md exclusion feature added to Claude wizard
- Individual hook toggles replace bulk enable/disable
- .env only contains entries for selected configs
</success_criteria>

<output>
After completion, create `.planning/quick/002-fix-git-wizard-bug-restructure-cli-setup/002-04-SUMMARY.md`
</output>
