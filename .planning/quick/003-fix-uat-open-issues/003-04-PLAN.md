---
phase: 003
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - dotconfigs
autonomous: true
---

<objective>
Fix the setup command (UAT Test 11 remainder): cmd_setup() should be a proper one-time initialisation that sets deploy target, creates PATH symlinks (both dotconfigs and dots), and shows correct next-steps messaging.

Covers:
- Test 11 remaining: cmd_setup() only asks deploy target — missing comprehensive next-steps
- Test 11 reported: "legacy 'setup' command still exists as broken minimal wizard"

The blockers from Test 11 (((var++)) crash, stale 'dots' refs) are already fixed in committed code. This addresses the remaining cmd_setup() quality issues.

Purpose: Make `dotconfigs setup` a proper one-time tool initialisation command.
Output: Updated dotconfigs entry point
</objective>

<context>
@dotconfigs
@lib/wizard.sh
@lib/discovery.sh
@lib/colours.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Polish cmd_setup() one-time initialisation</name>
  <files>dotconfigs</files>
  <action>
The current `cmd_setup()` (lines 230-274) is mostly functional but has rough edges from UAT.

1. **Review and refine cmd_setup():**
   The current implementation already:
   - Asks for deploy target
   - Saves DOTCONFIGS_DEPLOY_TARGET to .env
   - Calls `_create_path_symlink`
   - Creates dots symlink alongside dotconfigs
   - Shows next-steps with plugin list

   Verify this is working correctly. The main issues were:
   - The output messaging should use consistent formatting (match the wizard header style)
   - Add `init_colours` call at the start so colour output works if status is called after

2. **Add colour initialisation:**
   Add `init_colours` at the top of `cmd_setup()` so any colour helpers work.

3. **Add setup completion marker:**
   After saving, also write `DOTCONFIGS_VERSION="2.0"` to .env so other commands can detect that setup has been run.
   ```bash
   wizard_save_env "$ENV_FILE" "DOTCONFIGS_VERSION" "2.0"
   ```

4. **Add wizard-style header:**
   ```bash
   echo ""
   echo "========================================================="
   echo "  dotconfigs - First Time Setup"
   echo "========================================================="
   echo ""
   ```
   Replace the current bare `echo "dotconfigs - Tool Setup"`.

5. **Verify _create_path_symlink usage:**
   The function is called with `"false" "false"` which is correct (not dry-run, not force). The dots symlink creation below it looks correct.

6. **Remove cmd_setup_legacy():**
   The function `cmd_setup_legacy()` (lines 204-228) redirects `dotconfigs setup <plugin>` to `global-configs`. This was flagged as broken. Since `dotconfigs setup <plugin>` is deprecated, simplify: if setup is called with args, just print the deprecation warning and suggest `global-configs`. Remove the actual plugin loading/execution from the legacy path — let the user re-run with the correct command.
   ```bash
   cmd_setup_legacy() {
       echo "Warning: 'dotconfigs setup <plugin>' is deprecated." >&2
       echo "Use: 'dotconfigs global-configs $1' instead." >&2
       return 1
   }
   ```
  </action>
  <verify>Run `bash -n dotconfigs` for syntax check. Grep for `cmd_setup_legacy` to confirm simplified. Grep for `init_colours` in cmd_setup to confirm present.</verify>
  <done>cmd_setup() is a clean one-time init with proper header, colour support, version marker, and clear next-steps. Legacy setup path just warns.</done>
</task>

</tasks>

<verification>
- `bash -n dotconfigs` — no syntax errors
- `grep -c 'DOTCONFIGS_VERSION' dotconfigs` — at least 1 (in cmd_setup)
- `grep -c 'init_colours' dotconfigs` — appears in cmd_setup
- cmd_setup_legacy is simplified to deprecation warning only
</verification>

<success_criteria>
- `dotconfigs setup` shows proper wizard-style header
- Saves deploy target and version to .env
- Creates PATH symlinks for both dotconfigs and dots
- Shows clear next-steps listing available plugins
- `dotconfigs setup <plugin>` shows deprecation warning without executing
</success_criteria>
