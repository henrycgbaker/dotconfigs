---
phase: 004-fix-uat-deploy-provenance-project-wizard
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - dotconfigs
  - plugins/claude/project.sh
  - plugins/claude/templates/settings/hooks.json
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "project-configs wizard pauses at each wizard_yesno prompt and waits for user input"
    - "Created CLAUDE.md includes user's configured sections from CLAUDE_MD_SECTIONS (not hardcoded boilerplate)"
    - "hooks.json template uses .claude/hooks/ paths (relative to project, not dotconfigs repo)"
  artifacts:
    - path: "dotconfigs"
      provides: "Fixed cmd_project_configs all-plugins loop that preserves stdin"
      contains: "plugin_.*_project"
    - path: "plugins/claude/project.sh"
      provides: "Project wizard with working prompts and section-based CLAUDE.md"
      contains: "_claude_build_md"
    - path: "plugins/claude/templates/settings/hooks.json"
      provides: "Correct hook paths for project deployment"
      contains: ".claude/hooks/"
  key_links:
    - from: "dotconfigs"
      to: "plugins/claude/project.sh"
      via: "source + plugin_claude_project call"
      pattern: "plugin_${plugin_filter}_project"
    - from: "plugins/claude/project.sh"
      to: "plugins/claude/deploy.sh"
      via: "_claude_build_md function (defined in deploy.sh)"
      pattern: "_claude_build_md"
---

<objective>
Fix the three broken aspects of the project-configs wizard: stdin consumption, hardcoded CLAUDE.md, and wrong hook paths.

Purpose: UAT test 13 found that `dotconfigs project-configs .` runs straight through without interactive prompts, creates useless boilerplate CLAUDE.md, and deploys hooks.json with paths pointing to the dotconfigs source repo instead of the target project's .claude/hooks/ directory.

Output: Working project-configs wizard with interactive prompts, section-based CLAUDE.md assembly, and correct hook paths.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@dotconfigs
@plugins/claude/project.sh
@plugins/claude/deploy.sh
@plugins/claude/templates/settings/hooks.json
@lib/wizard.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix stdin consumption in cmd_project_configs all-plugins loop</name>
  <files>dotconfigs</files>
  <action>
The root cause of wizard_yesno prompts "falling through" is in the `dotconfigs` entry point, function `cmd_project_configs()`, lines 607-614.

The "all plugins" mode uses:
```bash
while IFS= read -r plugin; do
    ...
    "plugin_${plugin}_project" "$project_path"
    ...
done < <(discover_plugins "$PLUGINS_DIR")
```

The `< <(discover_plugins)` redirects stdin for the entire while loop body. Any `read` calls inside `plugin_claude_project` (which calls `wizard_yesno` which calls `read -p`) read from the process substitution output instead of the terminal. After the plugin list is exhausted, reads get empty input, causing the "Invalid input" errors and fall-through behaviour.

Fix: Collect plugin list into an array FIRST, then iterate with a standard for loop that does NOT redirect stdin.

Replace lines 607-614 with:
```bash
# Collect plugins into array first to avoid stdin redirection
local project_plugins=()
while IFS= read -r plugin; do
    if [[ -f "$PLUGINS_DIR/$plugin/project.sh" ]]; then
        project_plugins+=("$plugin")
    fi
done < <(discover_plugins "$PLUGINS_DIR")

if [[ ${#project_plugins[@]} -eq 0 ]]; then
    echo "No plugins with project setup found" >&2
    exit 1
fi

for plugin in "${project_plugins[@]}"; do
    source "$PLUGINS_DIR/$plugin/project.sh"
    "plugin_${plugin}_project" "$project_path"
done
```

This separates the stdin-consuming read loop (discover_plugins) from the interactive plugin execution (for loop with no stdin redirection).

Remove the `ran_any` variable and its check since we now pre-check the array length.
  </action>
  <verify>
Run `dotconfigs project-configs .` from a test git repo. Verify that wizard_yesno prompts pause and wait for user input at each step. The "Invalid input" message should NOT appear unless the user actually types invalid input.
  </verify>
  <done>All wizard_yesno prompts in project-configs wizard wait for user input correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Replace hardcoded CLAUDE.md with section-based assembly + fix hook paths</name>
  <files>plugins/claude/project.sh, plugins/claude/templates/settings/hooks.json</files>
  <action>
**Sub-issue A: CLAUDE.md builder (lines 388-407 of project.sh)**

The current code creates a hardcoded boilerplate CLAUDE.md:
```bash
cat > "$claude_md_target" <<EOF
# $(basename "$project_path")
Project type: $project_type
## Configuration
This project uses dotconfigs for Claude Code configuration.
...
EOF
```

Replace this with a call to `_claude_build_md()` (defined in deploy.sh) which assembles CLAUDE.md from the user's configured sections in CLAUDE_MD_SECTIONS.

BUT: `_claude_build_md` writes to `$plugin_dir/CLAUDE.md` (the assembled copy in the plugin dir) and is designed for the global deploy flow. For project scaffolding, we need to either:
1. Call `_claude_build_md` to build the assembled copy, then copy it to the project, OR
2. Build directly to the project path

Option 1 is cleaner because `_claude_build_md` already exists and is tested. The project wizard should:
1. Source deploy.sh if not already sourced (to get `_claude_build_md`)
2. Check if CLAUDE_MD_SECTIONS_ARRAY has content. If so, build from sections. If empty, create a minimal stub.

Replace the CLAUDE.md creation block (lines 388-407) with:

```bash
if wizard_yesno "  Create project CLAUDE.md from global sections?" "y"; then
    # Source deploy.sh to get _claude_build_md if not already loaded
    if ! declare -f _claude_build_md > /dev/null 2>&1; then
        source "$PLUGIN_DIR/deploy.sh"
    fi

    # Load config to get CLAUDE_MD_SECTIONS_ARRAY
    if [[ -n "${CLAUDE_MD_SECTIONS:-}" ]]; then
        IFS=' ' read -ra _sections <<< "$CLAUDE_MD_SECTIONS"
    else
        _sections=()
    fi

    if [[ ${#_sections[@]} -gt 0 ]]; then
        # Build assembled CLAUDE.md in plugin dir, then copy to project
        _claude_build_md "$PLUGIN_DIR" "${_sections[@]}"
        cp "$PLUGIN_DIR/CLAUDE.md" "$claude_md_target"
        printf "  ✓ Built CLAUDE.md from global sections "
        colour_badge_local
        echo " (${#_sections[@]} sections)"
    else
        # No sections configured — create minimal stub
        cat > "$claude_md_target" <<MDEOF
# $(basename "$project_path")

Project type: $project_type
MDEOF
        printf "  ✓ Created minimal CLAUDE.md "
        colour_badge_local
        echo " (no global sections configured)"
    fi
else
    echo "  Skipped CLAUDE.md"
fi
```

Also update the "existing CLAUDE.md" branch (lines 362-386) — the append action at line 370-378 is fine as-is (it appends a reference section, not the full config).

**Sub-issue B: hooks.json template paths**

Edit `plugins/claude/templates/settings/hooks.json`:

Replace all instances of `$CLAUDE_PROJECT_DIR/plugins/claude/hooks/` with `.claude/hooks/`.

The hooks are COPIED (not symlinked) to `.claude/hooks/` in the target project by the project wizard (see line 286: `cp "$hook_source" "$hook_target"`). So the settings.json hooks section must reference `.claude/hooks/` which is relative to the project root where Claude Code runs.

The file should become:
```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matchers": [
          { "tool_name": "Bash" }
        ],
        "command": ".claude/hooks/block-destructive.sh",
        "timeout": 10000
      },
      {
        "matchers": [
          { "tool_name": "Write" },
          { "tool_name": "Edit" }
        ],
        "command": ".claude/hooks/block-destructive.sh",
        "timeout": 10000
      }
    ],
    "PostToolUse": [
      {
        "matchers": [
          { "tool_name": "Write" },
          { "tool_name": "Edit" }
        ],
        "command": ".claude/hooks/post-tool-format.py",
        "timeout": 30000
      }
    ]
  }
}
```
  </action>
  <verify>
1. Run `dotconfigs project-configs claude .` from a test git repo with CLAUDE_MD_SECTIONS set in .env
2. Verify the created CLAUDE.md contains the actual section content (not boilerplate)
3. Check `.claude/settings.json` in the project — hooks paths should reference `.claude/hooks/` not `$CLAUDE_PROJECT_DIR/...`
4. Verify `grep -r 'CLAUDE_PROJECT_DIR' plugins/claude/templates/settings/hooks.json` returns nothing
  </verify>
  <done>
- Project CLAUDE.md is assembled from user's global sections via _claude_build_md()
- hooks.json template uses .claude/hooks/ paths (correct for project deployment)
- All three sub-issues from UAT test 13 are resolved
  </done>
</task>

</tasks>

<verification>
1. `dotconfigs project-configs .` from a test git repo: all wizard_yesno prompts wait for input
2. Created CLAUDE.md contains section content from templates, not hardcoded boilerplate
3. `.claude/settings.json` hooks reference `.claude/hooks/block-destructive.sh` (not $CLAUDE_PROJECT_DIR path)
4. No "Invalid input" errors unless user actually types invalid input
5. Both single-plugin (`dotconfigs project-configs claude .`) and all-plugin (`dotconfigs project-configs .`) modes work interactively
</verification>

<success_criteria>
- wizard_yesno prompts are interactive (stdin not consumed by loop)
- CLAUDE.md built from CLAUDE_MD_SECTIONS via _claude_build_md()
- hooks.json uses .claude/hooks/ paths
- UAT test 13 gap (broken project-configs wizard) is closed
</success_criteria>

<output>
After completion, create `.planning/quick/004-fix-uat-deploy-provenance-project-wizard/004-02-SUMMARY.md`
</output>
