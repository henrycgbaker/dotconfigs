---
phase: 004-fix-uat-deploy-provenance-project-wizard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/symlinks.sh
  - plugins/claude/deploy.sh
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Deploy output shows source file path for every created/updated/unchanged file"
    - "backup_and_link() prints src -> dest mapping, not just display name"
    - "Dry-run output also shows source paths"
  artifacts:
    - path: "lib/symlinks.sh"
      provides: "backup_and_link with src -> dest output"
      contains: "Linked.*→"
    - path: "plugins/claude/deploy.sh"
      provides: "Deploy messages with source provenance"
      contains: "→"
  key_links:
    - from: "plugins/claude/deploy.sh"
      to: "lib/symlinks.sh"
      via: "backup_and_link function calls"
      pattern: "backup_and_link"
---

<objective>
Add source file path provenance to all deploy output messages.

Purpose: UAT test 12 found that deploy output only shows target paths (e.g. "Unchanged: settings.json") but not the SSOT source path. Users need to see where files originate (e.g. "plugins/claude/templates/settings.json -> ~/.claude/settings.json").

Output: Updated lib/symlinks.sh and plugins/claude/deploy.sh with source provenance in all status messages.
</objective>

<execution_context>
@/Users/henrybaker/.claude/get-shit-done/workflows/execute-plan.md
@/Users/henrybaker/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@lib/symlinks.sh
@plugins/claude/deploy.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update backup_and_link() to show source -> dest mapping</name>
  <files>lib/symlinks.sh</files>
  <action>
Update backup_and_link() in lib/symlinks.sh to include source provenance in its output messages.

The function receives `$src` (absolute path), `$dest` (absolute path), `$name` (display name), `$interactive_mode`.

For user-friendly output, compute a relative source path from DOTCONFIGS_ROOT (which is already computed inside the function on lines 102-106). Use parameter substitution: `${src#$dotconfigs_root/}` to get the relative path.

Replace all echo messages that currently print only `$name` with `$rel_src -> $name` format:

- Line 111: `echo "  ✓ Linked $name"` -> `echo "  ✓ Linked $rel_src -> $dest"`
- Line 118: `echo "  ✓ Updated $name"` -> `echo "  ✓ Updated $rel_src -> $dest"`
- Line 126: `echo "  ✓ Overwrote $name (forced)"` -> `echo "  ✓ Overwrote $rel_src -> $dest (forced)"`
- Line 152: `echo "  ✓ Overwrote $name"` -> `echo "  ✓ Overwrote $rel_src -> $dest"`
- Line 159: `echo "  ✓ Backed up to $backup and linked $name"` -> `echo "  ✓ Backed up to $backup and linked $rel_src -> $dest"`
- Line 163: `echo "  - Skipped $name"` -> `echo "  - Skipped $name (exists, not managed by dotconfigs)"`  (this line already has the long form at 170)
- Line 170: keep as-is (already descriptive)

Add `local rel_src="${src#$dotconfigs_root/}"` after line 106 (after dotconfigs_root is resolved).

Also update conflict prompt messages (line 131-133) to show the source path for context.
  </action>
  <verify>
grep -n "rel_src" lib/symlinks.sh should show the variable defined and used in multiple echo statements.
grep "→\|Linked\|Updated\|Overwrote" lib/symlinks.sh should show source provenance in output messages.
  </verify>
  <done>backup_and_link() prints relative source path and destination in all output messages</done>
</task>

<task type="auto">
  <name>Task 2: Add source provenance to claude deploy.sh echo statements</name>
  <files>plugins/claude/deploy.sh</files>
  <action>
Update all deploy echo statements in plugins/claude/deploy.sh that print file status to include the source path.

The deploy function already has `$source` (or `$settings_source`, `$claude_md_source`) variables with absolute paths to source files, and `$PLUGIN_DIR` for the plugin root. Compute relative paths from `$DOTCONFIGS_ROOT` for display.

For each section, update the echo statements that show "Unchanged:", "Would link:", "Would overwrite:", "Would prompt:" messages:

**Settings.json section (around lines 354-392):**
- Compute `local rel_settings="${settings_source#$DOTCONFIGS_ROOT/}"`
- Replace `"  Unchanged: settings.json ..."` with `"  Unchanged: $rel_settings -> $CLAUDE_DEPLOY_TARGET/settings.json"`
- Replace `"  Would link: settings.json ..."` with `"  Would link: $rel_settings -> $CLAUDE_DEPLOY_TARGET/settings.json"`
- Same for Would overwrite and Would prompt lines

**CLAUDE.md section (around lines 423-465):**
- Compute `local rel_claude_md="${claude_md_source#$DOTCONFIGS_ROOT/}"`
- Update all Unchanged/Would link/Would overwrite/Would prompt echo lines similarly

**Hooks section (around lines 480-519):**
- Compute `local rel_hook="${source#$DOTCONFIGS_ROOT/}"` inside the loop (note: local var `source` already exists)
- Update Unchanged/Would link etc. lines to show `$rel_hook -> $target`

**Skills section (around lines 534-573):**
- Compute `local rel_skill="${source#$DOTCONFIGS_ROOT/}"` inside the loop
- Update all echo lines similarly

The pattern for each status line should be:
- Created/Linked: `"  ✓ Linked $rel_source -> $target_path"`
- Unchanged: `"  Unchanged: $rel_source -> $target_path"`
- Would link: `"  Would link: $rel_source -> $target_path"`
- Would overwrite: `"  Would overwrite: $rel_source -> $target_path (--force)"`
- Would prompt: `"  Would prompt: conflict at $target_path (source: $rel_source)"`

Note: The "Unchanged" lines in dry-run sections use the same format. Make sure both dry-run and real-run echo statements are updated consistently.
  </action>
  <verify>
Run `./dotconfigs deploy --dry-run` and verify output shows source paths like:
  "Unchanged: plugins/claude/settings.json -> ~/.claude/settings.json"
  "Unchanged: plugins/claude/CLAUDE.md -> ~/.claude/CLAUDE.md"
  "Unchanged: plugins/claude/hooks/block-destructive.sh -> ~/.claude/hooks/block-destructive.sh"
  </verify>
  <done>All deploy echo statements include source file provenance. Both dry-run and real deploy output show "source -> target" format for every file.</done>
</task>

</tasks>

<verification>
1. `./dotconfigs deploy --dry-run` output shows source paths for every listed file
2. No regression: deploy still counts created/updated/skipped/unchanged correctly
3. Source paths are relative to dotconfigs root (not absolute) for readability
</verification>

<success_criteria>
- Every deploy status message includes source file path
- backup_and_link() shows src -> dest in all output
- Dry-run and real deploy output are consistent
- UAT test 12 gap (deploy source provenance) is closed
</success_criteria>

<output>
After completion, create `.planning/quick/004-fix-uat-deploy-provenance-project-wizard/004-01-SUMMARY.md`
</output>
