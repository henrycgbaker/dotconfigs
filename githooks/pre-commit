#!/bin/bash
# ============================================================================
# PRE-COMMIT HOOK
# ============================================================================
# Location: .git/hooks/pre-commit (NOT tracked by git)
# Source:   githooks/pre-commit (tracked template)
#
# Install: cp githooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
# Or run:  ./setup.sh (does this automatically)
# ============================================================================

REPO_ROOT="$(git rev-parse --show-toplevel)"

# --- Identity Check ---
EXPECTED_NAME="henrycgbaker"
EXPECTED_EMAIL="henry.c.g.baker@gmail.com"

ACTUAL_NAME=$(git config user.name)
ACTUAL_EMAIL=$(git config user.email)

if [ "$ACTUAL_NAME" != "$EXPECTED_NAME" ]; then
    echo "âŒ ERROR: Git user.name is '$ACTUAL_NAME', expected '$EXPECTED_NAME'"
    echo "Fix with: git config user.name '$EXPECTED_NAME'"
    exit 1
fi

if [ "$ACTUAL_EMAIL" != "$EXPECTED_EMAIL" ]; then
    echo "âŒ ERROR: Git user.email is '$ACTUAL_EMAIL', expected '$EXPECTED_EMAIL'"
    echo "Fix with: git config user.email '$EXPECTED_EMAIL'"
    exit 1
fi

# --- Python Linting & Formatting ---
STAGED_PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -n "$STAGED_PYTHON_FILES" ]; then
    echo "ðŸ” Checking Python files with Ruff..."

    if command -v ruff &> /dev/null; then
        # Format staged Python files
        ruff format $STAGED_PYTHON_FILES
        RUFF_FMT_EXIT=$?

        # Check/fix staged Python files
        ruff check --fix $STAGED_PYTHON_FILES
        RUFF_CHK_EXIT=$?

        # Re-stage any fixes
        git add $STAGED_PYTHON_FILES 2>/dev/null || true

        if [ $RUFF_FMT_EXIT -ne 0 ] || [ $RUFF_CHK_EXIT -ne 0 ]; then
            echo "âš ï¸  Ruff made fixes. Review changes and commit again."
            exit 1
        fi
        echo "âœ… Python files passed Ruff checks"
    else
        echo "âš ï¸  Ruff not installed. Skipping Python linting."
    fi
fi

# --- Agent Sync (dotclaude only) ---
if [ -x "$REPO_ROOT/sync-project-agents.sh" ]; then
    echo "ðŸ”„ Syncing project agents..."
    "$REPO_ROOT/sync-project-agents.sh" pull 2>/dev/null
    git add "$REPO_ROOT/project-agents/" 2>/dev/null || true
    echo "âœ… Agent sync complete"
fi

exit 0
