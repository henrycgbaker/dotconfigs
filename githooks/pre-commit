#!/bin/bash
# ============================================================================
# PRE-COMMIT HOOK
# ============================================================================
# Branch protection and auto-formatting
# Deployed globally via core.hooksPath. Config-driven via .claude/hooks.conf.
#
# Source of truth: dotclaude/githooks/pre-commit
# Deployed to: ~/.claude/git-hooks/pre-commit
# ============================================================================

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || echo ".")"
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")

# --- Load project config ---
HOOK_CONFIG="$REPO_ROOT/.claude/hooks.conf"

# Defaults
BRANCH_PROTECTION=warn  # warn | block | off
RUFF_ENABLED=true

if [ -f "$HOOK_CONFIG" ]; then
    source "$HOOK_CONFIG"
fi

# ============================================================================
# SECTION 1: Branch Protection (config-driven)
# ============================================================================

# Skip branch protection during squash merge
if [ -f "$REPO_ROOT/.git/SQUASH_MSG" ]; then
    # User is doing a squash merge, allow it
    :
elif [ "$BRANCH_PROTECTION" = "block" ] && [ "$CURRENT_BRANCH" = "main" ]; then
    # Hard block direct commits to main
    echo "‚ùå ERROR: Direct commits to 'main' are not allowed"
    echo ""
    echo "Workflow: Create a branch, commit freely, then squash merge when complete"
    echo ""
    echo "To fix:"
    echo "  1. Create a branch:          git checkout -b <branch-name>"
    echo "     (e.g., feature/*, fix/*, docs/*, refactor/*, or plain descriptive name)"
    echo "  2. Commit your changes:      git commit"
    echo "  3. When done, squash merge:  Use /squash-merge command"
    echo ""
    exit 1
elif [ "$BRANCH_PROTECTION" = "warn" ] && [ "$CURRENT_BRANCH" = "main" ]; then
    # Warn but allow commit
    echo "‚ö†Ô∏è  WARNING: Committing directly to 'main' branch"
    echo ""
    echo "Recommended workflow: Create a branch, commit freely, then squash merge"
    echo "To enable hard block: Set BRANCH_PROTECTION=block in .claude/hooks.conf"
    echo ""
fi
# BRANCH_PROTECTION=off: No protection

# ============================================================================
# SECTION 2: Ruff Formatting (config-driven)
# ============================================================================

if [ "$RUFF_ENABLED" = true ]; then
    STAGED_PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

    if [ -n "$STAGED_PYTHON_FILES" ]; then
        echo "üîç Checking Python files with Ruff..."

        if command -v ruff &> /dev/null; then
            # Format staged Python files
            ruff format $STAGED_PYTHON_FILES
            RUFF_FMT_EXIT=$?

            # Check/fix staged Python files
            ruff check --fix $STAGED_PYTHON_FILES
            RUFF_CHK_EXIT=$?

            # Re-stage any fixes
            git add $STAGED_PYTHON_FILES 2>/dev/null || true

            if [ $RUFF_FMT_EXIT -ne 0 ] || [ $RUFF_CHK_EXIT -ne 0 ]; then
                echo "‚ö†Ô∏è  Ruff made fixes. Review changes and commit again."
                exit 1
            fi
            echo "‚úÖ Python files passed Ruff checks"
        else
            echo "‚ö†Ô∏è  Ruff not installed. Skipping Python linting."
        fi
    fi
fi

exit 0
