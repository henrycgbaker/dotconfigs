#!/bin/bash
# Git hook: Pre-commit checks for dotclaude
# 1. Sync project agents from all projects
# 2. Enforce git identity
#
# Install: cp githooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(git rev-parse --show-toplevel)"

# --- Agent Sync ---
# Pull latest agents from projects before committing
if [ -x "$REPO_ROOT/sync-project-agents.sh" ]; then
    echo "üîÑ Syncing project agents..."

    # Only sync if we can reach the sources (skip remote if offline)
    "$REPO_ROOT/sync-project-agents.sh" pull 2>/dev/null

    # Stage any changes to project-agents/
    git add "$REPO_ROOT/project-agents/" 2>/dev/null || true

    echo "‚úÖ Agent sync complete"
fi

# --- Identity Check ---
EXPECTED_NAME="henrycgbaker"
EXPECTED_EMAIL="henry.c.g.baker@gmail.com"

ACTUAL_NAME=$(git config user.name)
ACTUAL_EMAIL=$(git config user.email)

if [ "$ACTUAL_NAME" != "$EXPECTED_NAME" ]; then
    echo "‚ùå ERROR: Git user.name is '$ACTUAL_NAME', expected '$EXPECTED_NAME'"
    echo "Fix with: git config user.name '$EXPECTED_NAME'"
    exit 1
fi

if [ "$ACTUAL_EMAIL" != "$EXPECTED_EMAIL" ]; then
    echo "‚ùå ERROR: Git user.email is '$ACTUAL_EMAIL', expected '$EXPECTED_EMAIL'"
    echo "Fix with: git config user.email '$EXPECTED_EMAIL'"
    exit 1
fi

exit 0
